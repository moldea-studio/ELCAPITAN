<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>El Capitán - Fútbol Amateur</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#00ff55">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="El Capitán">
    <link rel="apple-touch-icon" id="apple-icon">
    <link rel="icon" type="image/png" id="favicon">
    <link rel="manifest" id="manifest-placeholder">

    <!-- CONFIGURACIÓN DE ÍCONOS REALES -->
    <script>
        (function() {
            // ⚠️ IMPORTANTE: Pega aquí el link de tu imagen JPG nueva
            // Agregamos '?v=3' al final para obligar al celular a actualizar la imagen sí o sí
            const iconUrl = "https://i.imgur.com/l2fbNNt.jpeg"; 
            
            document.getElementById('apple-icon').href = iconUrl;
            document.getElementById('favicon').href = iconUrl;
            
            const manifest = {
                "name": "El Capitán",
                "short_name": "El Capitán",
                "start_url": ".",
                "display": "standalone",
                
                // ✅ AQUÍ ESTÁ EL COLOR EXACTO DE TU PHOTOSHOP
                "background_color": "#00281d", 
                
                "theme_color": "#00ff55",
                "orientation": "portrait",
                "icons": [
                    { "src": iconUrl, "sizes": "192x192", "type": "image/png" },
                    { "src": iconUrl, "sizes": "512x512", "type": "image/png" }
                ]
            };
            
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos base -->
    <style>
        body { background-color: #121212; color: #e5e7eb; font-family: sans-serif; padding-bottom: 100px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #00ff55; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #root { min-height: 100vh; display: flex; flex-direction: column; }
        #error-display { display: none; padding: 20px; color: #ff6b6b; background: #2d1b1b; text-align: center; }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Animación para elementos destacados (Premium) */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .premium-border {
            position: relative;
            border: 2px solid #fbbf24; /* Dorado */
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        .premium-badge {
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);
            background-size: 200% 100%;
            animation: shimmer 3s infinite linear;
            color: black;
            font-weight: 900;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        /* FIX PARA CALENDARIO Y RELOJ EN WEB (PC) */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.8;
        }
        ::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        /* --- ESTILOS DE INPUTS Y SELECTS UNIFICADOS (FIX VISUAL) --- */
        .app-input, .app-select {
            background-color: #1f2937; /* Gris oscuro sólido, no transparente */
            color: #ffffff; /* Texto blanco brillante */
            border: 1px solid #374151; /* Borde gris medio */
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            appearance: none; /* Limpia estilos nativos del celular */
        }
        
        .app-input:focus, .app-select:focus {
            border-color: #00ff55; /* Borde verde al tocar */
            background-color: #111827;
        }

        /* Fix para las opciones del select en móviles */
        .app-select option {
            background-color: #1f2937;
            color: white;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root">
        <div class="flex-1 flex items-center justify-center text-[#00ff55] animate-pulse">
            <svg class="w-10 h-10 animate-spin mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
            Cargando El Capitán...
        </div>
    </div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Users, MapPin, Calendar, Shield, Search, PlusCircle, AlertCircle, 
            ChevronRight, ChevronDown, ChevronUp, Swords, Star, Menu, X, Filter, 
            Link as LinkIcon, User, LogOut, Mail, Lock, Trash2, Ban, Trophy, 
            Activity, ArrowLeft, HelpCircle, FileText, Lock as LockIcon, Bell, 
            CheckCircle, XCircle, Send, Crown, UserPlus, Share2, Edit2, Save, MinusCircle,
            Home, Zap, ClipboardList, AlertTriangle, Download, UserCheck, UserX, Clock, MessageCircle, Beer, Flame, Banknote, Image as ImageIcon, Camera, Info, Check, X as XIcon, Inbox, Sparkles, BarChart2, Filter as FilterIcon
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            signInAnonymously, signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
           getFirestore, collection, query, onSnapshot, doc, updateDoc, increment, 
           arrayUnion, arrayRemove, addDoc, serverTimestamp, deleteDoc, where, 
           orderBy, getDoc, setDoc, getDocs, Timestamp, enableIndexedDbPersistence 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // --- DEFINICIONES GLOBALES ---
        const appId = 'el-capitan-web';
        const ADMIN_EMAILS = ["worlddigital2011@gmail.com", "admin@elenganche.com", "eyamilgimenez98@gmail.com"];
        
        const LA_PLATA_ZONES = [
            "Todas", "La Plata (Casco Urbano)", "City Bell", "Villa Elisa", 
            "Manuel B. Gonnet", "Arturo Seguí", "Ringuelet", "Tolosa", 
            "Los Hornos", "San Carlos", "Villa Elvira", "Altos de San Lorenzo", 
            "Villa Castells", "Joaquín Gorina", "José Hernández", "Lisandro Olmos", 
            "Melchor Romero", "Abasto", "Etcheverry", "El Peligro", "Sicardi / Villa Garibaldi"
        ];
        
        const ZONES_BY_AREA = {
            "Casco Urbano": ["La Plata (Casco Urbano)"],
            "Zona Norte": ["Arturo Seguí", "Villa Elisa", "City Bell", "Manuel B. Gonnet", "Ringuelet", "Tolosa", "Villa Castells", "Joaquín Gorina", "José Hernández"],
            "Zona Oeste": ["San Carlos", "Los Hornos", "Lisandro Olmos", "Melchor Romero", "Abasto", "Etcheverry", "El Peligro"],
            "Zona Sur": ["Villa Elvira", "Altos de San Lorenzo", "Sicardi / Villa Garibaldi"],
            "Zona Este": ["Ensenada", "Berisso"]
        };

        const MATCH_LEVELS = ["Tranqui / Joda", "Picado Medio", "A Morir (Competitivo)"];
        const MATCH_GENDERS = ["Hombres", "Mujeres", "Mixto"];
        const POSITIONS_LIST = ["Arquero", "Defensor", "Medio", "Delantero", "Polifuncional"];
        
        const DAYS_BETWEEN_UPDATES = 30;
        const MAX_ACTIVE_APPLICATIONS_PER_USER = 4;
        const MAX_APPLICATIONS_PER_SLOT = 10; 

        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        const yesterdayString = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        const sevenDaysAgoString = new Date(Date.now() - 86400000 * 7).toISOString().split('T')[0];
        const maxPublishDate = new Date(Date.now() + 86400000 * 7).toISOString().split('T')[0];

        // --- COMPONENTES AUXILIARES ---
        const MobileHeaderButton = ({ icon: Icon, label, onClick, highlight }) => (
            <button 
                onClick={onClick} 
                className={`flex flex-col items-center justify-center py-2 rounded-lg transition-all active:scale-95 border ${
                    highlight 
                    ? 'bg-[#00ff55] text-black border-[#00cc44] shadow-[0_0_10px_rgba(0,255,85,0.3)]' 
                    : 'bg-[#1a1a1a] text-gray-300 border-gray-800 hover:border-gray-600 hover:text-white'
                }`}
            >
                <Icon size={18} className={highlight ? "mb-1 text-black" : "mb-1 text-[#00ff55]"} />
                <span className="text-[9px] font-black uppercase tracking-wider">{label}</span>
            </button>
        );

        const ZoneSelectOptions = () => (<>{Object.entries(ZONES_BY_AREA).map(([region, zones]) => (
            <optgroup 
                key={region} 
                label={region.toUpperCase()} 
                className="bg-gray-900 text-white font-black uppercase tracking-widest text-sm"
                style={{ fontWeight: '900', color: '#ffffff', backgroundColor: '#000000' }}
            >
                {zones.map(z => <option key={z} value={z} className="bg-gray-800 font-normal text-gray-300 pl-4">{z}</option>)}
            </optgroup>
        ))}</>);

        const StarRating = ({ rating }) => {
            return (
                <div className="flex items-center gap-0.5">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <Star 
                            key={star} 
                            size={10} 
                            className={`${(rating || 0) >= star ? "fill-yellow-400 text-yellow-400" : "text-gray-300 fill-gray-200"}`} 
                        />
                    ))}
                </div>
            );
        };

        // --- DATOS FICTICIOS (Seeders) ---
        const INITIAL_MATCHES = [
            { date: yesterdayString, time: '20:00', place: 'Predio El Rincón', zone: 'La Plata (Casco Urbano)', format: 'F5', type: 'player', gender: 'Hombres', missing: 0, position: 'Arquero', teamName: 'Los Rotos FC', urgent: false, playersSigned: ['dummy_1', 'dummy_2'], level: 'Picado Medio', applicationsCount: 0, isPromoted: true },
            { date: today, time: '21:00', place: 'Club Atl. Villa Elisa', zone: 'Villa Elisa', format: 'F7', type: 'rival', gender: 'Mixto', isChallenge: true, stake: 'La cancha ($30.000)', missing: 0, position: 'Equipo Completo', teamName: 'Defensores VE', urgent: true, level: 'A Morir (Competitivo)', applicationsCount: 2 },
            { date: tomorrow, time: '19:00', place: 'La Plaza', zone: 'City Bell', format: 'F5', type: 'player', missing: 2, gender: 'Mujeres', position: 'Defensores', teamName: 'Inter CB', urgent: false, level: 'Tranqui / Joda', applicationsCount: 5 },
        ];
        const INITIAL_PLAYERS = [
            { uid: 'dummy_1', name: 'Lucho M.', position: 'Arquero', zone: 'Villa Elisa', rating: 4.5, ratingCount: 10, status: 'Disponible', level: 'A Morir (Competitivo)', gender: 'Hombres', isPromoted: true },
            { uid: 'dummy_2', name: 'El Distinto', position: 'Medio', zone: 'La Plata', rating: 5.0, ratingCount: 3, status: 'Disponible', level: 'Picado Medio', gender: 'Mixto' },
        ];

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [checkingAuth, setCheckingAuth] = useState(true);
            
            // ADMIN STATE
            const [adminData, setAdminData] = useState({ totalUsers: 0, allUsersList: [] });
            
            // ESTADO PARA EL FILTRO DEL DASHBOARD (NUEVO)
            const [dashboardTimeRange, setDashboardTimeRange] = useState('all');

            const getFirebaseConfig = () => ({
                apiKey: "AIzaSyC8att6xIu--GeDn7uY6gHkIrwUU1UhwpM",
                authDomain: "el-enganche.firebaseapp.com",
                projectId: "el-enganche",
                storageBucket: "el-enganche.firebasestorage.app",
                messagingSenderId: "733812663281",
                appId: "1:733812663281:web:1e0ba9ca08a331930eda50"
            });

            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);

            useEffect(() => {
                 try {
                    const app = initializeApp(getFirebaseConfig());
                    const appCheck = initializeAppCheck(app, {
                        provider: new ReCaptchaV3Provider('6LdxFE4sAAAAAIcAqm8pq_mfpw1WRzVRJtHiOkP4'),
                        isTokenAutoRefreshEnabled: true
                    });
                    setAuth(getAuth(app));
                    const database = getFirestore(app);
                    setDb(database);
                    enableIndexedDbPersistence(database).catch((err) => {
                        console.log('Persistencia:', err.code);
                    });
                } catch(e) { console.error(e); }
            }, []);

            // Data States
            const [matches, setMatches] = useState([]);
            const [myFullHistoryMatches, setMyFullHistoryMatches] = useState([]);
            const [myFullJoinedMatches, setMyFullJoinedMatches] = useState([]);
            
            const [players, setPlayers] = useState([]);
            const [invitations, setInvitations] = useState([]); 
            const [myTeam, setMyTeam] = useState(null);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            const [uploadingLogo, setUploadingLogo] = useState(false);
            const [showStatsDetails, setShowStatsDetails] = useState(false);
            
            // UI States
            const [historyEnabled, setHistoryEnabled] = useState(false);

            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showInviteModal, setShowInviteModal] = useState(false);
            const [showCreateTeamModal, setShowCreateTeamModal] = useState(false);
            const [showPublishModal, setShowPublishModal] = useState(false);
            const [showScoutModal, setShowScoutModal] = useState(false);
            const [showTeamSearchModal, setShowTeamSearchModal] = useState(false);
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [showMapModal, setShowMapModal] = useState(false);
            const [showRatingModal, setShowRatingModal] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            
            const [feedbackModal, setFeedbackModal] = useState({ show: false, type: 'success', title: '', message: '' });
            
            // Filter States
            const [formatFilter, setFormatFilter] = useState('Todos');
            const [zoneFilter, setZoneFilter] = useState('Todas');
            
            // Form States
            const [inviteData, setInviteData] = useState({ place: '', time: '' });
            const [targetPlayer, setTargetPlayer] = useState(null);
            const [newTeamName, setNewTeamName] = useState('');
            const [teamLogoFile, setTeamLogoFile] = useState(null);
            const [publishData, setPublishData] = useState({ type: 'player', format: 'F5', zone: 'La Plata (Casco Urbano)', place: '', time: '', date: '', level: 'Picado Medio', gender: 'Hombres', isChallenge: false, stake: '', isPromoted: false });
            const [neededPositions, setNeededPositions] = useState(['Cualquiera']);
            const [playerPostulationLevel, setPlayerPostulationLevel] = useState('Picado Medio');
            const [postulationPosition, setPostulationPosition] = useState('Polifuncional'); 
            const [playerPostulationGender, setPlayerPostulationGender] = useState('Hombres');
            const [isPostulationPromoted, setIsPostulationPromoted] = useState(false);
            
            // Edit States
            const [isEditingNickname, setIsEditingNickname] = useState(false);
            const [isEditingPosition, setIsEditingPosition] = useState(false);
            const [nicknameInput, setNicknameInput] = useState('');
            const [birthDateInput, setBirthDateInput] = useState(''); // NUEVO: EDAD
            const [isEditingTeamName, setIsEditingTeamName] = useState(false);
            const [teamNameInput, setTeamNameInput] = useState('');

            // Search States
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [teamSearchQuery, setTeamSearchQuery] = useState('');
            const [teamSearchResults, setTeamSearchResults] = useState([]);
            
            const [confirmation, setConfirmation] = useState({ show: false, text: '', action: null });
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            const [pendingLogoFile, setPendingLogoFile] = useState(null);

            // HELPER EDAD
            const calculateAge = (dob) => {
                if (!dob) return null;
                const diff = Date.now() - new Date(dob).getTime();
                const ageDate = new Date(diff); 
                return Math.abs(ageDate.getUTCFullYear() - 1970);
            };

            // Computed
            const isAdmin = user && ADMIN_EMAILS.includes(user.email);
            // --- ADMIN: CONTAR USUARIOS REALES ---
            useEffect(() => {
                if (!db || !user || !isAdmin) return;
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => {
                     setAdminData({ 
                        totalUsers: s.size, 
                        allUsersList: s.docs.map(d => ({ uid: d.id, ...d.data() })) 
                     });
                });
                return () => unsub();
            }, [db, user, isAdmin]);

            // Sincronizar input de fecha con el perfil (NUEVO)
            useEffect(() => {
                if(userProfile?.birthDate) setBirthDateInput(userProfile.birthDate);
                if(userProfile?.nickname) setNicknameInput(userProfile.nickname);
            }, [userProfile, isEditingNickname]);
            
            // FIX: LISTAS UNIFICADAS PARA MOSTRAR CORRECTAMENTE EL HISTORIAL O EL FEED
            const myOrganizedMatches = historyEnabled ? myFullHistoryMatches : matches.filter(m => m.createdBy === user?.uid); 
            // Si el historial está habilitado, usamos la lista completa. Si no, usamos la lista filtrada del feed (solo recientes).
            const myPlayedMatches = historyEnabled ? myFullJoinedMatches : (user ? matches.filter(m => m.playersSigned && m.playersSigned.includes(user.uid)) : []);
            
            // Contadores
            const createdCount = myOrganizedMatches.length;
            const playedCount = myPlayedMatches.length;
            
            const myPostulations = user ? players.filter(p => p.uid === user.uid) : [];
            const userRating = userProfile?.rating || 0;
            const userRatingCount = userProfile?.ratingCount || 0;
            
            const receivedNotifications = invitations.filter(inv => inv.toUserId === user?.uid && inv.status === 'pending');
            const mySentApplications = invitations.filter(inv => inv.fromUserId === user?.uid && inv.type === 'match_request' && inv.status === 'pending');

            const isCaptain = myTeam && myTeam.captainId === user?.uid;
            const myPlayerProfile = players.find(p => user && p.uid === user.uid);
            
            const handleAddSlot = () => setNeededPositions([...neededPositions, 'Cualquiera']);
            const handleRemoveSlot = (index) => setNeededPositions(neededPositions.filter((_, i) => i !== index));
            const handleSlotChange = (index, value) => {
                const newSlots = [...neededPositions];
                newSlots[index] = value;
                setNeededPositions(newSlots);
            };

            // --- AUTH & DATA SUBSCRIPTION ---
            useEffect(() => {
                if(!auth) return;
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u.isAnonymous ? null : u);
                        if (!u.isAnonymous) {
                            setView('app');
                            if (db) {
                                const userRef = doc(db, 'artifacts', 'el-capitan-web', 'public', 'data', 'users', u.uid);
                                const snap = await getDoc(userRef);
                                if (!snap.exists()) {
                                    await setDoc(userRef, { uid: u.uid, name: u.displayName, nickname: u.displayName, email: u.email, position: 'Polifuncional', searchName: u.displayName ? u.displayName.toLowerCase() : '', createdAt: serverTimestamp() });
                                    setUserProfile({ position: 'Polifuncional', nickname: u.displayName });
                                } else {
                                    setUserProfile(snap.data());
                                }
                            }
                        }
                    } else {
                         try { await signInAnonymously(auth); } catch(e) { console.log("Auth anon failed", e); }
                    }
                    setCheckingAuth(false);
                });
            }, [auth, db]);

            useEffect(() => {
                if(userProfile?.position) setPostulationPosition(userProfile.position);
            }, [userProfile]);

            // LISTENER DE MI HISTORIAL COMPLETO (BAJO DEMANDA)
            useEffect(() => {
                if(!user || !db || user.isAnonymous || !historyEnabled) return; 
                
                const qCreated = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('createdBy', '==', user.uid));
                const unsubCreated = onSnapshot(qCreated, (s) => {
                    const docs = s.docs.map(d => ({id: d.id, ...d.data()}));
                    const sorted = docs.sort((a, b) => {
                        try {
                            const dateA = a.date ? new Date(a.date + 'T' + (a.time || '00:00')) : new Date(0);
                            const dateB = b.date ? new Date(b.date + 'T' + (b.time || '00:00')) : new Date(0);
                            if (isNaN(dateA)) return 1;
                            if (isNaN(dateB)) return -1;
                            return dateB - dateA;
                        } catch {
                            return 0;
                        }
                  });
                  setMyFullHistoryMatches(sorted);
                });
                const qJoined = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('playersSigned', 'array-contains', user.uid));
                const unsubJoined = onSnapshot(qJoined, (s) => {
                    // FIX: Safe date sorting
                    setMyFullJoinedMatches(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => {
                        const dateA = a.date ? new Date(a.date) : new Date(0);
                        const dateB = b.date ? new Date(b.date) : new Date(0);
                        return dateB - dateA;
                    }));
                });
                return () => { unsubCreated(); unsubJoined(); }
            }, [user, db, historyEnabled]);

            useEffect(() => {
                if(!user || !db) return;
                const unsubTeam = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), (s) => {
                    const found = s.docs.map(d => ({id: d.id, ...d.data()})).find(t => t.captainId === user.uid || t.members?.some(m => m.uid === user.uid));
                    setMyTeam(found || null);
                });
                
                const unsubInv = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), (s) => {
                    const all = s.docs.map(d => ({id: d.id, ...d.data()}));
                    setInvitations(all.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0)));
                });
                return () => { unsubTeam(); unsubInv(); }
            }, [user, db]);

            useEffect(() => {
                if(!db) return;
                const qM = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('date', '>=', sevenDaysAgoString));
                const unsubM = onSnapshot(qM, (s) => {
                    const d = s.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    if(d.length === 0) seedMatches();
                    else setMatches(d.sort((a,b) => {
                        if (a.isPromoted && !b.isPromoted) return -1;
                        if (!a.isPromoted && b.isPromoted) return 1;
                        return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time);
                    }));
                    setLoading(false);
                }, () => { setMatches(INITIAL_MATCHES); setLoading(false); });

                const qP = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'), where('createdAt', '>', Timestamp.fromDate(new Date(Date.now() - 86400000 * 7))));
                const unsubP = onSnapshot(qP, (s) => {
                    const d = s.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    if(d.length === 0) seedPlayers();
                    else setPlayers(d.sort((a,b) => {
                        if (a.isPromoted && !b.isPromoted) return -1;
                        if (!a.isPromoted && b.isPromoted) return 1;
                         return 0;
                    }));
                }, () => { setPlayers(INITIAL_PLAYERS); }); 

                return () => { unsubM(); unsubP(); }
            }, [db]);

            const seedMatches = async () => {
                if(!db) return;
                const ref = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
                const snap = await getDocs(ref);
                if(snap.size === 0) {
                    for(const m of INITIAL_MATCHES) await addDoc(ref, {...m, createdBy: 'system', createdAt: serverTimestamp()});
                }
            };
            const seedPlayers = async () => {
                if(!db) return;
                const ref = collection(db, 'artifacts', appId, 'public', 'data', 'players');
                const snap = await getDocs(ref);
                if(snap.size === 0) {
                    for(const p of INITIAL_PLAYERS) await addDoc(ref, {...p, uid: 'dummy_'+Math.random(), createdAt: serverTimestamp()});
                }
            };

            // --- HELPERS ---
            const compressImageToBase64 = async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX = 200; 
                            let w = img.width, h = img.height;
                            if(w>h) { if(w>MAX) { h*=MAX/w; w=MAX; } } else { if(h>MAX) { w*=MAX/h; h=MAX; } }
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            const base64String = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(base64String);
                        }
                        img.onerror = () => reject(new Error("La imagen es inválida"));
                    }
                    reader.onerror = () => reject(new Error("Error al leer el archivo"));
                });
            };

            const askConfirmation = (text, action) => setConfirmation({ show: true, text, action });

            const checkUpdateAvailability = (lastUpdateTimestamp) => {
                if (!lastUpdateTimestamp) return { available: true, daysLeft: 0 };
                const lastUpdate = lastUpdateTimestamp.toDate();
                const now = new Date();
                const diffTime = Math.abs(now - lastUpdate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const daysLeft = DAYS_BETWEEN_UPDATES - diffDays;
                return { available: diffDays >= DAYS_BETWEEN_UPDATES, daysLeft: Math.max(0, daysLeft) };
            };

            // --- ACTIONS ---
            const handleGoogleLogin = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); setView('app'); } catch(e) { alert(e.message); } };
            const handleLogout = async () => { await signOut(auth); setView('landing'); };
            const handleGuest = () => setView('app');
            const handleShareApp = () => {
                const text = "¡Sumate a El Capitán! Descargala acá:";
                const url = window.location.href;
                window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, '_blank');
            };
            
            const handleClickHeaderButton = () => {
                if (!user) return setShowLoginModal(true);
                if (!myTeam) return setShowCreateTeamModal(true);
                if (myTeam.captainId !== user.uid) return alert("Solo el capitán puede publicar.");
                setShowPublishModal(true);
            };

            const handleInstallClick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') setDeferredPrompt(null);
                } else { setShowInstallModal(true); }
            };

            const handleApplyMatch = async (match) => {
                if (!user) return setShowLoginModal(true);
                
                if (match.playersSigned?.includes(user.uid)) {
                     const ref = doc(db, 'artifacts', appId, 'public', 'data', 'matches', match.id);
                     try {
                         await updateDoc(ref, { missing: increment(1), playersSigned: arrayRemove(user.uid) });
                     } catch(e) { alert(e.message); }
                     return;
                }

                if (mySentApplications.length >= MAX_ACTIVE_APPLICATIONS_PER_USER) {
                    setFeedbackModal({ show: true, type: 'error', title: 'LÍMITE ALCANZADO', message: `Ya tienes ${MAX_ACTIVE_APPLICATIONS_PER_USER} solicitudes pendientes. Espera a que te respondan.` });
                    return;
                }

                const maxRequestsForThisMatch = (match.missing || 1) * MAX_APPLICATIONS_PER_SLOT;
                if ((match.applicationsCount || 0) >= maxRequestsForThisMatch) {
                    setFeedbackModal({ show: true, type: 'error', title: 'CUPO LLENO', message: 'Este partido ya tiene demasiadas solicitudes pendientes.' });
                    return;
                }

                if (invitations.some(i => i.fromUserId === user.uid && i.matchId === match.id && i.status === 'pending')) {
                     setFeedbackModal({ show: true, type: 'info', title: 'YA SOLICITADO', message: 'Ya has enviado una solicitud a este partido.' });
                     return;
                }

                const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', match.id);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), {
                        type: 'match_request', 
                        fromUserId: user.uid,
                        fromName: userProfile?.nickname || user.displayName,
                        fromTeamName: myTeam ? myTeam.name : null, 
                        matchId: match.id,
                        matchInfo: `${match.teamName} - ${match.date} ${match.time}`, 
                        toUserId: match.createdBy, 
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    await updateDoc(matchRef, { applicationsCount: increment(1) });
                    setFeedbackModal({ show: true, type: 'success', title: 'SOLICITUD ENVIADA', message: 'El organizador ha recibido tu petición.' });
                } catch(e) { alert(e.message); }
            };

            const handleCancelRequest = async (invitationId, matchId) => {
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', invitationId));
                    if(matchId) {
                        const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', matchId);
                        await updateDoc(matchRef, { applicationsCount: increment(-1) });
                    }
                    setFeedbackModal({ show: true, type: 'info', title: 'CANCELADA', message: 'Has cancelado la solicitud.' });
                } catch (e) { alert(e.message); }
            };

            const handleRespondMatchRequest = async (inv, action) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', inv.id), { status: action });
                    
                    const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', inv.matchId);
                    await updateDoc(matchRef, { applicationsCount: increment(-1) });

                    if (action === 'accepted') {
                        await updateDoc(matchRef, {
                            playersSigned: arrayUnion(inv.fromUserId),
                            missing: increment(-1) 
                        });
                        setFeedbackModal({ show: true, type: 'success', title: 'ACEPTADO', message: `${inv.fromName} se ha unido al partido.` });
                    }
                } catch (e) { alert(e.message); }
            };

            const handlePublishMatch = async (e) => {
                e.preventDefault();
                if(!user) return;
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', 'el-capitan-web', 'public', 'data', 'matches'), {
                        ...publishData,
                        missing: publishData.type==='rival'?0:neededPositions.length,
                        position: publishData.type==='rival'?'Equipo Completo':neededPositions.join(', '),
                        teamName: myTeam ? myTeam.name : (userProfile?.nickname || user.displayName) + " Team",
                        urgent: false, playersSigned: [], createdBy: user.uid, createdAt: serverTimestamp(),
                        applicationsCount: 0 
                    });
                    setPublishData({ ...publishData, place: '', time: '', date: '', isChallenge: false, stake: '', isPromoted: false });
                    setNeededPositions(['Cualquiera']);
                    setShowPublishModal(false);
                    setFeedbackModal({ show: true, type: 'success', title: '¡PUBLICADO!', message: 'Tu partido ya está visible para todos.' });
                } catch(e) { alert(e.message); } finally { setSubmitting(false); }
            };

            const handleJoinAsPlayer = async () => {
                if (!user) { setShowLoginModal(true); return; }
                if (players.some(p => p.uid === user.uid)) return alert("Ya estás postulado como agente libre.");
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'players'), {
                        uid: user.uid, 
                        name: userProfile?.nickname || user.displayName, 
                        position: postulationPosition, 
                        zone: 'La Plata',
                        level: playerPostulationLevel,
                        gender: playerPostulationGender, 
                        isPromoted: userProfile?.isPromoted || false,
                        rating: 0, ratingCount: 0, status: 'Disponible', createdAt: serverTimestamp()
                    });
                    setFeedbackModal({ show: true, type: 'success', title: '¡LISTO!', message: 'Te has postulado correctamente.' });
                } catch(err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            const confirmUpdateNickname = async () => {
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), { 
                     nickname: nicknameInput,
                     birthDate: birthDateInput, // GUARDAR FECHA DE NACIMIENTO
                     lastNicknameUpdate: serverTimestamp() 
                 });
                setUserProfile({ ...userProfile, nickname: nicknameInput, birthDate: birthDateInput, lastNicknameUpdate: Timestamp.now() });
                setIsEditingNickname(false);
                if (myPlayerProfile) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myPlayerProfile.id), { name: nicknameInput });
            };

            const handleUpdateNickname = () => {
                if(!user || !nicknameInput.trim()) return;
                const { available, daysLeft } = checkUpdateAvailability(userProfile?.lastNicknameUpdate);
                if (!available) {
                    setFeedbackModal({ show: true, type: 'error', title: 'ESPERA UN POCO', message: `Solo puedes cambiar tu apodo una vez cada 30 días. Faltan ${daysLeft} días.` });
                    return;
                }
                askConfirmation("Estás a punto de cambiar tu apodo. Recuerda que debes esperar 30 días para hacerlo nuevamente. ¿Confirmar?", confirmUpdateNickname);
            };

            const handleUpdatePosition = async (newPos) => {
                if(!user) return;
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                await updateDoc(userRef, { position: newPos });
                setUserProfile({ ...userProfile, position: newPos });
                setPostulationPosition(newPos);
                setIsEditingPosition(false);
                if (myPlayerProfile) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myPlayerProfile.id), { position: newPos });
            };
            
            const processTeamLogoUpdate = async () => {
                if (!pendingLogoFile) return;
                setUploadingLogo(true);
                try {
                    const base64String = await compressImageToBase64(pendingLogoFile);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { logoUrl: base64String, lastLogoUpdate: serverTimestamp() });
                    setUploadingLogo(false); setPendingLogoFile(null);
                    setFeedbackModal({ show: true, type: 'success', title: '¡ÉXITO!', message: 'El escudo de tu equipo se ha actualizado.' });
                } catch(err) {
                    setUploadingLogo(false); setPendingLogoFile(null);
                    setFeedbackModal({ show: true, type: 'error', title: 'ERROR', message: 'No se pudo actualizar el escudo: ' + err.message });
                }
            };

            const handleUpdateTeamLogo = (e) => {
                const file = e.target.files[0];
                if (!file || !user || !myTeam) return;
                if (file.size > 10 * 1024 * 1024) { alert("El logo es muy pesado (Máx 10MB)."); return; }
                const { available, daysLeft } = checkUpdateAvailability(myTeam.lastLogoUpdate);
                if (!available) {
                    setFeedbackModal({ show: true, type: 'error', title: 'ESPERA UN POCO', message: `Solo puedes cambiar el escudo una vez cada 30 días. Faltan ${daysLeft} días.` });
                    e.target.value = null; return;
                }
                setPendingLogoFile(file);
                askConfirmation("Estás a punto de cambiar el escudo. Recuerda que debes esperar 30 días para hacerlo nuevamente. ¿Confirmar?", processTeamLogoUpdate);
                e.target.value = null;
            };

            const confirmUpdateTeamName = async () => {
                if (!teamNameInput.trim()) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { name: teamNameInput, searchName: teamNameInput.toLowerCase(), lastNameUpdate: serverTimestamp() });
                setIsEditingTeamName(false);
                setFeedbackModal({ show: true, type: 'success', title: '¡ÉXITO!', message: 'Nombre del equipo actualizado.' });
            };

            const handleUpdateTeamName = () => {
                if (!teamNameInput.trim()) return;
                const { available, daysLeft } = checkUpdateAvailability(myTeam.lastNameUpdate);
                if (!available) {
                    setFeedbackModal({ show: true, type: 'error', title: 'ESPERA UN POCO', message: `Solo puedes cambiar el nombre del equipo una vez cada 30 días. Faltan ${daysLeft} días.` });
                    return;
                }
                askConfirmation("Estás a punto de cambiar el nombre del equipo. Recuerda que debes esperar 30 días para hacerlo nuevamente. ¿Confirmar?", confirmUpdateTeamName);
            };

            const handleDeletePlayer = (id) => {
                if (!user) return;
                if (isAdmin || players.find(p=>p.id===id)?.uid === user?.uid) {
                    askConfirmation("¿Vas a eliminar a este jugador de la lista?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', id)));
                }
            };
            const handleDeleteMatch = (idMatch) => {
                if (!user) return;
                const match = matches.find(m => m.id === idMatch);
                const isCreator = match && match.createdBy === user.uid;
                if(isAdmin || isCreator) {
                    askConfirmation("¿Vas a eliminar este partido permanentemente?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', idMatch)));
                }
            };
            
            const handleDeleteTeam = async () => {
                if(!user || !myTeam) return;
                askConfirmation("¿Estás seguro de que quieres disolver el equipo?", async () => {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id));
                        setMyTeam(null);
                        alert("Equipo disuelto.");
                    } catch(e) { alert("Error: " + e.message); }
                });
            };

            const handleLeaveTeam = async () => {
                if(!user || !myTeam) return;
                askConfirmation("¿Salir del equipo?", async () => {
                    try {
                          const updatedMembers = myTeam.members.filter(m => m.uid !== user.uid);
                          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { members: updatedMembers });
                          setMyTeam(null);
                    } catch(e) { alert(e.message); }
                });
            };
            
            const handleCreateTeam = async (e) => {
                e.preventDefault();
                if (!user || !newTeamName) return;
                setSubmitting(true);
                try {
                    let logoUrl = "";
                    if (teamLogoFile) {
                        logoUrl = await compressImageToBase64(teamLogoFile);
                    }
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), {
                        name: newTeamName, captainId: user.uid, captainName: userProfile?.nickname || user.displayName, logoUrl: logoUrl,
                        members: [{ uid: user.uid, name: userProfile?.nickname || user.displayName, role: 'captain', status: 'active' }],
                        searchName: newTeamName.toLowerCase(), createdAt: serverTimestamp(), lastLogoUpdate: serverTimestamp(), lastNameUpdate: serverTimestamp()
                    });
                    setNewTeamName(''); setTeamLogoFile(null); setShowCreateTeamModal(false); setView('team');
                    setFeedbackModal({ show: true, type: 'success', title: '¡EQUIPO CREADO!', message: 'Ahora eres el capitán.' });
                } catch(err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            const handleCreateDemoTeam = async () => {
                if (!user) return;
                const demoPlayers = [{ uid: 'd1', name: 'Esteban', role: 'player', status: 'active' }, { uid: 'd2', name: 'Pedro', role: 'player', status: 'active' }];
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), {
                    name: "Dream Team (Demo)", captainId: user.uid, captainName: userProfile?.nickname || user.displayName,
                    members: [{ uid: user.uid, name: userProfile?.nickname || user.displayName, role: 'captain', status: 'active' }, ...demoPlayers],
                    searchName: "dream team demo", createdAt: serverTimestamp()
                });
                alert("Equipo Demo Generado!");
            };
            
            const handleToggleMemberStatus = async (memberUid, currentStatus) => {
                if (!myTeam || !user) return;
                if (isCaptain || user.uid === memberUid) {
                    const newStatus = currentStatus === 'active' ? 'injured' : 'active';
                    const updatedMembers = myTeam.members.map(m => m.uid === memberUid ? { ...m, status: newStatus } : m);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { members: updatedMembers });
                } else {
                    alert("Solo el capitán o el propio jugador pueden cambiar este estado.");
                }
            };

            const handleSearchUsers = async (e) => {
                e.preventDefault(); if (!searchQuery.trim()) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('searchName', '>=', searchQuery.toLowerCase()), where('searchName', '<=', searchQuery.toLowerCase() + '\uf8ff'));
                const snaps = await getDocs(q); setSearchResults(snaps.docs.map(d => d.data()));
            };
            const handleSearchTeams = async (e) => {
                e.preventDefault(); if (!teamSearchQuery.trim()) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), where('searchName', '>=', teamSearchQuery.toLowerCase()), where('searchName', '<=', teamSearchQuery.toLowerCase() + '\uf8ff'));
                const snaps = await getDocs(q); setTeamSearchResults(snaps.docs.map(d => ({id: d.id, ...d.data()})));
            };

            const sendSystemInvite = async (targetUser) => {
                if (!user || !myTeam) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), { type: 'recruit', fromUserId: user.uid, fromName: userProfile?.nickname || user.displayName, teamId: myTeam.id, teamName: myTeam.name, toUserId: targetUser.uid, toPlayerName: targetUser.nickname || targetUser.name, place: "Fichaje", time: "General", status: 'pending', createdAt: serverTimestamp() });
                alert("Solicitud enviada.");
            };
            const sendJoinRequest = async (targetTeam) => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), { type: 'join_request', fromUserId: user.uid, fromName: userProfile?.nickname || user.displayName, teamId: targetTeam.id, teamName: targetTeam.name, toUserId: targetTeam.captainId, status: 'pending', createdAt: serverTimestamp() });
                alert("Solicitud enviada"); setShowTeamSearchModal(false);
            };
            const openInviteModal = (player) => {
                if (!user) { setShowLoginModal(true); return; }
                if (!myTeam || myTeam.captainId !== user.uid) { alert("Solo capitanes."); return; }
                setTargetPlayer(player); setInviteData({ place: '', time: '' }); setShowInviteModal(true);
            };

            const sendInvitation = async (e) => {
                e.preventDefault();
                if (!user || !myTeam || !targetPlayer) return;
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), {
                        type: 'recruit', fromUserId: user.uid, fromName: userProfile?.nickname || user.displayName, teamId: myTeam.id, teamName: myTeam.name,
                        toUserId: targetPlayer.uid, toPlayerName: targetPlayer.name, place: inviteData.place, time: inviteData.time, status: 'pending', createdAt: serverTimestamp()
                    });
                    setShowInviteModal(false); setInviteData({ place: '', time: '' }); alert(`¡Invitación enviada!`);
                } catch (err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            const handleRespondInvitation = async (inv, response) => {
                if (!user) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', inv.id), { status: response });
                if (response === 'accepted') {
                    const teamRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', inv.teamId);
                    const snap = await getDoc(teamRef);
                    if (snap.exists() && !snap.data().members.some(m => m.uid === (inv.type === 'join_request' ? inv.fromUserId : user.uid))) {
                        const uidToAdd = inv.type === 'join_request' ? inv.fromUserId : user.uid;
                        const nameToAdd = inv.type === 'join_request' ? inv.fromName : (userProfile?.nickname || user.displayName);
                        await updateDoc(teamRef, { members: arrayUnion({ uid: uidToAdd, name: nameToAdd, role: 'player', status: 'active' }) });
                        alert(`¡${nameToAdd} se unió a ${inv.teamName}!`);
                    }
                }
            };
            
            // --- FUNCIONES ADMIN ---
            const handleTogglePremiumUser = async (userId, currentStatus) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), { isPromoted: !currentStatus });
                // Refresca la lista local para ver el cambio inmediato
                setAdminData(prev => ({
                    ...prev,
                    allUsersList: prev.allUsersList.map(u => u.uid === userId ? {...u, isPromoted: !currentStatus} : u)
                }));
            };
            
            const handleTogglePremiumPlayer = async (playerId, currentStatus) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', playerId), { isPromoted: !currentStatus });
                 // Refrescar lista visualmente
                 const pIndex = players.findIndex(p => p.id === playerId);
                 if(pIndex >= 0) {
                     const newPlayers = [...players];
                     newPlayers[pIndex].isPromoted = !currentStatus;
                     setPlayers(newPlayers);
                 }
            };

            // --- VISTAS ---
            if (checkingAuth) {
                return (
                    <div className="flex-1 flex items-center justify-center bg-black h-screen">
                         <div className="flex flex-col items-center gap-4">
                             <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[#00ff55]"></div>
                             <div className="text-[#00ff55] font-bold text-sm tracking-widest animate-pulse">VERIFICANDO SESIÓN...</div>
                         </div>
                    </div>
                );
            }

            if (view === 'landing') {
                return (
                    <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gradient-to-br from-[#003300] to-[#001a00] relative overflow-hidden h-screen">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_0%,_rgba(0,255,85,0.1),_transparent_70%)]"></div>
                        <div className="z-10 mb-12 transform hover:scale-105 transition-transform duration-500 flex flex-col items-center">
                            <img src="https://i.imgur.com/F7p7sXT.png" alt="El Capitán" className="w-64 sm:w-80 object-contain drop-shadow-[0_0_15px_rgba(0,255,85,0.3)]" />
                        </div>
                        <div className="z-10 w-full max-w-sm space-y-4">
                            {user ? (
                                userProfile ? (
                                    <button onClick={() => setView('app')} className="w-full bg-[#00ff55] hover:bg-white text-black font-black py-4 rounded-xl shadow-[0_0_20px_rgba(0,255,85,0.4)] flex items-center justify-center gap-2 uppercase tracking-wide transition-all"><User size={24}/> Continuar como {userProfile.nickname}</button>
                                ) : (
                                    <div className="w-full bg-[#002200] text-[#00ff55] font-bold py-4 rounded-xl flex items-center justify-center gap-2 animate-pulse">Cargando perfil...</div>
                                )
                            ) : (
                                <button onClick={handleGoogleLogin} className="w-full bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all active:scale-95 border border-gray-200">
                                    <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.17c-.22-.66-.35-1.36-.35-2.17s.13-1.51.35-2.17V7.61H2.18C.79 10.37.79 13.63 2.18 16.39l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.05l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                    Ingresar con Google
                                </button>
                            )}
                            <button onClick={handleGuest} className="w-full bg-white/5 hover:bg-white/10 text-[#00ff55] border-2 border-[#00ff55]/50 font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all"><Users size={20}/> Entrar como Invitado</button>
                        </div>
                    </div>
                );
            }

            // FEED FILTRADO
            const feedMatches = matches.filter(m => 
                (formatFilter === 'Todos' || m.format === formatFilter) && 
                (zoneFilter === 'Todas' || m.zone === zoneFilter) &&
                (m.date >= yesterdayString)
            );

            return (
                <div className="flex-1 flex flex-col pb-24">
                    <header className="bg-gradient-to-r from-[#003300] to-[#004d26] border-b-4 border-[#00ff55] sticky top-0 z-50 shadow-xl">
                        {/* HEADER MÓVIL */}
                        <div className="sm:hidden flex flex-col w-full">
                            <div className="flex justify-between items-center px-4 py-2 border-b border-white/10 bg-[#001a00]">
                                <img src="https://i.imgur.com/aVwYCPF.png" alt="El Capitán" className="h-8 object-contain" />
                                <div className="flex items-center">
                                    {user ? (
                                        <button className="relative p-2 text-gray-300 hover:text-white" onClick={() => setShowNotifications(!showNotifications)}>
                                            <Bell size={22} className={receivedNotifications.length > 0 ? "text-[#00ff55] animate-pulse" : ""} />
                                            {receivedNotifications.length > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[#003300]"></span>}
                                        </button>
                                    ) : (
                                        <button onClick={() => setShowLoginModal(true)} className="text-[10px] font-bold text-[#00ff55] border border-[#00ff55] px-2 py-1 rounded flex items-center gap-1 uppercase">INGRESAR</button>
                                    )}
                                </div>
                            </div>
                            <div className="grid grid-cols-4 gap-1 p-2 bg-[#002200]">
                                <MobileHeaderButton icon={Share2} label="Invitar" onClick={handleShareApp} />
                                <MobileHeaderButton icon={PlusCircle} label={!myTeam ? "Crear" : "Publicar"} onClick={handleClickHeaderButton} highlight={true} />
                                <MobileHeaderButton icon={Download} label="App" onClick={handleInstallClick} />
                                <MobileHeaderButton icon={MapPin} label="Canchas" onClick={() => setShowMapModal(true)} />
                            </div>
                        </div>

                        {/* HEADER DESKTOP */}
                        <div className="hidden sm:flex h-16 px-4 items-center justify-between">
                            <div className="flex items-center gap-4">
                                <img src="https://i.imgur.com/aVwYCPF.png" alt="El Capitán" className="h-10 object-contain" />
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex gap-2">
                                    <button onClick={handleClickHeaderButton} className="bg-[#00ff55] text-black px-3 py-1.5 rounded font-bold text-xs flex items-center gap-2 hover:bg-white transition-colors"><PlusCircle size={14}/> {!myTeam ? "CREAR EQUIPO" : "PUBLICAR"}</button>
                                    <button onClick={() => setShowMapModal(true)} className="text-white hover:text-[#00ff55] text-xs font-bold flex items-center gap-1 transition-colors"><MapPin size={14}/> CANCHAS</button>
                                </div>
                                {user ? (
                                    <button onClick={() => setShowNotifications(!showNotifications)} className="text-white relative ml-2 hover:text-[#00ff55] transition-colors"><Bell size={20}/></button>
                                ) : (
                                    <button onClick={() => setShowLoginModal(true)} className="text-[#00ff55] font-bold text-xs ml-2 border border-[#00ff55] px-3 py-1 rounded hover:bg-[#00ff55] hover:text-black transition-colors">INGRESAR</button>
                                )}
                            </div>
                        </div>

                        {showNotifications && (
                            <div className="absolute top-14 right-2 w-72 bg-[#1a1a1a] border border-gray-700 rounded-lg shadow-2xl z-[100]">
                                <div className="p-3 bg-gray-900 border-b border-gray-800 text-xs font-bold text-gray-400">Notificaciones ({receivedNotifications.length})</div>
                                <div className="max-h-64 overflow-y-auto">
                                    {receivedNotifications.length > 0 ? receivedNotifications.map(inv => (
                                        <div key={inv.id} className="p-2 border-b border-gray-800">
                                            {inv.type === 'match_request' ? (
                                                <>
                                                    <div className="text-[#00ff55] text-sm font-bold">{inv.fromName} {inv.fromTeamName ? `(${inv.fromTeamName})` : ''}</div>
                                                    <div className="text-xs text-gray-400 mb-2">Quiere unirse a: <span className="text-white">{inv.matchInfo}</span></div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleRespondMatchRequest(inv, 'rejected')} className="flex-1 bg-red-900/50 text-red-400 text-[10px] py-1 rounded hover:bg-red-900"><X size={12} className="inline mr-1"/> Rechazar</button>
                                                        <button onClick={() => handleRespondMatchRequest(inv, 'accepted')} className="flex-1 bg-green-900/50 text-[#00ff55] text-[10px] py-1 rounded hover:bg-green-900"><Check size={12} className="inline mr-1"/> Aceptar</button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="text-[#00ff55] text-sm font-bold">{inv.teamName}</div>
                                                    <div className="text-xs text-gray-400">Te invita a jugar.</div>
                                                </>
                                            )}
                                        </div>
                                    )) : <div className="p-4 text-center text-xs text-gray-500">Sin novedades</div>}
                                </div>
                            </div>
                        )}
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="flex-1 max-w-6xl mx-auto w-full p-2 sm:p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* VISTA ADMIN (SOLO VISIBLE SI SOS ADMIN Y ESTÁS EN ESTA VISTA) */}
                        {view === 'admin' && isAdmin && (
                            <div className="lg:col-span-12 space-y-6">
                                <div className="bg-[#1a1a1a] p-4 rounded text-center border-b-2 border-[#00ff55] relative">
                                    <button 
                                        onClick={() => setView('profile')} 
                                        className="absolute left-4 top-4 text-gray-400 hover:text-[#00ff55] flex flex-col items-center"
                                    >
                                        <ArrowLeft size={20} />
                                        <span className="text-[8px] font-bold uppercase">Volver</span>
                                    </button>
                                    <h2 className="text-2xl font-black text-white italic">PANEL DE COMANDO</h2>
                                    <p className="text-gray-400 text-xs">Gestión y Estadísticas</p>
                                </div>

                                {/* ESTADÍSTICAS */}
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <div className="bg-gray-800 p-4 rounded text-center border border-gray-700">
                                        <div className="text-3xl font-black text-[#00ff55]">{adminData.totalUsers || 0}</div>
                                        <div className="text-[10px] text-gray-400 uppercase tracking-widest">Usuarios</div>
                                    </div>
                                    <div className="bg-gray-800 p-4 rounded text-center border border-gray-700">
                                        <div className="text-3xl font-black text-white">{matches.length}</div>
                                        <div className="text-[10px] text-gray-400 uppercase tracking-widest">Partidos Activos</div>
                                    </div>
                                    <div className="bg-gray-800 p-4 rounded text-center border border-gray-700">
                                        <div className="text-3xl font-black text-yellow-400">{players.length}</div>
                                        <div className="text-[10px] text-gray-400 uppercase tracking-widest">Agentes Libres</div>
                                    </div>
                                    <div className="bg-gray-800 p-4 rounded text-center border border-gray-700">
                                        <div className="text-3xl font-black text-blue-400">{invitations.length}</div>
                                        <div className="text-[10px] text-gray-400 uppercase tracking-widest">Invitaciones</div>
                                    </div>
                                </div>

                                {/* LISTA DE USUARIOS PARA ACTIVAR PREMIUM */}
                                <div className="bg-[#1a1a1a] p-4 rounded border border-gray-700">
                                    <h3 className="text-white font-bold mb-4 flex items-center gap-2"><Sparkles className="text-yellow-400"/> Gestión de Suscripciones (Usuarios)</h3>
                                    <div className="space-y-2 max-h-96 overflow-y-auto">
                                        {adminData.allUsersList.map(u => (
                                            <div key={u.uid} className="flex justify-between items-center p-3 bg-gray-900 rounded border border-gray-800">
                                                <div>
                                                    <div className="text-sm font-bold text-white">{u.nickname || u.name}</div>
                                                    <div className="text-xs text-gray-500">{u.email}</div>
                                                </div>
                                                <button 
                                                    onClick={() => handleTogglePremiumUser(u.uid, u.isPromoted)}
                                                    className={`px-3 py-1 rounded text-[10px] font-bold uppercase transition-colors ${
                                                        u.isPromoted ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-gray-400'
                                                    }`}
                                                >
                                                    {u.isPromoted ? 'PREMIUM ACTIVO' : 'ACTIVAR PREMIUM'}
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* DASHBOARD COMERCIAL (SPONSORS & ANALYTICS) */}
                                {(() => {
                                    // 1. LÓGICA DE FILTRADO
                                    const now = new Date();
                                    const filterDate = (dateItem) => {
                                        if (dashboardTimeRange === 'all') return true;
                                        let d;
                                        if (dateItem?.toDate) d = dateItem.toDate(); // Timestamp Firebase
                                        else d = new Date(dateItem); // String
                                        
                                        if (dashboardTimeRange === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                                        if (dashboardTimeRange === 'year') return d.getFullYear() === now.getFullYear();
                                        return true;
                                    };

                                    const fMatches = matches.filter(m => filterDate(m.date));
                                    const fPlayers = players.filter(p => filterDate(p.createdAt));

                                    // 2. CÁLCULOS
                                    const calcGender = (arr) => {
                                        const total = arr.length || 1;
                                        const h = arr.filter(x => x.gender === 'Hombres').length;
                                        const m = arr.filter(x => x.gender === 'Mujeres').length;
                                        const x = arr.filter(x => x.gender === 'Mixto').length;
                                        return { h, m, x, ph: (h/total)*100, pm: (m/total)*100, px: (x/total)*100 };
                                    };
                                    const genMatches = calcGender(fMatches);
                                    const genPlayers = calcGender(fPlayers);

                                    const totalM = fMatches.length;
                                    const challenges = fMatches.filter(m => m.isChallenge || m.type === 'rival').length;
                                    const challengePct = totalM > 0 ? Math.round((challenges / totalM) * 100) : 0;
                                    const premiumTotal = fMatches.filter(m => m.isPromoted).length + fPlayers.filter(p => p.isPromoted).length;

                                    return (
                                        <div className="space-y-6">
                                            {/* BARRA DE CONTROL */}
                                            <div className="flex flex-col sm:flex-row justify-between items-center bg-gray-900 p-3 rounded border-b-2 border-[#00ff55] gap-3">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-[#00ff55] text-black p-2 rounded"><BarChart2 size={20}/></div>
                                                    <div>
                                                        <h3 className="text-sm font-black text-white uppercase italic">Inteligencia Comercial</h3>
                                                        <p className="text-[10px] text-gray-400">Datos para Sponsors</p>
                                                    </div>
                                                </div>
                                                <select 
                                                    value={dashboardTimeRange}
                                                    onChange={(e) => setDashboardTimeRange(e.target.value)}
                                                    className="bg-black text-white text-xs border border-gray-600 rounded px-3 py-1.5 font-bold outline-none hover:border-[#00ff55]"
                                                >
                                                    <option value="all">Histórico Total</option>
                                                    <option value="year">Este Año</option>
                                                    <option value="month">Este Mes</option>
                                                </select>
                                            </div>

                                            {/* KPIs PRINCIPALES */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                <div className="bg-[#1a1a1a] p-3 rounded border border-gray-700 text-center">
                                                    <div className="text-[10px] text-gray-400 uppercase font-bold">Partidos</div>
                                                    <div className="text-2xl font-black text-white">{totalM}</div>
                                                </div>
                                                <div className="bg-[#1a1a1a] p-3 rounded border border-gray-700 text-center">
                                                    <div className="text-[10px] text-gray-400 uppercase font-bold">Jugadores Nuevos</div>
                                                    <div className="text-2xl font-black text-yellow-400">{fPlayers.length}</div>
                                                </div>
                                                <div className="bg-[#1a1a1a] p-3 rounded border border-gray-700 text-center">
                                                    <div className="text-[10px] text-gray-400 uppercase font-bold">Tasa Desafíos</div>
                                                    <div className="text-2xl font-black text-blue-400">{challengePct}%</div>
                                                </div>
                                                <div className="bg-[#1a1a1a] p-3 rounded border border-gray-700 text-center">
                                                    <div className="text-[10px] text-gray-400 uppercase font-bold">Premium</div>
                                                    <div className="text-2xl font-black text-[#00ff55]">{premiumTotal}</div>
                                                </div>
                                            </div>

                                            {/* GÉNERO (DEMOGRAFÍA) */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="bg-[#1a1a1a] p-4 rounded border border-gray-700">
                                                    <h4 className="text-gray-400 text-xs font-bold uppercase mb-3 flex items-center gap-2"><Users size={14} className="text-blue-400"/> Género en Partidos</h4>
                                                    <div className="flex h-4 rounded-full overflow-hidden mb-2">
                                                        <div style={{width: genMatches.ph + '%'}} className="bg-blue-500 h-full"></div>
                                                        <div style={{width: genMatches.pm + '%'}} className="bg-pink-500 h-full"></div>
                                                        <div style={{width: genMatches.px + '%'}} className="bg-purple-500 h-full"></div>
                                                    </div>
                                                    <div className="flex justify-between text-[10px] text-gray-300">
                                                        <span>🔵 H ({genMatches.h})</span>
                                                        <span>🟣 M ({genMatches.m})</span>
                                                        <span>🟣 X ({genMatches.x})</span>
                                                    </div>
                                                </div>

                                                <div className="bg-[#1a1a1a] p-4 rounded border border-gray-700">
                                                    <h4 className="text-gray-400 text-xs font-bold uppercase mb-3 flex items-center gap-2"><User size={14} className="text-yellow-400"/> Género Jugadores</h4>
                                                    <div className="flex h-4 rounded-full overflow-hidden mb-2">
                                                        <div style={{width: genPlayers.ph + '%'}} className="bg-blue-500 h-full"></div>
                                                        <div style={{width: genPlayers.pm + '%'}} className="bg-pink-500 h-full"></div>
                                                        <div style={{width: genPlayers.px + '%'}} className="bg-purple-500 h-full"></div>
                                                    </div>
                                                    <div className="flex justify-between text-[10px] text-gray-300">
                                                        <span>🔵 H ({genPlayers.h})</span>
                                                        <span>🟣 M ({genPlayers.m})</span>
                                                        <span>🟣 X ({genPlayers.x})</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* INTENSIDAD */}
                                            <div className="bg-[#1a1a1a] p-4 rounded border border-gray-700 shadow-lg">
                                                <h4 className="text-white text-xs font-bold uppercase mb-4 flex items-center gap-2"><Activity size={14} className="text-[#00ff55]"/> Intensidad de Consumo</h4>
                                                <div className="space-y-4">
                                                    {(() => {
                                                        const levels = fMatches.reduce((acc, m) => { acc[m.level] = (acc[m.level]||0)+1; return acc; }, {});
                                                        return Object.entries(levels).map(([lvl, count]) => {
                                                            const pct = (count/totalM)*100;
                                                            let color = 'bg-yellow-500';
                                                            if(lvl.includes('Morir')) color='bg-red-600';
                                                            if(lvl.includes('Tranqui')) color='bg-blue-500';
                                                            return (
                                                                <div key={lvl}>
                                                                    <div className="flex justify-between text-[10px] text-white mb-1"><span className="font-bold">{lvl}</span><span>{count}</span></div>
                                                                    <div className="w-full bg-gray-800 rounded-full h-2 relative">
                                                                        <div style={{width: pct+'%'}} className={`h-full rounded-full ${color}`}></div>
                                                                    </div>
                                                                </div>
                                                            )
                                                        });
                                                    })()}
                                                    {totalM === 0 && <div className="text-center text-xs text-gray-500">Sin datos</div>}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        )}

                        {/* VISTA: INICIO (FEED) */}
                        {view === 'app' && (
                            <>
                                <div className="lg:col-span-8 space-y-4">
                                    <div className="bg-gradient-to-r from-[#1b4d2e] to-[#2e7d32] px-4 py-3 rounded-t-lg border-b-2 border-[#4caf50] flex flex-wrap gap-2 justify-between items-center text-white">
                                        <h2 className="font-bold flex items-center gap-2"><Calendar size={20} className="text-[#00ff55]"/> PARTIDOS</h2>
                                        <div className="flex gap-2 w-full sm:w-auto">
                                            {/* FIX: Clases .app-select para alto contraste */}
                                            <select className="app-select" onChange={e => setFormatFilter(e.target.value)}><option value="Todos">Fmt: Todos</option><option value="F5">F5</option><option value="F7">F7</option><option value="F9">F9</option><option value="F11">F11</option></select>
                                            <select className="app-select" onChange={e => setZoneFilter(e.target.value)}><option value="Todas">Zonas: Todas</option><ZoneSelectOptions/></select>
                                        </div>
                                    </div>
                                    <div className="bg-[#dce6dc] rounded-b-lg overflow-hidden text-gray-800 min-h-[200px]">
                                        
                                        {loading ? <div className="p-8 text-center text-gray-500">Cargando la cancha...</div> : 
                                         feedMatches.map(m => {
                                            const isSigned = m.playersSigned?.includes(user?.uid);
                                            const pendingInvitation = invitations.find(i => i.fromUserId === user?.uid && i.matchId === m.id && i.status === 'pending');
                                            const isPending = !!pendingInvitation;
                                            
                                            // NUEVO: CONTADOR VISIBLE PARA TODOS
                                            const appCount = m.applicationsCount || 0;
                                            // ESTILO PREMIUM
                                            const premiumClass = m.isPromoted ? 'premium-border' : 'border-gray-300';
                                            const bgClass = m.isPromoted ? 'bg-gray-900' : 'bg-white hover:bg-gray-50';
                                            const textClass = m.isPromoted ? 'text-white' : 'text-black';
                                            const subTextClass = m.isPromoted ? 'text-gray-400' : 'text-gray-600';

                                            return (
                                                <div key={m.id} className={`p-3 border-b flex justify-between items-center ${premiumClass} ${bgClass}`}>
                                                    <div>
                                                        <div className={`font-bold text-sm flex items-center gap-2 ${textClass}`}>
                                                            {m.teamName} 
                                                            <span className="bg-black text-[#00ff55] text-[9px] px-1 rounded">{m.format}</span>
                                                            {m.isPromoted && <span className="premium-badge"><Sparkles size={8}/> DESTACADO</span>}
                                                            {m.isChallenge && <span className="text-[9px] bg-yellow-400 text-black px-1 rounded font-black flex gap-1"><Trophy size={8}/> DESAFÍO</span>}
                                                            {m.gender && <span className="text-[9px] bg-gray-200 text-black px-1 rounded">{m.gender}</span>}
                                                        </div>
                                                        <div className={`text-xs flex items-center gap-1 mt-1 ${subTextClass}`}><MapPin size={10}/> {m.place} | {m.zone}</div>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <div className="text-xs font-mono font-bold text-green-600">{m.date === today ? 'HOY' : m.date} - {m.time}</div>
                                                            <span className={`text-[9px] px-1 rounded ${m.isPromoted ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>{m.level}</span>
                                                        </div>
                                                        {m.isChallenge && <div className="text-[10px] text-yellow-600 font-bold mt-1">🔥 {m.stake}</div>}
                                                        
                                                        {/* NUEVO: CONTADOR DE POSTULACIONES (VISIBLE PARA TODOS) */}
                                                        {appCount > 0 && (
                                                            <div className="text-[10px] text-blue-500 font-bold mt-1 flex items-center gap-1">
                                                                <Inbox size={10}/> {appCount} Postulaciones
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {(isAdmin || (user && m.createdBy === user.uid)) && <button onClick={() => { askConfirmation("¿Borrar?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id))) }} className="text-red-500 bg-red-100 p-1.5 rounded"><Trash2 size={14}/></button>}
                                                        <button 
                                                            onClick={() => {
                                                                if (isSigned) handleApplyMatch(m); 
                                                                else if (isPending) handleCancelRequest(pendingInvitation.id, m.id); 
                                                                else handleApplyMatch(m);
                                                            }}
                                                            className={`px-3 py-1.5 rounded text-xs font-bold border-b-2 transition-all active:scale-95 ${
                                                                isSigned ? 'bg-red-600 text-white border-red-800 hover:bg-red-700' : 
                                                                isPending ? 'bg-yellow-500 text-black border-yellow-600 hover:bg-yellow-400' :
                                                                'bg-[#008f45] text-white border-[#006400] hover:bg-[#007a3b]'
                                                            }`}
                                                        >
                                                            {isSigned ? 'Salir' : isPending ? 'CANCELAR SOLICITUD' : 'ENVIAR SOLICITUD'}
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                         })}
                                    </div>
                                </div>
                                <div className="lg:col-span-4 space-y-4">
                                    <div className="bg-[#212121] text-white px-4 py-3 rounded-t-lg border-t-4 border-[#00ff55] font-bold text-sm flex items-center gap-2"><Users size={16} className="text-[#00ff55]"/> AGENTES LIBRES</div>
                                    <div className="bg-[#dce6dc] border border-gray-600 rounded-b-lg shadow-md p-2 space-y-2">
                                        {players.map(p => {
                                            const posLower = p.position.toLowerCase();
                                            let posAbbr = "POL";
                                            let posColor = "bg-green-600";
                                            if (posLower.includes('arquero')) { posAbbr = "ARQ"; posColor = "bg-orange-500"; }
                                            else if (posLower.includes('defensor')) { posAbbr = "DEF"; }
                                            else if (posLower.includes('medio') || posLower.includes('volante')) { posAbbr = "VOL"; }
                                            else if (posLower.includes('delantero') || posLower.includes('9')) { posAbbr = "DEL"; }

                                            // Estilo Premium Jugador
                                            const premiumStyle = p.isPromoted ? 'border-2 border-yellow-400 shadow-[0_0_10px_rgba(251,191,36,0.2)]' : 'border border-gray-300';
                                            const nameStyle = p.isPromoted ? 'text-black' : 'text-gray-700';

                                            return (
                                                <div key={p.id} className={`bg-white p-2 rounded shadow-sm flex justify-between items-center ${premiumStyle}`}>
                                                    <div className="flex items-center">
                                                        <div className={`w-8 h-8 ${posColor} flex items-center justify-center font-bold text-white rounded mr-3 shadow-sm text-[10px]`}>{posAbbr}</div>
                                                        <div>
                                                            <div className={`font-bold text-xs uppercase flex items-center gap-2 ${nameStyle}`}>
                                                                {p.name}
                                                                {p.isPromoted && <span className="text-[8px] bg-yellow-400 text-black px-1 rounded font-black">★ DESTADACO</span>}
                                                            </div>
                                                            <div className="mt-0.5"><StarRating rating={p.rating} /></div>
                                                            <div className="text-[10px] text-gray-500 mt-0.5">{p.position} | {p.level} | {p.gender}</div>
                                                        </div>
                                                    </div>
                                                    {(isAdmin || (user && p.uid === user.uid)) ? (
                                                        <button onClick={() => { askConfirmation("¿Borrar?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', p.id))) }} className="text-red-500 text-[10px] font-bold border border-red-200 px-2 py-1 rounded hover:bg-red-50">BAJARME</button>
                                                    ) : (
                                                        <button onClick={() => openInviteModal(p)} className="text-[#00ff55] text-xs border border-[#00ff55] px-2 py-1 rounded hover:bg-[#00ff55] hover:text-black font-bold">FICHAR</button>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        <div className="mt-2 pt-2 border-t border-gray-300">
                                            {/* FIX: Reorganización de inputs para evitar desbordamiento y mejor contraste */}
                                            <div className="space-y-2 mb-2">
                                                <div className="flex gap-2">
                                                    <select className="app-select flex-1" value={postulationPosition} onChange={e=>setPostulationPosition(e.target.value)}>
                                                        {POSITIONS_LIST.map(pos => <option key={pos} value={pos}>{pos}</option>)}
                                                    </select>
                                                    <select className="app-select flex-1" value={playerPostulationGender} onChange={e=>setPlayerPostulationGender(e.target.value)}>
                                                        {MATCH_GENDERS.map(g => <option key={g} value={g}>{g}</option>)}
                                                    </select>
                                                </div>
                                                <select className="app-select w-full" value={playerPostulationLevel} onChange={e=>setPlayerPostulationLevel(e.target.value)}>
                                                    {MATCH_LEVELS.map(l=><option key={l} value={l}>{l}</option>)}
                                                </select>
                                            </div>

                                            {userProfile?.isPromoted && (
                                                <div className="text-[10px] text-yellow-500 font-bold mb-2 flex items-center gap-1">
                                                     <Sparkles size={10}/> Tu postulación se destacará automáticamente (Premium)
                                                </div>
                                         )}
                                            <button onClick={handleJoinAsPlayer} className="w-full bg-[#212121] text-[#00ff55] font-bold text-xs py-2 rounded uppercase border border-gray-600 hover:border-[#00ff55]">Postularme</button>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {/* VISTAS EXTRAS: TEAM, PROFILE... (Mantenidas igual) */}
                        {view === 'team' && (
                            <div className="lg:col-span-12">
                                <div className="bg-[#1a1a1a] p-4 rounded text-white text-center">
                                    <h2 className="text-2xl font-black italic text-[#00ff55] mb-4">MI EQUIPO</h2>
                                    {myTeam ? (
                                        <div>
                                            {/* Cabecera del Equipo con LOGO EDITABLE */}
                                            <div className="flex items-center justify-center gap-3 mb-6 border-b border-gray-700 pb-4 relative">
                                                 <div className="relative group w-24 h-24">
                                                     {/* FEEDBACK DE CARGA: SPINNER OVERLAY */}
                                                     {uploadingLogo && (
                                                         <div className="absolute inset-0 bg-black/70 rounded-full flex items-center justify-center z-40">
                                                             <svg className="w-8 h-8 text-[#00ff55] animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                                                         </div>
                                                     )}
                                                     
                                                     {myTeam.logoUrl ? (
                                                         <img src={myTeam.logoUrl} alt="Logo" className="w-full h-full rounded-full object-cover border-4 border-[#00ff55] shadow-lg"/>
                                                     ) : (
                                                         <div className="w-full h-full rounded-full bg-gray-700 flex items-center justify-center border-4 border-gray-600">
                                                             <Shield size={40} className="text-gray-400"/>
                                                         </div>
                                                     )}
                                                     {/* FIX: Botón de cámara totalmente visible y "fuera" del círculo */}
                                                     {isCaptain && !uploadingLogo && (
                                                         <label className="absolute -bottom-1 -right-1 bg-[#00ff55] text-black p-2 rounded-full cursor-pointer hover:bg-white hover:scale-110 transition-all shadow-xl border-2 border-black z-50 flex items-center justify-center">
                                                             <Camera size={16} />
                                                             <input type="file" accept="image/*" className="hidden" onChange={handleUpdateTeamLogo} />
                                                         </label>
                                                     )}
                                                 </div>
                                                <div className="text-left ml-4 flex flex-col justify-center">
                                                    {/* NOMBRE DE EQUIPO EDITABLE */}
                                                    {isEditingTeamName ? (
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <input 
                                                                value={teamNameInput}
                                                                onChange={(e) => setTeamNameInput(e.target.value)}
                                                                className="app-input py-1 text-lg font-bold w-full"
                                                                placeholder="Nombre Equipo"
                                                            />
                                                            <button onClick={handleUpdateTeamName} className="text-[#00ff55]"><Save size={20}/></button>
                                                            <button onClick={() => setIsEditingTeamName(false)} className="text-red-500"><X size={20}/></button>
                                                        </div>
                                                    ) : (
                                                        <div className="flex items-center gap-2">
                                                            <div className="text-2xl font-black italic text-white uppercase tracking-tighter">{myTeam.name}</div>
                                                            {isCaptain && <button onClick={() => { setTeamNameInput(myTeam.name); setIsEditingTeamName(true); }} className="text-gray-500 hover:text-white"><Edit2 size={16}/></button>}
                                                        </div>
                                                    )}
                                                    
                                                    <div className="text-xs text-[#00ff55] font-bold bg-green-900/30 px-2 py-0.5 rounded inline-block border border-green-800 self-start">
                                                        Capitán: {myTeam.captainName}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Botonera de Acciones Rápidas */}
                                            <div className="grid grid-cols-3 gap-2 mb-6">
                                                <button onClick={() => setShowScoutModal(true)} className="bg-gray-800 border border-gray-600 p-2 rounded hover:bg-gray-700 flex flex-col items-center gap-1">
                                                    <Search size={18} className="text-[#00ff55]"/>
                                                    <span className="text-[9px] font-bold uppercase">Fichar</span>
                                                </button>
                                                <button onClick={() => setView('app')} className="bg-gray-800 border border-gray-600 p-2 rounded hover:bg-gray-700 flex flex-col items-center gap-1">
                                                    <Swords size={18} className="text-yellow-500"/>
                                                    <span className="text-[9px] font-bold uppercase">Buscar Rival</span>
                                                </button>
                                                <button onClick={() => { setPublishData({...publishData, type: 'rival'}); setShowPublishModal(true); }} className="bg-[#00ff55] text-black border border-[#00cc44] p-2 rounded hover:bg-white flex flex-col items-center gap-1 shadow-[0_0_10px_rgba(0,255,85,0.2)]">
                                                    <Trophy size={18} />
                                                    <span className="text-[9px] font-black uppercase">Publicar</span>
                                                </button>
                                            </div>
                                            
                                            {/* Lista de Miembros (Restaurada) */}
                                            <div className="space-y-2 mb-6 text-left">
                                                <h4 className="text-xs font-bold text-gray-500 uppercase mb-2 pl-1">Plantel</h4>
                                                {myTeam.members?.map(m => (
                                                    <div key={m.uid} className={`flex justify-between items-center p-3 rounded border transition-all ${m.status === 'injured' ? 'border-red-900/50 bg-red-900/10' : 'border-gray-700 bg-gray-800/50 hover:bg-gray-800'}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-white text-xs border border-gray-500">{m.name.charAt(0)}</div>
                                                            <div>
                                                                <div className="text-gray-200 text-sm font-bold flex items-center gap-2">
                                                                    {m.name} 
                                                                    {m.role === 'captain' && <Crown size={12} className="text-yellow-500"/>}
                                                                </div>
                                                                <div className={`text-[10px] font-bold uppercase ${m.status === 'injured' ? 'text-red-500' : 'text-green-500'}`}>
                                                                    {m.status === 'injured' ? 'Baja Temporal' : 'Disponible'}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {(isCaptain || user.uid === m.uid) && (
                                                            <button onClick={() => handleToggleMemberStatus(m.uid, m.status)} className={`flex items-center gap-1 px-3 py-1.5 rounded text-[10px] font-bold border transition-colors ${m.status === 'active' ? 'border-red-900 text-red-400 hover:bg-red-900/20' : 'border-green-900 text-green-400 hover:bg-green-900/20'}`}>
                                                                {m.status === 'active' ? <><UserX size={12}/> Marcar Baja</> : <><UserCheck size={12}/> Estoy Listo</>}
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Zona de Peligro */}
                                            <div className="border-t border-gray-800 pt-4 mt-8">
                                                {isCaptain ? (
                                                    <button onClick={handleDeleteTeam} className="text-red-500 text-xs font-bold border border-red-900/50 bg-red-900/10 px-4 py-2 rounded hover:bg-red-900/30 w-full flex items-center justify-center gap-2">
                                                        <AlertTriangle size={14}/> DISOLVER EQUIPO
                                                    </button>
                                                ) : (
                                                    <button onClick={handleLeaveTeam} className="text-red-400 text-xs font-bold border border-red-900/30 px-4 py-2 rounded hover:bg-red-900/20 w-full">
                                                        Abandonar Equipo
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12">
                                            <Shield size={64} className="mx-auto text-gray-700 mb-6 opacity-50"/>
                                            <h3 className="text-2xl font-black text-white italic mb-2">SIN EQUIPO</h3>
                                            <p className="text-gray-400 text-sm mb-8 max-w-xs mx-auto">Crea tu propio equipo para gestionar tu plantel o busca uno existente.</p>
                                            
                                            <div className="flex flex-col gap-3 max-w-xs mx-auto">
                                                <button onClick={() => setShowCreateTeamModal(true)} className="bg-[#00ff55] text-black font-black px-6 py-4 rounded-lg shadow-[0_0_20px_rgba(0,255,85,0.3)] hover:scale-105 transition-transform flex items-center justify-center gap-2 uppercase tracking-wider">
                                                    <PlusCircle size={20}/> Crear Equipo
                                                </button>
                                                <button onClick={() => setShowTeamSearchModal(true)} className="bg-gray-800 text-white font-bold px-6 py-4 rounded-lg border border-gray-600 hover:bg-gray-700 transition-colors flex items-center justify-center gap-2 uppercase tracking-wider">
                                                    <Search size={20}/> Buscar Equipo
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {view === 'profile' && (
                            <div className="lg:col-span-12">
                                {/* FIX: Fondo de tarjeta de perfil más claro para contraste con el body negro */}
                                <div className="bg-gray-800 p-6 rounded flex items-center gap-4">
                                    {user?.photoURL ? (
                                        <img src={user.photoURL} alt="Perfil" className="w-20 h-20 rounded-full object-cover border-2 border-[#00ff55]" />
                                    ) : (
                                        <div className="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center text-4xl">👤</div>
                                    )}
                                    <div className="flex-1">
                                        {isEditingNickname ? (
                                            <div className="space-y-2 mb-2">
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        value={nicknameInput} 
                                                        onChange={e=>setNicknameInput(e.target.value)} 
                                                        className="app-input rounded px-2 py-1 text-lg font-bold w-full"
                                                        placeholder="Apodo"
                                                    />
                                                    <button onClick={handleUpdateNickname} className="text-[#00ff55]"><Save size={20}/></button>
                                                    <button onClick={() => setIsEditingNickname(false)} className="text-red-500"><X size={20}/></button>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] text-gray-400 font-bold uppercase ml-1">Fecha Nacimiento</label>
                                                    <input 
                                                        type="date"
                                                        value={birthDateInput} 
                                                        onChange={e=>setBirthDateInput(e.target.value)} 
                                                        className="app-input rounded px-2 py-1 text-xs w-full"
                                                    />
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col">
                                                <div className="flex items-center gap-2">
                                                    <div className="text-2xl font-black text-white italic">{userProfile?.nickname || user?.displayName}</div>
                                                    <button onClick={() => { 
                                                        setNicknameInput(userProfile?.nickname || user?.displayName); 
                                                        setBirthDateInput(userProfile?.birthDate || ''); 
                                                        setIsEditingNickname(true); 
                                                    }} className="text-gray-500 hover:text-white"><Edit2 size={16}/></button>
                                                </div>
                                                
                                                <div className="text-gray-400 text-xs mb-1 flex items-center gap-2">
                                                    {user?.email}
                                                    {userProfile?.birthDate && (
                                                        <span className="bg-gray-700 text-white px-2 py-0.5 rounded text-[10px] font-bold border border-gray-600">
                                                            {calculateAge(userProfile.birthDate)} Años
                                                        </span>
                                                    )}
                                                </div>
                                                
                                                {isEditingPosition ? (
                                                    <div className="flex items-center gap-2">
                                                        <select 
                                                            value={userProfile?.position} 
                                                            onChange={(e) => handleUpdatePosition(e.target.value)}
                                                            className="app-select rounded px-1 text-xs"
                                                        >
                                                            {POSITIONS_LIST.map(pos => <option key={pos} value={pos}>{pos}</option>)}
                                                        </select>
                                                        <button onClick={() => setIsEditingPosition(false)} className="text-red-500"><X size={14}/></button>
                                                    </div>
                                                ) : (
                                                     <div className="flex items-center gap-2 text-[#00ff55] text-xs font-bold bg-green-900/30 px-2 py-0.5 rounded border border-green-800 self-start">
                                                        {userProfile?.position || "Polifuncional"}
                                                        <button onClick={() => setIsEditingPosition(true)} className="text-gray-400 hover:text-white"><Edit2 size={10}/></button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        <div className="text-[#00ff55] font-bold mt-1">★ {userRating.toFixed(1)} <span className="text-gray-500 text-xs">({userRatingCount})</span></div>
                                    </div>
                                    {isAdmin && (
                                        <button 
                                            onClick={() => setView('admin')} 
                                            className="bg-red-900/50 border border-red-500 text-white text-[10px] font-bold p-2 rounded flex flex-col items-center hover:bg-red-900 transition-colors"
                                        >
                                            <Shield size={16} className="mb-1"/> ADMIN
                                        </button>
                                    )}
                                </div>

                                <div className="grid grid-cols-2 gap-4 mt-6 text-left">
                                    <div className="bg-gray-800 p-3 rounded border border-gray-700">
                                        <div className="text-xs text-gray-400 uppercase">Partidos Creados</div>
                                        <div className="text-xl font-bold text-[#00ff55]">{myFullHistoryMatches.length}</div>
                                    </div>
                                    <div className="bg-gray-800 p-3 rounded border border-gray-700">
                                        <div className="text-xs text-gray-400 uppercase">Partidos Jugados</div>
                                        <div className="text-xl font-bold text-white">{playedCount}</div>
                                    </div>
                                    <div className="bg-gray-800 p-3 rounded border border-gray-700 col-span-2">
                                        <div className="text-xs text-gray-400 uppercase">Mi Equipo</div>
                                        <div className="font-bold text-white flex items-center gap-2">
                                            {myTeam ? (
                                                <>
                                                    <Shield size={16} className="text-[#00ff55]"/>
                                                    {myTeam.name}
                                                    <span className="text-[10px] bg-gray-700 px-2 py-0.5 rounded border border-gray-600">
                                                        {isCaptain ? 'Capitán' : 'Jugador'}
                                                    </span>
                                                </>
                                            ) : "Agente Libre"}
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-4">
                                    {!historyEnabled ? (
                                        <div className="text-center p-4">
                                            <p className="text-gray-400 text-xs mb-2">Para ahorrar datos, el historial antiguo no se carga automáticamente.</p>
                                            <button onClick={() => setHistoryEnabled(true)} className="bg-[#00ff55] text-black font-bold px-4 py-2 rounded">
                                                📥 CARGAR HISTORIAL COMPLETO
                                            </button>
                                        </div>
                                    ) : (
                                        <>
                                        <button 
                                            onClick={() => setShowStatsDetails(!showStatsDetails)} 
                                            className="w-full flex items-center justify-between bg-gray-800 p-3 rounded border border-gray-700 text-white font-bold text-sm hover:bg-gray-700 transition-colors"
                                        >
                                            <span>VER HISTORIAL COMPLETO</span>
                                            {showStatsDetails ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                                        </button>

                                        {showStatsDetails && (
                                            <div className="mt-2 bg-[#1a1a1a] border border-gray-800 rounded p-3 text-left space-y-4 modal-animate">
                                                <p className="text-[10px] text-gray-500 italic text-center">Mostrando todo tu historial</p>
                                                <div>
                                                    <h4 className="text-[#00ff55] text-xs font-black uppercase mb-2 border-b border-gray-800 pb-1">Organizados por mí ({myFullHistoryMatches.length})</h4>
                                                    {myFullHistoryMatches.length > 0 ? (
                                                        <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                                            {myFullHistoryMatches.map(m => (
                                                                <div key={m.id} className="text-xs text-gray-300 bg-gray-900 p-2 rounded flex justify-between items-center border-l-2 border-[#00ff55]">
                                                                    <div>
                                                                        <div className="font-bold text-white">{m.teamName}</div>
                                                                        <div className="text-[10px] text-gray-500">{m.date} {m.time} | {m.place}</div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <span className="block bg-gray-800 px-1.5 py-0.5 rounded text-[9px] mb-1">{m.format}</span>
                                                                        <button onClick={() => handleDeleteMatch(m.id)} className="text-red-500 hover:text-white p-1"><Trash2 size={12}/></button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <p className="text-gray-600 text-xs italic">Aún no has organizado partidos.</p>
                                                    )}
                                                </div>

                                                <div>
                                                    <h4 className="text-white text-xs font-black uppercase mb-2 border-b border-gray-800 pb-1">Partidos donde juego ({myFullJoinedMatches.length})</h4>
                                                    {myFullJoinedMatches.length > 0 ? (
                                                        <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                                            {myFullJoinedMatches.map(m => (
                                                                <div key={m.id} className="text-xs text-gray-300 bg-gray-900 p-2 rounded flex justify-between items-center border-l-2 border-blue-500">
                                                                    <div>
                                                                        <span className="text-white font-bold">{m.teamName}</span>
                                                                        <div className="text-gray-500">{m.date} {m.time} | {m.place}</div>
                                                                    </div>
                                                                    <span className="bg-gray-800 px-2 py-0.5 rounded text-[9px]">{m.format}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <p className="text-gray-600 text-xs italic">Aún no te has anotado en partidos.</p>
                                                    )}
                                                </div>

                                                <div>
                                                    <h4 className="text-white text-xs font-black uppercase mb-2 border-b border-gray-800 pb-1">Mis Postulaciones ({myPostulations.length})</h4>
                                                    {myPostulations.length > 0 ? (
                                                        <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                                            {myPostulations.map(p => (
                                                                <div key={p.id} className="text-xs text-gray-300 bg-gray-900 p-2 rounded flex justify-between items-center border-l-2 border-yellow-500">
                                                                    <div>
                                                                        <span className="text-white font-bold">{p.position}</span>
                                                                        <div className="text-gray-500">Zona: {p.zone}</div>
                                                                    </div>
                                                                    <button onClick={() => handleDeletePlayer(p.id)} className="text-red-500 hover:text-white"><Trash2 size={14}/></button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <p className="text-gray-600 text-xs italic">No estás postulado como libre.</p>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        </>
                                    )}
                                </div>

                                <button onClick={handleLogout} className="mt-8 w-full bg-red-900/30 text-red-500 py-3 rounded font-bold border border-red-900/50 hover:bg-red-900/50 transition-colors">CERRAR SESIÓN</button>
                            </div>
                        )}
                    </main>

                    {/* FOOTER INFERIOR (VISIBLE SIEMPRE) */}
                    {view !== 'landing' && (
                        <div className="fixed bottom-0 left-0 w-full bg-[#000000] border-t-2 border-[#00ff55] flex justify-around items-center h-20 pb-2 z-[9999] shadow-[0_-5px_20px_rgba(0,0,0,0.8)]">
                            <button onClick={() => setView('app')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${view === 'app' ? 'text-[#00ff55]' : 'text-gray-500'}`}>
                                <Home size={24} className={view === 'app' ? "fill-current" : ""}/> 
                                <span className="text-[10px] font-bold uppercase">Inicio</span>
                            </button>
                            <button onClick={() => user ? setView('team') : setShowLoginModal(true)} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${view === 'team' ? 'text-[#00ff55]' : 'text-gray-500'}`}>
                                <Shield size={24} className={view === 'team' ? "fill-current" : ""}/> 
                                <span className="text-[10px] font-bold uppercase">Mi Equipo</span>
                            </button>
                            <button onClick={() => user ? setView('profile') : setShowLoginModal(true)} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${view === 'profile' ? 'text-[#00ff55]' : 'text-gray-500'}`}>
                                <User size={24} className={view === 'profile' ? "fill-current" : ""}/> 
                                <span className="text-[10px] font-bold uppercase">Perfil</span>
                            </button>
                        </div>
                    )}
                    
                    {/* MODALES VARIOS (Login, Publish, etc.) se mantienen igual en estructura */}
                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-xs text-center border border-[#00ff55]">
                                <h3 className="text-white font-bold mb-4 text-lg">ACCESO REQUERIDO</h3>
                                <button onClick={handleGoogleLogin} className="w-full bg-white hover:bg-gray-100 text-black font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all active:scale-95 border border-gray-200">
                                    <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.17c-.22-.66-.35-1.36-.35-2.17s.13-1.51.35-2.17V7.61H2.18C.79 10.37.79 13.63 2.18 16.39l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.05l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                    Ingresar con Google
                                </button>
                                <button onClick={() => setShowLoginModal(false)} className="text-gray-500 text-xs mt-4">Cancelar</button>
                            </div>
                        </div>
                    )}
                    
                    {/* MODAL PUBLICAR (Simplificado para el ejemplo) */}
                    {showPublishModal && (
                         <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-4">
                             <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-sm text-white border border-[#00ff55]">
                                 <h3 className="text-[#00ff55] font-black italic text-xl mb-4 text-center">PUBLICAR PARTIDO</h3>
                                 <form onSubmit={handlePublishMatch} className="space-y-3">
                                     {/* ... inputs del form ... */}
                                     <div className="flex gap-2"><button type="button" onClick={() => setPublishData({...publishData, type: 'rival'})} className={`flex-1 py-1 rounded text-xs font-bold ${publishData.type==='rival'?'bg-[#00ff55] text-black':'bg-gray-800'}`}>RIVAL</button><button type="button" onClick={() => setPublishData({...publishData, type: 'player'})} className={`flex-1 py-1 rounded text-xs font-bold ${publishData.type==='player'?'bg-[#00ff55] text-black':'bg-gray-800'}`}>JUGADOR</button></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1"><label className="text-gray-400 text-xs font-bold ml-1">Formato</label><select value={publishData.format} onChange={(e) => setPublishData({...publishData, format: e.target.value})} className="app-select"><option>F5</option><option>F7</option><option>F9</option><option>F11</option></select></div>
                                        <div className="space-y-1"><label className="text-gray-400 text-xs font-bold ml-1">Zona</label><select value={publishData.zone} onChange={(e) => setPublishData({...publishData, zone: e.target.value})} className="app-select"><ZoneSelectOptions /></select></div>
                                    </div>
                                    
                                    {/* SELECCIÓN DE NIVEL */}
                                    <div className="space-y-1">
                                        <label className="text-gray-400 text-xs font-bold ml-1">Nivel / Intensidad</label>
                                        <select value={publishData.level} onChange={(e) => setPublishData({...publishData, level: e.target.value})} className="app-select">
                                            {MATCH_LEVELS.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>

                                    {/* OPCIONES DE RIVAL (DESAFÍO) */}
                                    {publishData.type === 'rival' && (
                                        <div className="bg-gray-800/50 p-2 rounded border border-dashed border-gray-600 space-y-2">
                                            <div className="flex gap-2">
                                                <button type="button" onClick={() => setPublishData({...publishData, isChallenge: false})} className={`flex-1 py-1.5 text-xs font-bold rounded border ${!publishData.isChallenge ? 'bg-gray-700 text-white border-gray-500' : 'bg-transparent text-gray-500 border-transparent'}`}>Amistoso</button>
                                                <button type="button" onClick={() => setPublishData({...publishData, isChallenge: true})} className={`flex-1 py-1.5 text-xs font-bold rounded border ${publishData.isChallenge ? 'bg-yellow-600 text-black border-yellow-500' : 'bg-transparent text-gray-500 border-transparent'}`}>🏆 DESAFÍO</button>
                                            </div>
                                            {publishData.isChallenge && (
                                                <input placeholder="¿Qué se juega? (Ej: La cancha, $1000 c/u)" className="app-input" value={publishData.stake} onChange={e=>setPublishData({...publishData, stake:e.target.value})} required/>
                                            )}
                                        </div>
                                    )}

                                    {/* NUEVO: SELECCIÓN DE GÉNERO EN PUBLICAR PARTIDO (Faltaba aquí) */}
                                    <div className="space-y-1">
                                        <label className="text-gray-400 text-xs font-bold ml-1">Género</label>
                                        <select value={publishData.gender} onChange={(e) => setPublishData({...publishData, gender: e.target.value})} className="app-select">
                                            {MATCH_GENDERS.map(g => <option key={g} value={g}>{g}</option>)}
                                        </select>
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-gray-400 text-xs font-bold ml-1">Fecha (Máx: 1 Semana)</label>
                                        <input 
                                            type="date" 
                                            className="app-input" 
                                            value={publishData.date} 
                                            min={today}
                                            max={maxPublishDate}
                                            onChange={e=>setPublishData({...publishData, date:e.target.value})} 
                                            required
                                        />
                                    </div>
                                    <input placeholder="Cancha" className="app-input" value={publishData.place} onChange={e=>setPublishData({...publishData, place:e.target.value})} required/>
                                    <input type="time" className="app-input" value={publishData.time} onChange={e=>setPublishData({...publishData, time:e.target.value})} required/>
                                    
                                    {publishData.type === 'player' && (
                                        <div className="space-y-2 p-3 bg-gray-800/50 rounded border border-dashed border-gray-600">
                                            <label className="text-gray-400 text-xs font-bold">Posiciones Necesarias</label>
                                            {neededPositions.map((pos, index) => (
                                                <div key={index} className="flex gap-2">
                                                    <select value={pos} onChange={(e) => handleSlotChange(index, e.target.value)} className="app-select flex-1"><option>Cualquiera</option><option>Arquero</option><option>Defensor</option><option>Medio</option><option>Delantero</option></select>
                                                    {neededPositions.length > 1 && (<button type="button" onClick={() => handleRemoveSlot(index)} className="text-red-500 hover:text-white"><MinusCircle size={18}/></button>)}
                                                </div>
                                            ))}
                                            <button type="button" onClick={handleAddSlot} className="w-full text-[#00ff55] text-xs font-bold py-1 border border-[#00ff55]/30 rounded hover:bg-[#00ff55]/10">+ Agregar Jugador</button>
                                        </div>
                                    )}
                                     <div className="flex gap-2">
                                         <button type="button" onClick={() => setShowPublishModal(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancelar</button>
                                         <button 
                                            type="submit" 
                                            disabled={submitting}
                                            className={`flex-1 py-3 bg-[#00ff55] text-black font-black rounded hover:bg-white transition-all transform active:scale-95 ${submitting ? 'opacity-50 cursor-not-allowed' : ''}`}
                                         >
                                            {submitting ? 'PUBLICANDO...' : 'CONFIRMAR'}
                                         </button>
                                     </div>
                                 </form>
                             </div>
                          </div>
                    )}
                    
                    {/* MODALES ADICIONALES RESTAURADOS PARA QUE FUNCIONEN LOS BOTONES */}
                    {showCreateTeamModal && (
                        <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-sm text-white border border-[#00ff55]">
                                <h3 className="text-[#00ff55] font-black italic text-xl mb-4 text-center">CREAR EQUIPO</h3>
                                <form onSubmit={handleCreateTeam} className="space-y-4">
                                    <div>
                                        <label className="text-gray-400 text-xs font-bold block mb-1">Nombre del Equipo</label>
                                        <input type="text" value={newTeamName} onChange={(e) => setNewTeamName(e.target.value)} className="app-input" placeholder="Ej: Los Rotos FC" required />
                                    </div>
                                    <div>
                                        <label className="text-gray-400 text-xs font-bold block mb-1">Escudo (Opcional)</label>
                                        <input type="file" accept="image/*" onChange={(e) => setTeamLogoFile(e.target.files[0])} className="w-full text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-[#00ff55] file:text-black hover:file:bg-[#00cc44]"/>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setShowCreateTeamModal(false)} className="flex-1 py-2 text-gray-500 font-bold text-xs">CANCELAR</button>
                                        <button type="submit" disabled={submitting} className="flex-1 py-2 bg-[#00ff55] text-black font-black rounded text-xs hover:bg-white">{submitting ? 'CREANDO...' : 'CREAR EQUIPO'}</button>
                                    </div>
                                </form>
                                 <div className="mt-4 pt-4 border-t border-gray-800 text-center">
                                    <button type="button" onClick={handleCreateDemoTeam} className="text-[10px] text-gray-500 underline">Generar Demo (Test)</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTeamSearchModal && (
                        <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-sm text-white border border-gray-600 h-[80vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-white font-bold text-lg">Buscar Equipo</h3>
                                    <button onClick={() => setShowTeamSearchModal(false)}><X size={20} className="text-gray-500"/></button>
                                </div>
                                <form onSubmit={handleSearchTeams} className="flex gap-2 mb-4">
                                    <input value={teamSearchQuery} onChange={e=>setTeamSearchQuery(e.target.value)} className="app-input flex-1" placeholder="Nombre del equipo..."/>
                                    <button type="submit" className="bg-[#00ff55] text-black p-2 rounded"><Search size={18}/></button>
                                </form>
                                <div className="flex-1 overflow-y-auto space-y-2">
                                    {teamSearchResults.map(t => (
                                        <div key={t.id} className="bg-gray-800 p-3 rounded flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                 {t.logoUrl ? <img src={t.logoUrl} className="w-8 h-8 rounded-full"/> : <Shield size={32} className="text-gray-600"/>}
                                                 <div>
                                                     <div className="font-bold text-sm">{t.name}</div>
                                                     <div className="text-[10px] text-gray-400">Capitán: {t.captainName}</div>
                                                 </div>
                                            </div>
                                            <button onClick={() => sendJoinRequest(t)} className="text-[#00ff55] text-xs border border-[#00ff55] px-2 py-1 rounded hover:bg-[#00ff55] hover:text-black">Unirme</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {showScoutModal && (
                        <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-sm text-white border border-gray-600 h-[80vh] flex flex-col">
                                 <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-white font-bold text-lg">Fichajes</h3>
                                    <button onClick={() => setShowScoutModal(false)}><X size={20} className="text-gray-500"/></button>
                                </div>
                                <form onSubmit={handleSearchUsers} className="flex gap-2 mb-4">
                                     <input value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} className="app-input flex-1" placeholder="Nombre de jugador..."/>
                                     <button type="submit" className="bg-[#00ff55] text-black p-2 rounded"><Search size={18}/></button>
                                </form>
                                 <div className="flex-1 overflow-y-auto space-y-2">
                                    {searchResults.map(u => (
                                        <div key={u.uid} className="bg-gray-800 p-3 rounded flex justify-between items-center">
                                             <div>
                                                 <div className="font-bold text-sm">{u.nickname || u.name}</div>
                                                 <div className="text-[10px] text-gray-400">{u.position}</div>
                                             </div>
                                             <button onClick={() => openInviteModal(u)} className="text-[#00ff55] text-xs border border-[#00ff55] px-2 py-1 rounded hover:bg-[#00ff55] hover:text-black">Invitar</button>
                                        </div>
                                    ))}
                                     {players.map(p => (
                                        <div key={p.id} className="bg-gray-800 p-3 rounded flex justify-between items-center border border-gray-700">
                                             <div>
                                                 <div className="font-bold text-sm text-[#00ff55]">{p.name} <span className="text-[9px] bg-[#00ff55]/20 px-1 rounded">LIBRE</span></div>
                                                 <div className="text-[10px] text-gray-400">{p.position} | {p.zone}</div>
                                             </div>
                                             <button onClick={() => openInviteModal(p)} className="text-white text-xs bg-[#00ff55]/20 border border-[#00ff55] px-2 py-1 rounded hover:bg-[#00ff55] hover:text-black">Fichar</button>
                                        </div>
                                     ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {showInviteModal && (
                        <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-sm text-white border border-[#00ff55]">
                                <h3 className="text-white font-bold text-lg mb-2">Invitar a {targetPlayer?.name}</h3>
                                <p className="text-xs text-gray-400 mb-4">Envía una propuesta formal para que se una a tu equipo.</p>
                                <form onSubmit={sendInvitation} className="space-y-3">
                                     <input value={inviteData.place} onChange={e=>setInviteData({...inviteData, place:e.target.value})} className="app-input" placeholder="Lugar / Motivo (Opcional)" />
                                     <input type="time" value={inviteData.time} onChange={e=>setInviteData({...inviteData, time:e.target.value})} className="app-input" />
                                     <div className="flex gap-2 mt-4">
                                         <button type="button" onClick={() => setShowInviteModal(false)} className="flex-1 py-2 text-gray-500 text-xs font-bold">CANCELAR</button>
                                         <button type="submit" disabled={submitting} className="flex-1 py-2 bg-[#00ff55] text-black text-xs font-black rounded hover:bg-white">ENVIAR</button>
                                     </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* MODAL MAPA - AHORA CON FILTRO OSCURO */}
                    {showMapModal && (
                        <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-2 sm:p-4">
                             <div className="bg-[#1a1a1a] p-4 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col border border-[#00ff55] shadow-2xl relative">
                                 <div className="flex justify-between items-center mb-3">
                                     <h3 className="text-[#00ff55] font-black text-xl flex items-center gap-2">
                                         <MapPin className="text-[#00ff55] fill-current" size={24}/> MAPA DE CANCHAS
                                     </h3>
                                     <button onClick={() => setShowMapModal(false)} className="bg-gray-800 p-2 rounded-full text-white hover:bg-red-600 transition-colors">
                                         <X size={20}/>
                                     </button>
                                 </div>
                                 
                                 {/* Contenedor del Mapa con Filtro Dark Mode */}
                                 <div className="flex-1 bg-gray-900 rounded-lg overflow-hidden border border-gray-700 relative">
                                     <iframe 
                                        title="Mapa de Canchas La Plata"
                                        width="100%" 
                                        height="100%" 
                                        style={{ border: 0, filter: 'grayscale(1) invert(0.9) contrast(1.2)' }}
                                        loading="lazy" 
                                        allowFullScreen 
                                        src="https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d52345.02947230634!2d-57.98909117973686!3d-34.92049409999999!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1scanchas%20de%20futbol%20la%20plata!5e0!3m2!1ses!2sar!4v1705546532832!5m2!1ses!2sar">
                                     </iframe>
                                     
                                     {/* Overlay de carga (opcional, visual) */}
                                     <div className="absolute inset-0 pointer-events-none border-4 border-[#00ff55]/20 rounded-lg"></div>
                                 </div>
                                 
                                 <div className="mt-3 flex justify-between items-center text-xs text-gray-400">
                                     <span>Mostrando canchas en La Plata y alrededores</span>
                                     <button onClick={() => setShowMapModal(false)} className="sm:hidden bg-gray-800 text-white px-4 py-2 rounded font-bold">CERRAR</button>
                                 </div>
                             </div>
                        </div>
                    )}

                    {showInstallModal && (
                        <div className="fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-4">
                             <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-sm text-center border border-[#00ff55]">
                                 <Download size={48} className="mx-auto text-[#00ff55] mb-4"/>
                                 <h3 className="text-white font-bold text-lg">Instalar App</h3>
                                 <p className="text-gray-400 text-sm mt-2">Agrega El Capitán a tu pantalla de inicio para una mejor experiencia.</p>
                                 <div className="flex gap-2 mt-6">
                                     <button onClick={() => setShowInstallModal(false)} className="flex-1 text-gray-500 text-xs font-bold">LUEGO</button>
                                     {deferredPrompt && <button onClick={handleInstallClick} className="flex-1 bg-[#00ff55] text-black py-2 rounded font-black text-xs">INSTALAR</button>}
                                 </div>
                             </div>
                        </div>
                    )}

                    {confirmation.show && (
                        <div className="fixed inset-0 bg-black/90 z-[1100] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded w-full max-w-xs text-center border border-red-500">
                                <AlertCircle size={48} className="text-red-500 mx-auto mb-4"/>
                                <h3 className="text-white font-bold mb-2">ATENCIÓN</h3>
                                <p className="text-gray-300 text-sm mb-4">{confirmation.text}</p>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setConfirmation({show:false})} className="flex-1 py-2 text-gray-400">Cancelar</button>
                                    <button onClick={() => {confirmation.action(); setConfirmation({show:false})}} className="flex-1 py-2 bg-red-600 text-white rounded font-bold">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NUEVO POP-UP DE MENSAJES (ÉXITO / ERROR / INFO) */}
                    {feedbackModal.show && (
                        <div className="fixed inset-0 bg-black/90 z-[1200] flex items-center justify-center p-4 modal-animate">
                            <div className={`bg-[#1a1a1a] p-6 rounded-xl w-full max-w-xs text-center border-2 shadow-[0_0_30px_rgba(0,0,0,0.5)] ${
                                feedbackModal.type === 'error' ? 'border-red-500' : 
                                feedbackModal.type === 'info' ? 'border-blue-500' : 'border-[#00ff55]'
                            }`}>
                                {feedbackModal.type === 'error' ? <AlertCircle size={56} className="text-red-500 mx-auto mb-4 animate-bounce"/> :
                                 feedbackModal.type === 'info' ? <Info size={56} className="text-blue-500 mx-auto mb-4 animate-pulse"/> :
                                 <CheckCircle size={56} className="text-[#00ff55] mx-auto mb-4 animate-bounce"/>}
                                
                                <h3 className={`font-black text-xl italic mb-2 ${
                                    feedbackModal.type === 'error' ? 'text-red-500' : 
                                    feedbackModal.type === 'info' ? 'text-blue-500' : 'text-white'
                                }`}>{feedbackModal.title}</h3>
                                
                                <p className="text-gray-300 text-sm mb-6">{feedbackModal.message}</p>
                                
                                <button 
                                    onClick={() => setFeedbackModal({ ...feedbackModal, show: false })} 
                                    className={`w-full font-black py-3 rounded-lg transition-colors uppercase tracking-widest ${
                                        feedbackModal.type === 'error' ? 'bg-red-600 text-white hover:bg-red-500' : 
                                        feedbackModal.type === 'info' ? 'bg-blue-600 text-white hover:bg-blue-500' : 'bg-[#00ff55] text-black hover:bg-white'
                                    }`}
                                >
                                    ENTENDIDO
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
