<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>El Capitán - Fútbol Amateur</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#00ff55">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="El Capitán">
    <link rel="apple-touch-icon" id="apple-icon">
    <link rel="icon" type="image/png" id="favicon">
    <link rel="manifest" id="manifest-placeholder">

    <!-- CONFIGURACIÓN DE ÍCONOS REALES -->
    <script>
        (function() {
            // ⚠️ IMPORTANTE: Pega aquí el link de tu imagen JPG nueva
            // Agregamos '?v=3' al final para obligar al celular a actualizar la imagen sí o sí
            const iconUrl = "https://i.imgur.com/l2fbNNt.jpeg"; 
            
            document.getElementById('apple-icon').href = iconUrl;
            document.getElementById('favicon').href = iconUrl;
            
            const manifest = {
                "name": "El Capitán",
                "short_name": "El Capitán",
                "start_url": ".",
                "display": "standalone",
                
                // ✅ AQUÍ ESTÁ EL COLOR EXACTO DE TU PHOTOSHOP
                "background_color": "#00281d", 
                
                "theme_color": "#00ff55",
                "orientation": "portrait",
                "icons": [
                    { "src": iconUrl, "sizes": "192x192", "type": "image/png" },
                    { "src": iconUrl, "sizes": "512x512", "type": "image/png" }
                ]
            };
            
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos base -->
    <style>
        body { background-color: #121212; color: #e5e7eb; font-family: sans-serif; padding-bottom: 100px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #00ff55; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #root { min-height: 100vh; display: flex; flex-direction: column; }
        #error-display { display: none; padding: 20px; color: #ff6b6b; background: #2d1b1b; text-align: center; }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Animación para elementos destacados (Premium) */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .premium-border {
            position: relative;
            border: 2px solid #fbbf24; /* Dorado */
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        .premium-badge {
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);
            background-size: 200% 100%;
            animation: shimmer 3s infinite linear;
            color: black;
            font-weight: 900;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        /* FIX PARA CALENDARIO Y RELOJ EN WEB (PC) */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.8;
        }
        ::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        /* --- ESTILOS DE INPUTS Y SELECTS UNIFICADOS (FIX VISUAL) --- */
        .app-input, .app-select {
            background-color: #1f2937; /* Gris oscuro sólido, no transparente */
            color: #ffffff; /* Texto blanco brillante */
            border: 1px solid #374151; /* Borde gris medio */
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            appearance: none; /* Limpia estilos nativos del celular */
        }
        
        .app-input:focus, .app-select:focus {
            border-color: #00ff55; /* Borde verde al tocar */
            background-color: #111827;
        }

        /* Fix para las opciones del select en móviles */
        .app-select option {
            background-color: #1f2937;
            color: white;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root">
        <div class="flex-1 flex items-center justify-center text-[#00ff55] animate-pulse">
            <svg class="w-10 h-10 animate-spin mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
            Cargando El Capitán...
        </div>
    </div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Users, MapPin, Calendar, Shield, Search, PlusCircle, AlertCircle, 
            ChevronRight, ChevronDown, ChevronUp, Swords, Star, Menu, X, Filter, 
            Link as LinkIcon, User, LogOut, Mail, Lock, Trash2, Ban, Trophy, 
            Activity, ArrowLeft, HelpCircle, FileText, Lock as LockIcon, Bell, 
            CheckCircle, XCircle, Send, Crown, UserPlus, Share2, Edit2, Save, MinusCircle,
            Home, Zap, ClipboardList, AlertTriangle, Download, UserCheck, UserX, Clock, MessageCircle, Beer, Flame, Banknote, Image as ImageIcon, Camera, Info, Check, Inbox, Sparkles, BarChart2, Filter as FilterIcon, PieChart, TrendingUp
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            signInAnonymously, signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
           getFirestore, collection, query, onSnapshot, doc, updateDoc, increment, 
           arrayUnion, arrayRemove, addDoc, serverTimestamp, deleteDoc, where, 
           orderBy, getDoc, setDoc, getDocs, Timestamp, enableIndexedDbPersistence 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // --- DEFINICIONES GLOBALES ---
        const appId = 'el-capitan-web';
        const ADMIN_EMAILS = ["worlddigital2011@gmail.com", "admin@elenganche.com", "eyamilgimenez98@gmail.com"];
        
        const ZONES_BY_AREA = {
            "Casco Urbano": ["La Plata (Casco Urbano)"],
            "Zona Norte": ["Arturo Seguí", "Villa Elisa", "City Bell", "Manuel B. Gonnet", "Ringuelet", "Tolosa", "Villa Castells", "Joaquín Gorina", "José Hernández"],
            "Zona Oeste": ["San Carlos", "Los Hornos", "Lisandro Olmos", "Melchor Romero", "Abasto", "Etcheverry", "El Peligro"],
            "Zona Sur": ["Villa Elvira", "Altos de San Lorenzo", "Sicardi / Villa Garibaldi"],
            "Zona Este": ["Ensenada", "Berisso"]
        };

        const MATCH_LEVELS = ["Tranqui / Joda", "Picado Medio", "A Morir (Competitivo)"];
        const MATCH_GENDERS = ["Hombres", "Mujeres", "Mixto"];
        const POSITIONS_LIST = ["Arquero", "Defensor", "Medio", "Delantero", "Polifuncional"];
        const DAYS_BETWEEN_UPDATES = 30;
        const MAX_ACTIVE_APPLICATIONS_PER_USER = 4;
        const MAX_APPLICATIONS_PER_SLOT = 10; 

        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        const yesterdayString = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        const sevenDaysAgoString = new Date(Date.now() - 86400000 * 7).toISOString().split('T')[0];
        const maxPublishDate = new Date(Date.now() + 86400000 * 7).toISOString().split('T')[0];

        // --- COMPONENTES AUXILIARES ---
        const MobileHeaderButton = ({ icon: Icon, label, onClick, highlight }) => (
            <button 
                onClick={onClick} 
                className={`flex flex-col items-center justify-center py-2 rounded-lg transition-all active:scale-95 border ${
                    highlight 
                    ? 'bg-[#00ff55] text-black border-[#00cc44] shadow-[0_0_10px_rgba(0,255,85,0.3)]' 
                    : 'bg-[#1a1a1a] text-gray-300 border-gray-800 hover:border-gray-600 hover:text-white'
                }`}
            >
                <Icon size={18} className={highlight ? "mb-1 text-black" : "mb-1 text-[#00ff55]"} />
                <span className="text-[9px] font-black uppercase tracking-wider">{label}</span>
            </button>
        );

        const ZoneSelectOptions = () => (<>{Object.entries(ZONES_BY_AREA).map(([region, zones]) => (
            <optgroup key={region} label={region.toUpperCase()} className="bg-gray-900 text-white font-black uppercase tracking-widest text-sm" style={{ fontWeight: '900', color: '#ffffff', backgroundColor: '#000000' }}>
                {zones.map(z => <option key={z} value={z} className="bg-gray-800 font-normal text-gray-300 pl-4">{z}</option>)}
            </optgroup>
        ))}</>);

        const StarRating = ({ rating }) => (
            <div className="flex items-center gap-0.5">
                {[1, 2, 3, 4, 5].map((star) => (
                    <Star key={star} size={10} className={`${(rating || 0) >= star ? "fill-yellow-400 text-yellow-400" : "text-gray-300 fill-gray-200"}`} />
                ))}
            </div>
        );

        // --- COMPONENTE DE TARJETA DE ESTADÍSTICA (NUEVO ESTILO) ---
        const StatCard = ({ title, value, subtitle, icon: Icon, color = "text-white" }) => (
            <div className="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800 shadow-lg flex flex-col justify-between h-full">
                <div className="flex justify-between items-start mb-2">
                    <div>
                        <h4 className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">{title}</h4>
                        <div className={`text-3xl font-black mt-1 ${color}`}>{value}</div>
                    </div>
                    <div className="p-2 bg-gray-800 rounded-lg text-gray-400">
                        <Icon size={18} />
                    </div>
                </div>
                {subtitle && <p className="text-[9px] text-gray-500 font-medium">{subtitle}</p>}
            </div>
        );

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [checkingAuth, setCheckingAuth] = useState(true);
            
            // ADMIN STATE
            const [adminData, setAdminData] = useState({ totalUsers: 0, allUsersList: [] });
            const [allTeamsList, setAllTeamsList] = useState([]);
            
            // ESTADO PARA EL FILTRO DEL DASHBOARD
            const [dashboardTimeRange, setDashboardTimeRange] = useState('all');

            const getFirebaseConfig = () => ({
                apiKey: "AIzaSyC8att6xIu--GeDn7uY6gHkIrwUU1UhwpM",
                authDomain: "el-enganche.firebaseapp.com",
                projectId: "el-enganche",
                storageBucket: "el-enganche.firebasestorage.app",
                messagingSenderId: "733812663281",
                appId: "1:733812663281:web:1e0ba9ca08a331930eda50"
            });

            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);

            useEffect(() => {
                 try {
                    const app = initializeApp(getFirebaseConfig());
                    const appCheck = initializeAppCheck(app, {
                        provider: new ReCaptchaV3Provider('6LdxFE4sAAAAAIcAqm8pq_mfpw1WRzVRJtHiOkP4'),
                        isTokenAutoRefreshEnabled: true
                    });
                    setAuth(getAuth(app));
                    const database = getFirestore(app);
                    setDb(database);
                    enableIndexedDbPersistence(database).catch((err) => { console.log('Persistencia:', err.code); });
                } catch(e) { console.error(e); }
            }, []);

            // Data States
            const [matches, setMatches] = useState([]);
            const [myFullHistoryMatches, setMyFullHistoryMatches] = useState([]);
            const [myFullJoinedMatches, setMyFullJoinedMatches] = useState([]);
            const [players, setPlayers] = useState([]);
            const [invitations, setInvitations] = useState([]); 
            const [myTeam, setMyTeam] = useState(null);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            const [uploadingLogo, setUploadingLogo] = useState(false);
            const [showStatsDetails, setShowStatsDetails] = useState(false);
            const [historyEnabled, setHistoryEnabled] = useState(false);

            // Modales
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showInviteModal, setShowInviteModal] = useState(false);
            const [showCreateTeamModal, setShowCreateTeamModal] = useState(false);
            const [showPublishModal, setShowPublishModal] = useState(false);
            const [showScoutModal, setShowScoutModal] = useState(false);
            const [showTeamSearchModal, setShowTeamSearchModal] = useState(false);
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [showMapModal, setShowMapModal] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            const [feedbackModal, setFeedbackModal] = useState({ show: false, type: 'success', title: '', message: '' });
            
            // Filter States
            const [formatFilter, setFormatFilter] = useState('Todos');
            const [zoneFilter, setZoneFilter] = useState('Todas');
            
            // Form States
            const [inviteData, setInviteData] = useState({ place: '', time: '' });
            const [targetPlayer, setTargetPlayer] = useState(null);
            const [newTeamName, setNewTeamName] = useState('');
            const [teamLogoFile, setTeamLogoFile] = useState(null);
            const [publishData, setPublishData] = useState({ type: 'player', format: 'F5', zone: 'La Plata (Casco Urbano)', place: '', time: '', date: '', level: 'Picado Medio', gender: 'Hombres', isChallenge: false, stake: '', isPromoted: false });
            const [neededPositions, setNeededPositions] = useState(['Cualquiera']);
            const [playerPostulationLevel, setPlayerPostulationLevel] = useState('Picado Medio');
            const [postulationPosition, setPostulationPosition] = useState('Polifuncional'); 
            const [playerPostulationGender, setPlayerPostulationGender] = useState('Hombres');
            
            // Edit States
            const [isEditingNickname, setIsEditingNickname] = useState(false);
            const [isEditingPosition, setIsEditingPosition] = useState(false);
            const [nicknameInput, setNicknameInput] = useState('');
            const [birthDateInput, setBirthDateInput] = useState(''); // NUEVO: EDAD
            const [isEditingTeamName, setIsEditingTeamName] = useState(false);
            const [teamNameInput, setTeamNameInput] = useState('');

            // Search States
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [teamSearchQuery, setTeamSearchQuery] = useState('');
            const [teamSearchResults, setTeamSearchResults] = useState([]);
            
            const [confirmation, setConfirmation] = useState({ show: false, text: '', action: null });
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [pendingLogoFile, setPendingLogoFile] = useState(null);

            // HELPER EDAD
            const calculateAge = (dob) => {
                if (!dob) return null;
                const diff = Date.now() - new Date(dob).getTime();
                const ageDate = new Date(diff); 
                return Math.abs(ageDate.getUTCFullYear() - 1970);
            };

            const isAdmin = user && ADMIN_EMAILS.includes(user.email);
            
            // --- ADMIN DATA SYNC ---
            useEffect(() => {
                if (!db || !user || !isAdmin) return;
                const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => {
                     setAdminData(prev => ({ ...prev, totalUsers: s.size, allUsersList: s.docs.map(d => ({ uid: d.id, ...d.data() })) }));
                });
                const unsubTeams = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), (s) => {
                    setAllTeamsList(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubUsers(); unsubTeams(); };
            }, [db, user, isAdmin]);

            useEffect(() => {
                if(userProfile?.birthDate) setBirthDateInput(userProfile.birthDate);
                if(userProfile?.nickname) setNicknameInput(userProfile.nickname);
            }, [userProfile, isEditingNickname]);

            // --- AUTH & DATA LOAD ---
            useEffect(() => {
                if(!auth) return;
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u.isAnonymous ? null : u);
                        if (!u.isAnonymous) {
                            setView('app');
                            if (db) {
                                const userRef = doc(db, 'artifacts', 'el-capitan-web', 'public', 'data', 'users', u.uid);
                                const snap = await getDoc(userRef);
                                if (!snap.exists()) {
                                    await setDoc(userRef, { uid: u.uid, name: u.displayName, nickname: u.displayName, email: u.email, position: 'Polifuncional', searchName: u.displayName ? u.displayName.toLowerCase() : '', createdAt: serverTimestamp() });
                                    setUserProfile({ position: 'Polifuncional', nickname: u.displayName });
                                } else { setUserProfile(snap.data()); }
                            }
                        }
                    } else { try { await signInAnonymously(auth); } catch(e) { console.log(e); } }
                    setCheckingAuth(false);
                });
            }, [auth, db]);

            useEffect(() => { if(userProfile?.position) setPostulationPosition(userProfile.position); }, [userProfile]);

            useEffect(() => {
                if(!user || !db || user.isAnonymous || !historyEnabled) return; 
                const qCreated = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('createdBy', '==', user.uid));
                const unsubCreated = onSnapshot(qCreated, (s) => setMyFullHistoryMatches(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date))));
                const qJoined = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('playersSigned', 'array-contains', user.uid));
                const unsubJoined = onSnapshot(qJoined, (s) => setMyFullJoinedMatches(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date))));
                return () => { unsubCreated(); unsubJoined(); }
            }, [user, db, historyEnabled]);

            useEffect(() => {
                if(!user || !db) return;
                const unsubTeam = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), (s) => setMyTeam(s.docs.map(d => ({id: d.id, ...d.data()})).find(t => t.captainId === user.uid || t.members?.some(m => m.uid === user.uid))));
                const unsubInv = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), (s) => setInvitations(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0))));
                return () => { unsubTeam(); unsubInv(); }
            }, [user, db]);

            useEffect(() => {
                if(!db) return;
                const qM = query(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), where('date', '>=', yesterdayString));
                const unsubM = onSnapshot(qM, (s) => {
                    const d = s.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    setMatches(d.sort((a,b) => (a.isPromoted === b.isPromoted ? new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time) : a.isPromoted ? -1 : 1)));
                    setLoading(false);
                });
                const qP = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'), where('createdAt', '>', Timestamp.fromDate(new Date(Date.now() - 86400000 * 7))));
                const unsubP = onSnapshot(qP, (s) => {
                    const d = s.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    setPlayers(d.sort((a,b) => (a.isPromoted === b.isPromoted ? 0 : a.isPromoted ? -1 : 1)));
                }); 
                return () => { unsubM(); unsubP(); }
            }, [db]);

            // --- HELPERS (Compress, Confirm, CheckUpdate) ---
            const compressImageToBase64 = async (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let w=img.width, h=img.height, MAX=200; if(w>h){if(w>MAX){h*=MAX/w;w=MAX}}else{if(h>MAX){w*=MAX/h;h=MAX}} canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h); resolve(canvas.toDataURL('image/jpeg',0.7)); }; img.onerror=reject; }; reader.onerror=reject; });
            const askConfirmation = (text, action) => setConfirmation({ show: true, text, action });
            const checkUpdateAvailability = (ts) => { if (!ts) return { available: true, daysLeft: 0 }; const diff = Math.ceil(Math.abs(new Date() - ts.toDate()) / (1000 * 3600 * 24)); return { available: diff >= 30, daysLeft: Math.max(0, 30 - diff) }; };

            // --- EVENT HANDLERS ---
            const handleGoogleLogin = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); setView('app'); } catch(e) { alert(e.message); } };
            const handleLogout = async () => { await signOut(auth); setView('landing'); };
            const handleGuest = () => setView('app');
            const handleShareApp = () => { window.open(`https://wa.me/?text=${encodeURIComponent("¡Sumate a El Capitán! " + window.location.href)}`, '_blank'); };
            const handleClickHeaderButton = () => { if (!user) return setShowLoginModal(true); if (!myTeam) return setShowCreateTeamModal(true); if (myTeam.captainId !== user.uid) return alert("Solo el capitán."); setShowPublishModal(true); };
            const handleInstallClick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); const {outcome} = await deferredPrompt.userChoice; if (outcome === 'accepted') setDeferredPrompt(null); } else { setShowInstallModal(true); } };

            const handleApplyMatch = async (m) => { if (!user) return setShowLoginModal(true); const ref = doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id); if (m.playersSigned?.includes(user.uid)) { await updateDoc(ref, { missing: increment(1), playersSigned: arrayRemove(user.uid) }); return; } if (mySentApplications.length >= 4) return setFeedbackModal({show:true, type:'error', title:'Límite', message:'Máx solicitudes alcanzado'}); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), { type: 'match_request', fromUserId: user.uid, fromName: userProfile?.nickname||user.displayName, matchId: m.id, matchInfo: `${m.teamName} - ${m.date}`, toUserId: m.createdBy, status: 'pending', createdAt: serverTimestamp() }); await updateDoc(ref, { applicationsCount: increment(1) }); setFeedbackModal({ show: true, type: 'success', title: 'Enviada', message: 'Solicitud enviada.' }); };
            const handleCancelRequest = async (invId, mId) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', invId)); if(mId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', mId), { applicationsCount: increment(-1) }); setFeedbackModal({ show: true, type: 'info', title: 'Cancelada', message: 'Solicitud cancelada.' }); };
            const handleRespondMatchRequest = async (inv, action) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', inv.id), { status: action }); const mRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', inv.matchId); await updateDoc(mRef, { applicationsCount: increment(-1) }); if (action === 'accepted') { await updateDoc(mRef, { playersSigned: arrayUnion(inv.fromUserId), missing: increment(-1) }); setFeedbackModal({ show: true, type: 'success', title: 'Aceptado', message: 'Jugador unido.' }); } };
            const handlePublishMatch = async (e) => { e.preventDefault(); if(!user) return; setSubmitting(true); await addDoc(collection(db, 'artifacts', 'el-capitan-web', 'public', 'data', 'matches'), { ...publishData, missing: publishData.type==='rival'?0:neededPositions.length, position: publishData.type==='rival'?'Equipo Completo':neededPositions.join(', '), teamName: myTeam ? myTeam.name : (userProfile?.nickname||user.displayName)+" Team", urgent: false, playersSigned: [], createdBy: user.uid, createdAt: serverTimestamp(), applicationsCount: 0 }); setPublishData({ ...publishData, place: '', time: '', date: '', isChallenge: false, stake: '', isPromoted: false }); setNeededPositions(['Cualquiera']); setShowPublishModal(false); setFeedbackModal({ show: true, type: 'success', title: 'Publicado', message: 'Partido creado.' }); setSubmitting(false); };
            const handleJoinAsPlayer = async () => { if (!user) { setShowLoginModal(true); return; } if (players.some(p => p.uid === user.uid)) return alert("Ya estás postulado."); setSubmitting(true); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'players'), { uid: user.uid, name: userProfile?.nickname||user.displayName, position: postulationPosition, zone: 'La Plata', level: playerPostulationLevel, gender: playerPostulationGender, isPromoted: userProfile?.isPromoted||false, rating: 0, ratingCount: 0, status: 'Disponible', createdAt: serverTimestamp() }); setSubmitting(false); setFeedbackModal({ show: true, type: 'success', title: 'Listo', message: 'Te has postulado.' }); };
            const confirmUpdateNickname = async () => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), { nickname: nicknameInput, birthDate: birthDateInput, lastNicknameUpdate: serverTimestamp() }); setUserProfile({ ...userProfile, nickname: nicknameInput, birthDate: birthDateInput }); setIsEditingNickname(false); if (myPlayerProfile) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myPlayerProfile.id), { name: nicknameInput }); };
            const handleUpdateNickname = () => { const { available } = checkUpdateAvailability(userProfile?.lastNicknameUpdate); if (!available) return setFeedbackModal({ show: true, type: 'error', title: 'Espera', message: 'Solo 1 cambio cada 30 días.' }); askConfirmation("¿Confirmar cambio?", confirmUpdateNickname); };
            const handleUpdatePosition = async (newPos) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), { position: newPos }); setUserProfile({ ...userProfile, position: newPos }); setIsEditingPosition(false); if (myPlayerProfile) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myPlayerProfile.id), { position: newPos }); };
            
            // GENERIC DELETES
            const handleDeletePlayer = (id) => askConfirmation("¿Eliminar?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', id)));
            const handleDeleteMatch = (id) => askConfirmation("¿Eliminar partido?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', id)));
            const handleDeleteTeam = async () => askConfirmation("¿Disolver equipo?", async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id)); setMyTeam(null); });
            const handleLeaveTeam = async () => askConfirmation("¿Salir?", async () => { const upd = myTeam.members.filter(m => m.uid !== user.uid); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { members: upd }); setMyTeam(null); });
            const handleTogglePremiumUser = async (uid, s) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { isPromoted: !s });
            
            // FEED LISTS
            const feedMatches = matches.filter(m => (formatFilter === 'Todos' || m.format === formatFilter) && (zoneFilter === 'Todas' || m.zone === zoneFilter) && (m.date >= yesterdayString));
            const myOrganizedMatchesList = matches.filter(m => m.createdBy === user?.uid);
            const myPlayedMatchesList = matches.filter(m => m.playersSigned && m.playersSigned.includes(user?.uid));
            const mySentApplications = invitations.filter(inv => inv.fromUserId === user?.uid && inv.type === 'match_request' && inv.status === 'pending');

            // RENDER
            if (checkingAuth) return <div className="flex-1 flex items-center justify-center bg-black h-screen text-[#00ff55] animate-pulse">Cargando El Capitán...</div>;

            if (view === 'landing') return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-[#003300] to-[#001a00] h-screen relative overflow-hidden">
                    <img src="https://i.imgur.com/F7p7sXT.png" className="w-64 mb-12 drop-shadow-[0_0_15px_rgba(0,255,85,0.3)] z-10" />
                    <div className="z-10 w-full max-w-sm space-y-4">
                        {user ? <button onClick={()=>setView('app')} className="w-full bg-[#00ff55] text-black font-black py-4 rounded-xl flex justify-center items-center gap-2"><User size={24}/> Entrar</button> : 
                        <button onClick={handleGoogleLogin} className="w-full bg-white text-black font-bold py-3 px-4 rounded-xl flex justify-center items-center gap-2">Google Login</button>}
                        <button onClick={handleGuest} className="w-full border-2 border-[#00ff55] text-[#00ff55] font-bold py-4 rounded-xl">Invitado</button>
                    </div>
                </div>
            );

            return (
                <div className="flex-1 flex flex-col pb-24">
                    {/* HEADER */}
                    <header className="bg-gradient-to-r from-[#003300] to-[#004d26] border-b-4 border-[#00ff55] sticky top-0 z-50 shadow-xl p-2 flex justify-between items-center">
                         <div className="flex items-center gap-2"><img src="https://i.imgur.com/aVwYCPF.png" className="h-8 object-contain" /></div>
                         <div className="flex gap-2">
                             <button onClick={handleClickHeaderButton} className="bg-[#00ff55] text-black px-3 py-1 rounded font-bold text-xs flex items-center gap-1"><PlusCircle size={14}/> {myTeam?"PUBLICAR":"CREAR"}</button>
                             {user && <button onClick={()=>setShowNotifications(!showNotifications)} className="text-white"><Bell size={20}/></button>}
                             {!user && <button onClick={()=>setShowLoginModal(true)} className="text-[#00ff55] border border-[#00ff55] px-2 py-1 rounded text-xs font-bold">LOGIN</button>}
                         </div>
                    </header>

                    {/* MAIN */}
                    <main className="flex-1 max-w-6xl mx-auto w-full p-2 sm:p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* --- VISTA ADMIN PRO DASHBOARD (TU PEDIDO) --- */}
                        {view === 'admin' && isAdmin && (
                            <div className="lg:col-span-12 space-y-6">
                                <div className="flex justify-between items-center bg-[#1a1a1a] p-4 rounded border-l-4 border-[#00ff55]">
                                    <h2 className="text-xl font-black text-white italic">COMANDO CENTRAL</h2>
                                    <button onClick={()=>setView('profile')} className="text-gray-400 text-xs flex items-center gap-1"><ArrowLeft size={12}/> VOLVER</button>
                                </div>

                                {(() => {
                                    // LOGICA DE FILTROS Y DATOS
                                    const now = new Date();
                                    const filterDate = (dItem) => {
                                        if (dashboardTimeRange === 'all') return true;
                                        let d = dItem?.toDate ? dItem.toDate() : new Date(dItem);
                                        if (dashboardTimeRange === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                                        if (dashboardTimeRange === 'year') return d.getFullYear() === now.getFullYear();
                                        return true;
                                    };

                                    const fMatches = matches.filter(m => filterDate(m.date));
                                    const fPlayers = players.filter(p => filterDate(p.createdAt));
                                    
                                    // Calculos
                                    const totalMatches = fMatches.length;
                                    const premiums = fMatches.filter(m => m.isPromoted).length + fPlayers.filter(p => p.isPromoted).length;
                                    
                                    // Genero
                                    const gMatches = {
                                        h: fMatches.filter(x => x.gender==='Hombres').length,
                                        m: fMatches.filter(x => x.gender==='Mujeres').length,
                                        x: fMatches.filter(x => x.gender==='Mixto').length
                                    };
                                    
                                    // Edad
                                    const ageGroups = { 'Sub-20':0, '20-30':0, '30-40':0, '+40':0, 'N/A':0 };
                                    adminData.allUsersList.forEach(u => {
                                        if(!u.birthDate) { ageGroups['N/A']++; return; }
                                        const age = calculateAge(u.birthDate);
                                        if(age<20) ageGroups['Sub-20']++;
                                        else if(age<30) ageGroups['20-30']++;
                                        else if(age<40) ageGroups['30-40']++;
                                        else ageGroups['+40']++;
                                    });

                                    return (
                                        <div className="space-y-4">
                                            {/* FILTRO GLOBAL */}
                                            <div className="flex justify-end">
                                                <select value={dashboardTimeRange} onChange={e=>setDashboardTimeRange(e.target.value)} className="bg-black text-[#00ff55] font-bold text-xs border border-gray-700 rounded px-3 py-2">
                                                    <option value="all">Histórico</option>
                                                    <option value="year">Este Año</option>
                                                    <option value="month">Este Mes</option>
                                                </select>
                                            </div>

                                            {/* KPIs PRINCIPALES (TARJETAS GRANDES) */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                <StatCard title="Partidos Totales" value={totalMatches} subtitle="Registrados en plataforma" icon={Trophy} />
                                                <StatCard title="Base Jugadores" value={adminData.totalUsers} subtitle={`${fPlayers.length} Nuevos Agentes`} icon={Users} color="text-blue-400" />
                                                <StatCard title="Equipos Activos" value={allTeamsList.length} subtitle="Compitiendo" icon={Shield} color="text-yellow-400" />
                                                <StatCard title="Premium" value={premiums} subtitle="Servicios Pagos" icon={Crown} color="text-[#00ff55]" />
                                            </div>

                                            {/* GRÁFICOS DETALLADOS */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                
                                                {/* EDAD (Barras de Progreso) */}
                                                <div className="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800 shadow-lg">
                                                    <div className="flex items-center gap-2 mb-4 border-b border-gray-800 pb-2">
                                                        <User size={16} className="text-[#00ff55]"/>
                                                        <h3 className="text-white font-bold text-xs uppercase">Edad Usuarios</h3>
                                                    </div>
                                                    <div className="space-y-3">
                                                        {Object.entries(ageGroups).map(([lbl, val]) => val > 0 && (
                                                            <div key={lbl}>
                                                                <div className="flex justify-between text-[10px] text-gray-300 mb-1"><span>{lbl}</span> <span>{val}</span></div>
                                                                <div className="w-full bg-gray-800 rounded-full h-1.5"><div style={{width: (val/adminData.totalUsers)*100 + '%'}} className="bg-purple-500 h-full rounded-full"></div></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* GÉNERO (Donut simulado con CSS) */}
                                                <div className="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800 shadow-lg">
                                                    <div className="flex items-center gap-2 mb-4 border-b border-gray-800 pb-2">
                                                        <PieChart size={16} className="text-[#00ff55]"/>
                                                        <h3 className="text-white font-bold text-xs uppercase">Género Partidos</h3>
                                                    </div>
                                                    <div className="flex items-center justify-center py-2">
                                                        <div className="w-24 h-24 rounded-full relative" style={{background: `conic-gradient(#3b82f6 0% ${gMatches.ph}%, #ec4899 ${gMatches.ph}% ${gMatches.ph+gMatches.pm}%, #a855f7 ${gMatches.ph+gMatches.pm}% 100%)`}}>
                                                            <div className="absolute inset-2 bg-[#1a1a1a] rounded-full flex items-center justify-center"><span className="text-xs font-bold text-white">{totalMatches}</span></div>
                                                        </div>
                                                        <div className="ml-4 space-y-2 text-[10px] text-gray-400">
                                                            <div className="flex items-center gap-1"><div className="w-2 h-2 bg-blue-500 rounded-full"></div> Hombres ({gMatches.h})</div>
                                                            <div className="flex items-center gap-1"><div className="w-2 h-2 bg-pink-500 rounded-full"></div> Mujeres ({gMatches.m})</div>
                                                            <div className="flex items-center gap-1"><div className="w-2 h-2 bg-purple-500 rounded-full"></div> Mixto ({gMatches.x})</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* INTENSIDAD */}
                                                <div className="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800 shadow-lg">
                                                    <div className="flex items-center gap-2 mb-4 border-b border-gray-800 pb-2">
                                                        <Activity size={16} className="text-[#00ff55]"/>
                                                        <h3 className="text-white font-bold text-xs uppercase">Nivel de Juego</h3>
                                                    </div>
                                                    <div className="space-y-3">
                                                         {Object.entries(fMatches.reduce((a,c)=>{a[c.level]=(a[c.level]||0)+1;return a},{})).map(([l,c]) => (
                                                             <div key={l}>
                                                                 <div className="flex justify-between text-[10px] text-white mb-1"><span>{l}</span> <span>{c}</span></div>
                                                                 <div className="w-full bg-gray-800 rounded-full h-1.5"><div style={{width: (c/totalMatches)*100+'%'}} className={`h-full rounded-full ${l.includes('Morir')?'bg-red-500':l.includes('Tranqui')?'bg-blue-400':'bg-yellow-400'}`}></div></div>
                                                             </div>
                                                         ))}
                                                    </div>
                                                </div>

                                                {/* PRIME TIME */}
                                                <div className="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800 shadow-lg col-span-1 md:col-span-2 lg:col-span-3">
                                                    <div className="flex items-center gap-2 mb-4 border-b border-gray-800 pb-2">
                                                        <Clock size={16} className="text-[#00ff55]"/>
                                                        <h3 className="text-white font-bold text-xs uppercase">Horario Pico (Prime Time)</h3>
                                                    </div>
                                                    <div className="flex items-end justify-between h-24 gap-1">
                                                        {['18','19','20','21','22','23'].map(h => {
                                                            const c = fMatches.filter(m => m.time?.startsWith(h)).length;
                                                            const max = Math.max(...['18','19','20','21','22','23'].map(hr=>fMatches.filter(x=>x.time?.startsWith(hr)).length), 1);
                                                            return (
                                                                <div key={h} className="flex-1 flex flex-col items-center group">
                                                                    <div className="text-[9px] font-bold text-white mb-1 opacity-0 group-hover:opacity-100">{c}</div>
                                                                    <div style={{height: Math.max((c/max)*100, 10)+'%'}} className={`w-full rounded-t transition-all ${c>0?'bg-[#00ff55]':'bg-gray-800'}`}></div>
                                                                    <div className="text-[9px] text-gray-500 mt-1">{h}h</div>
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* LISTA GESTIÓN USUARIOS */}
                                            <div className="mt-8">
                                                <h3 className="text-white font-bold mb-3 flex items-center gap-2"><Sparkles className="text-yellow-400"/> Gestión de Usuarios</h3>
                                                <div className="bg-[#1a1a1a] rounded border border-gray-800 max-h-60 overflow-y-auto">
                                                    {adminData.allUsersList.map(u => (
                                                        <div key={u.uid} className="flex justify-between items-center p-3 border-b border-gray-800 last:border-0">
                                                            <div>
                                                                <div className="text-sm font-bold text-white">{u.nickname || u.name}</div>
                                                                <div className="text-[10px] text-gray-500">{u.email} | {u.birthDate ? calculateAge(u.birthDate)+' años' : 'Sin edad'}</div>
                                                            </div>
                                                            <button onClick={() => handleTogglePremiumUser(u.uid, u.isPromoted)} className={`px-3 py-1 rounded text-[9px] font-bold uppercase ${u.isPromoted ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-gray-400'}`}>
                                                                {u.isPromoted ? 'PREMIUM' : 'GRATIS'}
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        )}

                        {/* VISTA APP (FEED) */}
                        {view === 'app' && (
                            <div className="lg:col-span-12">
                                <div className="space-y-4">
                                     <div className="bg-gradient-to-r from-[#1b4d2e] to-[#2e7d32] px-4 py-3 rounded-lg border border-[#4caf50] flex flex-wrap gap-2 justify-between items-center">
                                        <h2 className="font-bold flex items-center gap-2 text-white"><Calendar size={20} className="text-[#00ff55]"/> PARTIDOS DISPONIBLES</h2>
                                        <div className="flex gap-2 w-full sm:w-auto">
                                            <select className="app-select" onChange={e => setFormatFilter(e.target.value)}><option value="Todos">Formato</option><option value="F5">F5</option><option value="F7">F7</option><option value="F9">F9</option><option value="F11">F11</option></select>
                                            <select className="app-select" onChange={e => setZoneFilter(e.target.value)}><option value="Todas">Zona</option><ZoneSelectOptions/></select>
                                        </div>
                                    </div>
                                    <div className="grid gap-3">
                                        {feedMatches.map(m => {
                                            const isSigned = m.playersSigned?.includes(user?.uid);
                                            const appCount = m.applicationsCount || 0;
                                            return (
                                                <div key={m.id} className={`bg-[#1a1a1a] p-4 rounded-xl border ${m.isPromoted ? 'border-[#fbbf24] shadow-[0_0_10px_rgba(251,191,36,0.2)]' : 'border-gray-800'}`}>
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className={`text-lg font-black italic ${m.isPromoted ? 'text-yellow-400' : 'text-white'}`}>{m.teamName}</span>
                                                                {m.isChallenge && <span className="bg-yellow-500 text-black text-[9px] font-black px-1.5 py-0.5 rounded flex items-center gap-1"><Trophy size={10}/> DESAFÍO</span>}
                                                            </div>
                                                            <div className="text-xs text-gray-400 flex items-center gap-1"><MapPin size={12}/> {m.place} ({m.zone})</div>
                                                            <div className="text-xs text-[#00ff55] font-mono mt-1 font-bold">{m.date === today ? 'HOY' : m.date} • {m.time}hs</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className="bg-gray-800 text-white text-[10px] px-2 py-1 rounded font-bold">{m.format}</span>
                                                            <div className="text-[10px] text-gray-500 mt-1">{m.gender}</div>
                                                        </div>
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-gray-800 flex justify-between items-center">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs text-gray-300 bg-gray-800 px-2 py-1 rounded">{m.level}</span>
                                                            {appCount > 0 && <span className="text-[10px] text-blue-400 flex items-center gap-1"><Inbox size={12}/> {appCount}</span>}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {(isAdmin || user?.uid === m.createdBy) && <button onClick={()=>handleDeleteMatch(m.id)} className="p-2 bg-red-900/30 text-red-500 rounded hover:bg-red-900/50"><Trash2 size={16}/></button>}
                                                            <button onClick={()=>handleApplyMatch(m)} className={`px-4 py-2 rounded text-xs font-black uppercase transition-all ${isSigned ? 'bg-red-600 text-white' : 'bg-[#00ff55] text-black hover:bg-white'}`}>
                                                                {isSigned ? 'SALIR' : 'SOLICITAR'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                        {feedMatches.length === 0 && <div className="text-center text-gray-500 py-8">No hay partidos con estos filtros.</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'team' && (
                             <div className="lg:col-span-12 text-center text-white">
                                 {myTeam ? (
                                     <div className="bg-[#1a1a1a] p-6 rounded-xl border border-gray-800">
                                         <h2 className="text-3xl font-black italic text-[#00ff55] mb-2">{myTeam.name}</h2>
                                         <div className="text-gray-400 text-sm mb-6">Capitán: {myTeam.captainName}</div>
                                         <div className="grid grid-cols-2 gap-4 max-w-sm mx-auto">
                                             <button onClick={()=>setShowScoutModal(true)} className="bg-gray-800 p-3 rounded hover:bg-gray-700 font-bold">Fichar Jugador</button>
                                             <button onClick={()=>{setPublishData({...publishData, type:'rival'}); setShowPublishModal(true)}} className="bg-[#00ff55] text-black p-3 rounded hover:bg-white font-black">Publicar Desafío</button>
                                         </div>
                                     </div>
                                 ) : (
                                     <div className="py-12">
                                         <Shield size={64} className="mx-auto text-gray-600 mb-4"/>
                                         <h3 className="text-2xl font-bold mb-4">No tienes equipo</h3>
                                         <button onClick={()=>setShowCreateTeamModal(true)} className="bg-[#00ff55] text-black px-6 py-3 rounded font-black">CREAR EQUIPO</button>
                                     </div>
                                 )}
                             </div>
                        )}

                        {view === 'profile' && (
                             <div className="lg:col-span-12">
                                 <div className="bg-[#1a1a1a] p-6 rounded-xl border border-gray-800 flex flex-col md:flex-row gap-6 items-center md:items-start">
                                     <div className="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center text-4xl text-gray-600">
                                         {user?.photoURL ? <img src={user.photoURL} className="w-full h-full rounded-full object-cover"/> : <User/>}
                                     </div>
                                     <div className="flex-1 w-full space-y-4">
                                         {isEditingNickname ? (
                                             <div className="space-y-3 bg-gray-900 p-4 rounded border border-gray-700">
                                                 <input value={nicknameInput} onChange={e=>setNicknameInput(e.target.value)} className="app-input" placeholder="Nombre" />
                                                 <div className="space-y-1">
                                                     <label className="text-xs text-gray-400">Fecha de Nacimiento</label>
                                                     <input type="date" value={birthDateInput} onChange={e=>setBirthDateInput(e.target.value)} className="app-input" />
                                                 </div>
                                                 <div className="flex gap-2">
                                                     <button onClick={confirmUpdateNickname} className="flex-1 bg-[#00ff55] text-black py-2 rounded font-bold">GUARDAR</button>
                                                     <button onClick={()=>setIsEditingNickname(false)} className="flex-1 bg-gray-700 text-white py-2 rounded font-bold">CANCELAR</button>
                                                 </div>
                                             </div>
                                         ) : (
                                             <div className="text-center md:text-left">
                                                 <div className="flex items-center justify-center md:justify-start gap-2 mb-1">
                                                     <h2 className="text-2xl font-black text-white italic">{userProfile?.nickname || user?.displayName}</h2>
                                                     <button onClick={()=>{setNicknameInput(userProfile?.nickname); setBirthDateInput(userProfile?.birthDate||''); setIsEditingNickname(true)}} className="text-gray-500 hover:text-[#00ff55]"><Edit2 size={16}/></button>
                                                 </div>
                                                 <div className="text-gray-400 text-sm mb-2">{user?.email}</div>
                                                 {userProfile?.birthDate && <span className="bg-gray-800 text-gray-300 text-xs px-2 py-1 rounded border border-gray-700">{calculateAge(userProfile.birthDate)} Años</span>}
                                             </div>
                                         )}
                                         
                                         {/* ESTADÍSTICAS PERFIL */}
                                         <div className="grid grid-cols-2 gap-3">
                                             <div className="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                                                 <div className="text-2xl font-black text-[#00ff55]">{myFullHistoryMatches.length}</div>
                                                 <div className="text-[10px] text-gray-400 uppercase">Organizados</div>
                                             </div>
                                             <div className="bg-gray-900 p-3 rounded border border-gray-800 text-center">
                                                 <div className="text-2xl font-black text-white">{myFullJoinedMatches.length}</div>
                                                 <div className="text-[10px] text-gray-400 uppercase">Jugados</div>
                                             </div>
                                         </div>
                                         
                                         {isAdmin && <button onClick={()=>setView('admin')} className="w-full bg-red-900/50 text-red-400 border border-red-900 py-3 rounded font-bold flex items-center justify-center gap-2"><Shield size={16}/> PANEL ADMIN</button>}
                                         <button onClick={handleLogout} className="w-full bg-gray-800 text-gray-400 py-3 rounded font-bold hover:bg-red-900/20 hover:text-red-500">Cerrar Sesión</button>
                                     </div>
                                 </div>
                             </div>
                        )}
                        
                    </main>

                    {/* FOOTER */}
                    {view !== 'landing' && (
                        <div className="fixed bottom-0 left-0 w-full bg-[#000000] border-t-2 border-[#00ff55] flex justify-around items-center h-20 pb-2 z-[9999]">
                            <button onClick={() => setView('app')} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${view === 'app' ? 'text-[#00ff55]' : 'text-gray-500'}`}><Home size={24} className={view==='app'?"fill-current":""}/><span className="text-[10px] font-bold">INICIO</span></button>
                            <button onClick={() => user ? setView('team') : setShowLoginModal(true)} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${view === 'team' ? 'text-[#00ff55]' : 'text-gray-500'}`}><Shield size={24} className={view==='team'?"fill-current":""}/><span className="text-[10px] font-bold">EQUIPO</span></button>
                            <button onClick={() => user ? setView('profile') : setShowLoginModal(true)} className={`flex flex-col items-center gap-1 w-full h-full justify-center ${view === 'profile' ? 'text-[#00ff55]' : 'text-gray-500'}`}><User size={24} className={view==='profile'?"fill-current":""}/><span className="text-[10px] font-bold">PERFIL</span></button>
                        </div>
                    )}
                    
                    {/* MODALES */}
                    {showLoginModal && <div className="fixed inset-0 bg-black/90 z-[5000] flex items-center justify-center p-6"><div className="bg-[#1a1a1a] p-6 rounded-xl w-full max-w-sm border border-[#00ff55] text-center"><h3 className="text-white font-bold text-xl mb-6">Iniciar Sesión</h3><button onClick={handleGoogleLogin} className="w-full bg-white text-black font-bold py-3 rounded-lg mb-4">Google</button><button onClick={()=>setShowLoginModal(false)} className="text-gray-500">Cancelar</button></div></div>}
                    
                    {/* MODAL PUBLICAR */}
                    {showPublishModal && (
                        <div className="fixed inset-0 bg-black/90 z-[5000] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded-xl w-full max-w-sm border border-[#00ff55]">
                                <h3 className="text-[#00ff55] font-black italic text-xl mb-4 text-center">NUEVO PARTIDO</h3>
                                <form onSubmit={handlePublishMatch} className="space-y-3">
                                    <div className="flex gap-2">
                                        <button type="button" onClick={()=>setPublishData({...publishData, type:'rival'})} className={`flex-1 py-2 rounded text-xs font-bold ${publishData.type==='rival'?'bg-[#00ff55] text-black':'bg-gray-800 text-white'}`}>RIVAL</button>
                                        <button type="button" onClick={()=>setPublishData({...publishData, type:'player'})} className={`flex-1 py-2 rounded text-xs font-bold ${publishData.type==='player'?'bg-[#00ff55] text-black':'bg-gray-800 text-white'}`}>JUGADOR</button>
                                    </div>
                                    <input value={publishData.place} onChange={e=>setPublishData({...publishData, place:e.target.value})} className="app-input" placeholder="Cancha" required/>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="date" value={publishData.date} onChange={e=>setPublishData({...publishData, date:e.target.value})} className="app-input" required min={today}/>
                                        <input type="time" value={publishData.time} onChange={e=>setPublishData({...publishData, time:e.target.value})} className="app-input" required/>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <select value={publishData.format} onChange={e=>setPublishData({...publishData, format:e.target.value})} className="app-select"><option>F5</option><option>F7</option><option>F9</option><option>F11</option></select>
                                        <select value={publishData.gender} onChange={e=>setPublishData({...publishData, gender:e.target.value})} className="app-select"><option>Hombres</option><option>Mujeres</option><option>Mixto</option></select>
                                    </div>
                                    <select value={publishData.zone} onChange={e=>setPublishData({...publishData, zone:e.target.value})} className="app-select"><ZoneSelectOptions/></select>
                                    <select value={publishData.level} onChange={e=>setPublishData({...publishData, level:e.target.value})} className="app-select">{MATCH_LEVELS.map(l=><option key={l} value={l}>{l}</option>)}</select>
                                    
                                    {publishData.type === 'rival' && (
                                        <div className="flex items-center gap-2 bg-gray-800 p-2 rounded">
                                            <input type="checkbox" checked={publishData.isChallenge} onChange={e=>setPublishData({...publishData, isChallenge:e.target.checked})}/>
                                            <span className="text-white text-xs">Es Desafío (por plata/premios)</span>
                                        </div>
                                    )}
                                    {publishData.isChallenge && <input value={publishData.stake} onChange={e=>setPublishData({...publishData, stake:e.target.value})} className="app-input" placeholder="¿Qué se juega?"/>}
                                    
                                    <div className="flex gap-2 mt-4">
                                        <button type="button" onClick={()=>setShowPublishModal(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancelar</button>
                                        <button type="submit" disabled={submitting} className="flex-1 py-3 bg-[#00ff55] text-black font-black rounded hover:bg-white">{submitting?'...':'PUBLICAR'}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {/* FEEDBACK MODAL */}
                    {feedbackModal.show && (
                        <div className="fixed inset-0 bg-black/90 z-[6000] flex items-center justify-center p-4">
                            <div className="bg-[#1a1a1a] p-6 rounded-xl w-full max-w-xs text-center border-2 border-[#00ff55]">
                                <CheckCircle size={48} className="mx-auto text-[#00ff55] mb-4"/>
                                <h3 className="text-white font-black text-xl mb-2">{feedbackModal.title}</h3>
                                <p className="text-gray-400 text-sm mb-6">{feedbackModal.message}</p>
                                <button onClick={()=>setFeedbackModal({...feedbackModal, show:false})} className="w-full bg-[#00ff55] text-black font-bold py-3 rounded">OK</button>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>>
</body>
</html>
