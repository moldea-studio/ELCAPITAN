<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Capit√°n - F√∫tbol Amateur</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#00ff55">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="El Capit√°n">
    <link rel="apple-touch-icon" id="apple-icon">
    <link rel="icon" type="image/png" id="favicon">
    <link rel="manifest" id="manifest-placeholder">

    <!-- CONFIGURACI√ìN DE √çCONOS REALES -->
    <script>
        (function() {
            // Logo cuadrado para √≠cono de App y Favicon
            const iconUrl = "https://i.imgur.com/evLI09R.png";
            
            document.getElementById('apple-icon').href = iconUrl;
            document.getElementById('favicon').href = iconUrl;
            
            const manifest = {
                "name": "El Capit√°n",
                "short_name": "El Capit√°n",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#111827",
                "theme_color": "#00ff55",
                "orientation": "portrait",
                "icons": [
                    { "src": iconUrl, "sizes": "192x192", "type": "image/png" },
                    { "src": iconUrl, "sizes": "512x512", "type": "image/png" }
                ]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos base -->
    <style>
        body { background-color: #111827; color: #e5e7eb; font-family: sans-serif; padding-bottom: 70px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #00ff55; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #root { min-height: 100vh; display: flex; flex-direction: column; }
        #error-display { display: none; padding: 20px; color: #ff6b6b; background: #2d1b1b; text-align: center; }
        
        /* Animaci√≥n para el modal de calificaci√≥n */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root">
        <div class="flex-1 flex items-center justify-center text-[#00ff55] animate-pulse">
            <svg class="w-10 h-10 animate-spin mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
            Cargando El Capit√°n...
        </div>
    </div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Users, MapPin, Calendar, Shield, Search, PlusCircle, AlertCircle, 
            ChevronRight, ChevronDown, ChevronUp, Swords, Star, Menu, X, Filter, 
            Link as LinkIcon, User, LogOut, Mail, Lock, Trash2, Ban, Trophy, 
            Activity, ArrowLeft, HelpCircle, FileText, Lock as LockIcon, Bell, 
            CheckCircle, XCircle, Send, Crown, UserPlus, Share2, Edit2, Save, MinusCircle,
            Home, Zap, ClipboardList, AlertTriangle, Download, UserCheck, UserX, Clock, MessageCircle, Beer, Flame, Banknote
        } from 'https://esm.sh/lucide-react@0.294.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile,
            signInAnonymously, signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, query, onSnapshot, doc, updateDoc, increment, 
            arrayUnion, arrayRemove, addDoc, serverTimestamp, deleteDoc, where, 
            orderBy, getDoc, setDoc, getDocs
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        window.onerror = function(message, source, lineno, colno, error) {
            console.error(error);
            if (!message.includes("permission") && !message.includes("network")) {
                const display = document.getElementById('error-display');
                display.style.display = 'block';
                display.innerHTML = `<strong>Error:</strong> ${message} <br/><small>${source}:${lineno}</small>`;
            }
        };

        const getFirebaseConfig = () => {
            return {
                apiKey: "AIzaSyC8att6xIu--GeDn7uY6gHkIrwUU1UhwpM",
                authDomain: "el-enganche.firebaseapp.com",
                projectId: "el-enganche",
                storageBucket: "el-enganche.firebasestorage.app",
                messagingSenderId: "733812663281",
                appId: "1:733812663281:web:1e0ba9ca08a331930eda50"
            };
        };

        let app, auth, db;
        try {
            const firebaseConfig = getFirebaseConfig();
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Error init firebase", e); }

        const appId = 'el-capitan-web';
        const ADMIN_EMAILS = ["worlddigital2011@gmail.com", "admin@elenganche.com", "eyamilgimenez98@gmail.com"];
        const LA_PLATA_ZONES = [
            "Todas", "La Plata (Casco Urbano)", "City Bell", "Villa Elisa", 
            "Manuel B. Gonnet", "Arturo Segu√≠", "Ringuelet", "Tolosa", 
            "Los Hornos", "San Carlos", "Villa Elvira", "Altos de San Lorenzo", 
            "Villa Castells", "Joaqu√≠n Gorina", "Jos√© Hern√°ndez", "Lisandro Olmos", 
            "Melchor Romero", "Abasto", "Etcheverry", "El Peligro", "Sicardi / Villa Garibaldi"
        ];
        
        const ZONES_BY_AREA = {
            "Casco Urbano": ["La Plata (Casco Urbano)"],
            "Zona Norte": ["Arturo Segu√≠", "Villa Elisa", "City Bell", "Manuel B. Gonnet", "Ringuelet", "Tolosa", "Villa Castells", "Joaqu√≠n Gorina", "Jos√© Hern√°ndez"],
            "Zona Oeste": ["San Carlos", "Los Hornos", "Lisandro Olmos", "Melchor Romero", "Abasto", "Etcheverry", "El Peligro"],
            "Zona Sur": ["Villa Elvira", "Altos de San Lorenzo", "Sicardi / Villa Garibaldi"],
            "Zona Este": ["Ensenada", "Berisso"]
        };

        const MATCH_LEVELS = ["Tranqui / Joda üçª", "Picado Medio ‚öΩ", "A Morir (Competitivo) üèÜ"];

        // --- GENERADOR DE FECHAS PARA DUMMY DATA ---
        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000 * 2).toISOString().split('T')[0]; // 2 d√≠as atr√°s para permitir calificar

        const INITIAL_MATCHES = [
            // Partido Pasado (Para probar calificaci√≥n)
            { date: yesterday, time: '20:00', place: 'Predio El Rinc√≥n', zone: 'La Plata (Casco Urbano)', format: 'F5', type: 'player', missing: 0, position: 'Arquero', teamName: 'Los Rotos FC', urgent: false, playersSigned: ['dummy_1', 'dummy_2'], level: 'Picado Medio ‚öΩ' },
            
            // Desaf√≠o Econ√≥mico (Cancha)
            { date: today, time: '21:00', place: 'Club Atl. Villa Elisa', zone: 'Villa Elisa', format: 'F7', type: 'rival', isChallenge: true, stake: 'La cancha (aprox $30.000)', missing: 0, position: 'Equipo Completo', teamName: 'Defensores VE', urgent: true, level: 'A Morir (Competitivo) üèÜ' },
            
            // Partido normal buscando jugadores
            { date: tomorrow, time: '19:00', place: 'La Plaza', zone: 'City Bell', format: 'F5', type: 'player', missing: 2, position: 'Defensores', teamName: 'Inter CB', urgent: false, level: 'Tranqui / Joda üçª' },
            
            // Desaf√≠o "Caj√≥n de Cerveza"
            { date: today, time: '23:00', place: 'Complejo 44', zone: 'San Carlos', format: 'F9', type: 'rival', isChallenge: true, stake: 'Un caj√≥n de cerveza üç∫', missing: 0, position: 'Equipo', teamName: 'San Carlos Jr', urgent: true, level: 'Picado Medio ‚öΩ' },
            
            // Desaf√≠o "Asado"
            { date: tomorrow, time: '20:00', place: 'Lawn Tennis', zone: 'La Plata (Casco Urbano)', format: 'F5', type: 'rival', isChallenge: true, stake: 'El Asado del 3T ü•©', missing: 0, position: 'Equipo', teamName: 'Los Parrilleros', urgent: false, level: 'Tranqui / Joda üçª' },
            
            // Partido normal buscando jugador
            { date: tomorrow, time: '22:00', place: 'Estaci√≥n Norte', zone: 'Ringuelet', format: 'F5', type: 'player', missing: 1, position: 'Cualquiera', teamName: 'La M√°quina', urgent: false, level: 'Picado Medio ‚öΩ' },
        ];

        const INITIAL_PLAYERS = [
            { uid: 'dummy_1', name: 'Lucho M.', position: 'Arquero', zone: 'Villa Elisa', rating: 4.5, ratingCount: 10, status: 'Disponible', level: 'A Morir (Competitivo) üèÜ' },
            { uid: 'dummy_2', name: 'El Distinto', position: 'Medio', zone: 'La Plata (Casco Urbano)', rating: 5.0, ratingCount: 3, status: 'Disponible', level: 'Picado Medio ‚öΩ' },
            { uid: 'dummy_3', name: 'Santi G.', position: 'Delantero', zone: 'Gonnet', rating: 3.2, ratingCount: 5, status: 'Disponible', level: 'Tranqui / Joda üçª' },
            { uid: 'dummy_4', name: 'El Muro', position: 'Defensor', zone: 'Tolosa', rating: 4.0, ratingCount: 8, status: 'Lesionado', level: 'A Morir (Competitivo) üèÜ' },
            { uid: 'dummy_5', name: 'Alejo B.', position: 'Polifuncional', zone: 'City Bell', rating: 0, ratingCount: 0, status: 'Disponible', level: 'Picado Medio ‚öΩ' },
        ];

        const App = () => {
            const [view, setView] = useState('landing');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isProfileExpanded, setIsProfileExpanded] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);
            const [formatFilter, setFormatFilter] = useState('Todos');
            const [zoneFilter, setZoneFilter] = useState('Todas');
            
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null); 
            const [matches, setMatches] = useState([]);
            const [players, setPlayers] = useState([]);
            const [invitations, setInvitations] = useState([]);
            const [myTeam, setMyTeam] = useState(null);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            
            // Modales
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showInviteModal, setShowInviteModal] = useState(false);
            const [showCreateTeamModal, setShowCreateTeamModal] = useState(false);
            const [showPublishModal, setShowPublishModal] = useState(false);
            const [showScoutModal, setShowScoutModal] = useState(false); 
            const [showTeamSearchModal, setShowTeamSearchModal] = useState(false); 
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [showMapModal, setShowMapModal] = useState(false); 
            
            // Modal de Calificaci√≥n
            const [showRatingModal, setShowRatingModal] = useState(false);
            const [ratingMatch, setRatingMatch] = useState(null);
            const [ratingTargetPlayer, setRatingTargetPlayer] = useState(null);
            const [ratingStep, setRatingStep] = useState('list'); // 'list' o 'form'
            const [ratings, setRatings] = useState({ game: 3, punctuality: 3, fairplay: 3, communication: 3, social: 3 });

            const [confirmation, setConfirmation] = useState({ show: false, text: '', action: null });
            
            // Forms
            const [targetPlayer, setTargetPlayer] = useState(null);
            const [inviteData, setInviteData] = useState({ place: '', time: '' });
            const [newTeamName, setNewTeamName] = useState('');
            // Added level, stake, isChallenge
            const [publishData, setPublishData] = useState({ type: 'player', format: 'F5', zone: 'La Plata (Casco Urbano)', place: '', time: '', date: '', level: 'Picado Medio ‚öΩ', isChallenge: false, stake: '' });
            const [neededPositions, setNeededPositions] = useState(['Cualquiera']);
            
            // Player Postulation Form
            const [playerPostulationLevel, setPlayerPostulationLevel] = useState('Picado Medio ‚öΩ');

            const [searchQuery, setSearchQuery] = useState(''); 
            const [searchResults, setSearchResults] = useState([]); 
            const [teamSearchQuery, setTeamSearchQuery] = useState(''); 
            const [teamSearchResults, setTeamSearchResults] = useState([]); 
            const [isEditingPosition, setIsEditingPosition] = useState(false);
            
            // Edici√≥n de Apodo
            const [isEditingNickname, setIsEditingNickname] = useState(false);
            const [nicknameInput, setNicknameInput] = useState('');

            const isAdmin = user && ADMIN_EMAILS.includes(user.email);
            const myMatches = user ? matches.filter(m => m.playersSigned?.includes(user.uid)) : [];
            const myOrganizedMatches = user ? matches.filter(m => m.createdBy === user.uid) : [];
            const myPlayerProfile = user ? players.find(p => p.uid === user.uid) : null;
            const userRating = myPlayerProfile?.rating || 0;
            const userRatingCount = myPlayerProfile?.ratingCount || 0;
            const pendingInvitations = invitations.filter(inv => inv.status === 'pending');
            const isCaptain = myTeam && myTeam.captainId === user?.uid;

            // --- EFFECTS ---
            useEffect(() => {
                const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            useEffect(() => {
                const init = async () => {
                    onAuthStateChanged(auth, async (u) => {
                        if (u) {
                            setUser(u.isAnonymous ? null : u);
                            if (!u.isAnonymous) {
                                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', u.uid);
                                const snap = await getDoc(userRef);
                                if (!snap.exists()) {
                                    await setDoc(userRef, { 
                                        uid: u.uid, 
                                        name: u.displayName, 
                                        nickname: u.displayName, 
                                        email: u.email, 
                                        position: 'Polifuncional',
                                        searchName: u.displayName ? u.displayName.toLowerCase() : '', 
                                        createdAt: serverTimestamp() 
                                    });
                                    setUserProfile({ position: 'Polifuncional', nickname: u.displayName });
                                } else {
                                    setUserProfile(snap.data());
                                }
                            }
                            subscribeToData();
                        } else {
                            try { await signInAnonymously(auth); } catch(e) { 
                                console.log("Login an√≥nimo fall√≥, mostrando datos locales");
                                setMatches(INITIAL_MATCHES); setPlayers(INITIAL_PLAYERS); setLoading(false);
                            }
                        }
                    });
                };
                init();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                try {
                    const qTeam = collection(db, 'artifacts', appId, 'public', 'data', 'teams');
                    onSnapshot(qTeam, (s) => {
                        const found = s.docs.map(d => ({id: d.id, ...d.data()}))
                            .find(t => t.captainId === user.uid || t.members?.some(m => m.uid === user.uid));
                        setMyTeam(found || null);
                    });
                    const qInv = collection(db, 'artifacts', appId, 'public', 'data', 'invitations');
                    onSnapshot(qInv, (s) => {
                        const all = s.docs.map(d => ({id: d.id, ...d.data()}));
                        const mine = all.filter(i => i.toUserId === user.uid).sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                        setInvitations(mine);
                    });
                } catch(e) { console.error(e); }
            }, [user]);

            const subscribeToData = () => {
                if (!db) return;
                try {
                    const qM = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
                    onSnapshot(qM, (s) => {
                        const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                        if (data.length === 0) {
                            seedDatabase();
                        } else {
                            const sorted = data.sort((a,b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
                            setMatches(sorted);
                        }
                        setLoading(false);
                    }, (error) => {
                        setMatches(INITIAL_MATCHES); 
                        setLoading(false);
                    });

                    const qP = collection(db, 'artifacts', appId, 'public', 'data', 'players');
                    onSnapshot(qP, (s) => {
                        const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                        if (data.length === 0) {
                            seedPlayers();
                        } else {
                            setPlayers(data);
                        }
                    }, (error) => {
                        setPlayers(INITIAL_PLAYERS); 
                    });
                } catch(e) { 
                    setMatches(INITIAL_MATCHES);
                    setPlayers(INITIAL_PLAYERS);
                    setLoading(false); 
                }
            };

            const seedDatabase = async () => {
                const matchesRef = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
                const snap = await getDocs(matchesRef);
                if (snap.size === 0) {
                    for (const match of INITIAL_MATCHES) { 
                        const creator = (match.teamName === 'Los Rotos FC' && user) ? user.uid : 'system';
                        await addDoc(matchesRef, { ...match, createdBy: creator, createdAt: serverTimestamp() }); 
                    }
                }
            };
            const seedPlayers = async () => {
                const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'players');
                const snap = await getDocs(playersRef);
                if (snap.size === 0) {
                    for (const p of INITIAL_PLAYERS) { 
                        await addDoc(playersRef, { ...p, uid: 'dummy_'+Math.random(), createdAt: serverTimestamp() }); 
                    }
                }
            };

            // --- NICKNAME LOGIC ---
            const handleStartEditingNickname = () => {
                setNicknameInput(userProfile?.nickname || user.displayName || '');
                setIsEditingNickname(true);
            };

            const handleSaveNickname = async () => {
                const newNickname = nicknameInput.trim();
                if (!newNickname) return alert("El apodo no puede estar vac√≠o.");
                if (newNickname.length < 3) return alert("El apodo debe tener al menos 3 letras.");
                
                // Verificaci√≥n de duplicados
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('nickname', '==', newNickname));
                const snap = await getDocs(q);
                const isTaken = snap.docs.some(d => d.id !== user.uid);

                if (isTaken) {
                    alert(`¬°El apodo "${newNickname}" ya est√° en uso! Por favor, elige otro (ej: ${newNickname}10).`);
                    return;
                }

                try {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                    await updateDoc(userRef, { nickname: newNickname, searchName: newNickname.toLowerCase() });
                    const qPlayer = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'), where('uid', '==', user.uid));
                    const playerSnap = await getDocs(qPlayer);
                    playerSnap.forEach(async (d) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', d.id), { name: newNickname }); });
                    setUserProfile({ ...userProfile, nickname: newNickname });
                    setIsEditingNickname(false);
                    alert("¬°Apodo actualizado correctamente!");
                } catch(e) { alert("Error al guardar: " + e.message); }
            };

            // --- RATING LOGIC ---
            const openRatingModal = (match) => {
                setRatingMatch(match);
                setRatingStep('list');
                setShowRatingModal(true);
            };

            const selectPlayerToRate = (playerId) => {
                let p = players.find(x => x.uid === playerId);
                if (!p) { p = { uid: playerId, name: 'Jugador Invitado' }; }
                setRatingTargetPlayer(p);
                setRatings({ game: 3, punctuality: 3, fairplay: 3, communication: 3, social: 3 });
                setRatingStep('form');
            };

            const submitRating = async () => {
                if (!ratingTargetPlayer || !ratingTargetPlayer.uid.startsWith('dummy')) {
                    const playerDoc = players.find(p => p.uid === ratingTargetPlayer.uid);
                    if (playerDoc) {
                        const weightedScore = (ratings.game * 0.5) + (ratings.punctuality * 0.125) + (ratings.fairplay * 0.125) + (ratings.communication * 0.125) + (ratings.social * 0.125);
                        const currentRating = playerDoc.rating || 0;
                        const currentCount = playerDoc.ratingCount || 0;
                        const newCount = currentCount + 1;
                        const newRating = ((currentRating * currentCount) + weightedScore) / newCount;
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', playerDoc.id), { rating: newRating, ratingCount: newCount });
                            alert(`¬°Calificaci√≥n enviada! Nuevo promedio: ${newRating.toFixed(1)}`);
                        } catch(e) { alert("Error al guardar calificaci√≥n: " + e.message); }
                    } else { alert("Este jugador es de prueba y no tiene perfil real para guardar."); }
                }
                setShowRatingModal(false);
            };

            const RatingStars = ({ value, onChange, label, icon: Icon }) => (
                <div className="mb-4">
                    <div className="flex justify-between items-center mb-1">
                        <span className="text-gray-300 text-xs font-bold flex items-center gap-2"><Icon size={14} className="text-[#00ff55]"/> {label}</span>
                        <span className="text-[#00ff55] font-black text-sm">{value}</span>
                    </div>
                    <div className="flex gap-2">
                        {[1, 2, 3, 4, 5].map((star) => (
                            <button key={star} type="button" onClick={() => onChange(star)} className={`flex-1 h-2 rounded-full transition-all ${star <= value ? 'bg-[#00ff55] shadow-[0_0_5px_rgba(0,255,85,0.5)]' : 'bg-gray-700'}`}/>
                        ))}
                    </div>
                </div>
            );

            // --- HANDLERS ---
            const handleGoogleLogin = async () => {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); setView('app'); }
                catch (e) { alert("Error al iniciar sesi√≥n: " + e.message); }
            };
            const handleLogout = async () => { await signOut(auth); setView('landing'); };
            const handleGuest = () => setView('app');
            
            const handleInstallClick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') setDeferredPrompt(null);
                } else { setShowInstallModal(true); }
            };

            const handleJoinMatch = async (match) => {
                if (!user) { setShowLoginModal(true); return; }
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'matches', match.id);
                const isIn = match.playersSigned?.includes(user.uid);
                try {
                    if (isIn) await updateDoc(ref, { missing: increment(1), playersSigned: arrayRemove(user.uid) });
                    else if (match.missing > 0) await updateDoc(ref, { missing: increment(-1), playersSigned: arrayUnion(user.uid) });
                } catch(err) { alert("Error al unirse: " + err.message); }
            };
            
            const handleClickHeaderButton = () => {
                if (!user) return setShowLoginModal(true);
                if (!myTeam) return setShowCreateTeamModal(true);
                if (myTeam.captainId !== user.uid) return alert("Solo el capit√°n puede publicar.");
                setShowPublishModal(true);
            };

            const handleAddSlot = () => setNeededPositions([...neededPositions, 'Cualquiera']);
            const handleRemoveSlot = (index) => {
                const newSlots = [...neededPositions]; newSlots.splice(index, 1); setNeededPositions(newSlots);
            };
            const handleSlotChange = (index, value) => {
                const newSlots = [...neededPositions]; newSlots[index] = value; setNeededPositions(newSlots);
            };

            const handlePublishMatch = async (e) => {
                e.preventDefault();
                if (!user) return;
                setSubmitting(true);
                try {
                    const isRival = publishData.type === 'rival';
                    const missingCount = isRival ? 0 : neededPositions.length;
                    const positionString = isRival ? 'Equipo Completo' : neededPositions.join(', ');
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), {
                        ...publishData, missing: missingCount, position: positionString, 
                        teamName: myTeam ? myTeam.name : (userProfile?.nickname || user.displayName) + " Team",
                        urgent: false, playersSigned: [], createdBy: user.uid, createdAt: serverTimestamp()
                    });
                    setPublishData({ type: 'player', format: 'F5', zone: 'La Plata (Casco Urbano)', place: '', time: '', date: '', level: 'Picado Medio ‚öΩ', isChallenge: false, stake: '' });
                    setNeededPositions(['Cualquiera']);
                    setShowPublishModal(false);
                    alert("¬°Partido publicado exitosamente!");
                } catch(err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            const handleJoinAsPlayer = async () => {
                if (!user) { setShowLoginModal(true); return; }
                if (players.some(p => p.uid === user.uid)) return alert("Ya est√°s postulado como agente libre.");
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'players'), {
                        uid: user.uid, 
                        name: userProfile?.nickname || user.displayName, // Usar apodo
                        position: userProfile?.position || 'Polifuncional', 
                        zone: 'La Plata',
                        level: playerPostulationLevel, // Nivel seleccionado
                        rating: 0, ratingCount: 0, status: 'Disponible', createdAt: serverTimestamp()
                    });
                    alert("¬°Te has postulado correctamente!");
                } catch(err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };

            const handleUpdatePosition = async (newPos) => {
                if(!user) return;
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                await updateDoc(userRef, { position: newPos });
                setUserProfile({ ...userProfile, position: newPos });
                setIsEditingPosition(false);
                if (myPlayerProfile) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', myPlayerProfile.id), { position: newPos });
            };
            
            const askConfirmation = (text, action) => { setConfirmation({ show: true, text, action }); };
            
            const handleDeletePlayer = (id) => {
                if (!user) return;
                if (isAdmin || players.find(p=>p.id===id)?.uid === user?.uid) {
                    askConfirmation("¬øVas a eliminar a este jugador de la lista?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', id)));
                }
            };
            const handleDeleteMatch = (idMatch) => {
                if (!user) return;
                const match = matches.find(m => m.id === idMatch);
                const isCreator = match && match.createdBy === user.uid;
                if(isAdmin || isCreator) {
                    askConfirmation("¬øVas a eliminar este partido permanentemente?", async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', idMatch)));
                }
            };
            const handleCreateTeam = async (e) => {
                e.preventDefault();
                if (!user || !newTeamName) return;
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), {
                        name: newTeamName, captainId: user.uid, 
                        captainName: userProfile?.nickname || user.displayName, 
                        members: [{ uid: user.uid, name: userProfile?.nickname || user.displayName, role: 'captain', status: 'active' }],
                        searchName: newTeamName.toLowerCase(), createdAt: serverTimestamp()
                    });
                    setNewTeamName(''); setShowCreateTeamModal(false); setView('team');
                    alert("¬°Equipo creado! Ahora eres el capit√°n.");
                } catch(err) { alert("Error: " + err.message); } finally { setSubmitting(false); }
            };
            const handleCreateDemoTeam = async () => {
                if (!user) return;
                const demoPlayers = [{ uid: 'd1', name: 'Esteban', role: 'player', status: 'active' }, { uid: 'd2', name: 'Pedro', role: 'player', status: 'active' }];
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), {
                    name: "Dream Team (Demo)", captainId: user.uid, captainName: userProfile?.nickname || user.displayName,
                    members: [{ uid: user.uid, name: userProfile?.nickname || user.displayName, role: 'captain', status: 'active' }, ...demoPlayers],
                    searchName: "dream team demo", createdAt: serverTimestamp()
                });
                alert("Equipo Demo Generado!");
            };
            
            const handleToggleMemberStatus = async (memberUid, currentStatus) => {
                if (!myTeam || !user) return;
                if (isCaptain || user.uid === memberUid) {
                    const newStatus = currentStatus === 'active' ? 'injured' : 'active';
                    const updatedMembers = myTeam.members.map(m => m.uid === memberUid ? { ...m, status: newStatus } : m);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', myTeam.id), { members: updatedMembers });
                } else {
                    alert("Solo el capit√°n o el propio jugador pueden cambiar este estado.");
                }
            };

            const handleSearchUsers = async (e) => {
                e.preventDefault(); if (!searchQuery.trim()) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('searchName', '>=', searchQuery.toLowerCase()), where('searchName', '<=', searchQuery.toLowerCase() + '\uf8ff'));
                const snaps = await getDocs(q); setSearchResults(snaps.docs.map(d => d.data()));
            };
            const handleSearchTeams = async (e) => {
                e.preventDefault(); if (!teamSearchQuery.trim()) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), where('searchName', '>=', teamSearchQuery.toLowerCase()), where('searchName', '<=', teamSearchQuery.toLowerCase() + '\uf8ff'));
                const snaps = await getDocs(q); setTeamSearchResults(snaps.docs.map(d => ({id: d.id, ...d.data()})));
            };

            const handleShareApp = () => {
                const text = "¬°Sumate a El Capit√°n! La app para organizar partidos y encontrar equipo en La Plata. Descargala ac√°:";
                const url = window.location.href; 
                window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, '_blank');
            };

            const sendSystemInvite = async (targetUser) => {
                if (!user || !myTeam) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), { 
                    type: 'recruit', 
                    fromUserId: user.uid, 
                    fromName: userProfile?.nickname || user.displayName, 
                    teamId: myTeam.id, 
                    teamName: myTeam.name, 
                    toUserId: targetUser.uid, 
                    toPlayerName: targetUser.nickname || targetUser.name, 
                    place: "Fichaje", time: "General", status: 'pending', createdAt: serverTimestamp() 
                });
                alert("Solicitud de fichaje enviada internamente.");
            };
            const sendJoinRequest = async (targetTeam) => {
                if (!user) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), { 
                    type: 'join_request', 
                    fromUserId: user.uid, 
                    fromName: userProfile?.nickname || user.displayName, 
                    teamId: targetTeam.id, 
                    teamName: targetTeam.name, 
                    toUserId: targetTeam.captainId, 
                    status: 'pending', createdAt: serverTimestamp() 
                });
                alert("Solicitud enviada"); setShowTeamSearchModal(false);
            };
            const openInviteModal = (player) => {
                if (!user) { setShowLoginModal(true); return; }
                if (!myTeam || myTeam.captainId !== user.uid) { alert("Solo capitanes."); return; }
                setTargetPlayer(player); setInviteData({ place: '', time: '' }); setShowInviteModal(true);
            };

            const sendInvitation = async (e) => {
                e.preventDefault();
                if (!user || !myTeam || !targetPlayer) return;
                setSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'invitations'), {
                        type: 'recruit',
                        fromUserId: user.uid,
                        fromName: userProfile?.nickname || user.displayName,
                        teamId: myTeam.id,
                        teamName: myTeam.name,
                        toUserId: targetPlayer.uid,
                        toPlayerName: targetPlayer.name,
                        place: inviteData.place,
                        time: inviteData.time,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    setShowInviteModal(false);
                    setInviteData({ place: '', time: '' });
                    alert(`¬°Invitaci√≥n enviada a ${targetPlayer.name}!`);
                } catch (err) {
                    alert("Error al enviar invitaci√≥n: " + err.message);
                } finally {
                    setSubmitting(false);
                }
            };

            const handleRespondInvitation = async (inv, response) => {
                if (!user) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'invitations', inv.id), { status: response });
                if (response === 'accepted') {
                    const teamRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', inv.teamId);
                    const snap = await getDoc(teamRef);
                    if (snap.exists() && !snap.data().members.some(m => m.uid === (inv.type === 'join_request' ? inv.fromUserId : user.uid))) {
                        const uidToAdd = inv.type === 'join_request' ? inv.fromUserId : user.uid;
                        const nameToAdd = inv.type === 'join_request' ? inv.fromName : (userProfile?.nickname || user.displayName);
                        await updateDoc(teamRef, { members: arrayUnion({ uid: uidToAdd, name: nameToAdd, role: 'player', status: 'active' }) });
                        alert(`¬°${nameToAdd} se uni√≥ a ${inv.teamName}!`);
                    }
                }
            };
            const mockAction = (msg) => { if(!user) return setShowLoginModal(true); alert(msg); }
            const StarRatingDisplay = ({ rating }) => (<div className="flex gap-0.5">{[...Array(5)].map((_, i) => (<Star key={i} size={10} className={i < Math.round(rating) ? 'fill-yellow-400 text-yellow-600' : 'fill-gray-600 text-gray-700'} />))}</div>);
            const ZoneSelectOptions = () => (<>{Object.entries(ZONES_BY_AREA).map(([region, zones]) => (<optgroup key={region} label={region} className="bg-gray-800 text-gray-300 font-bold">{zones.map(z => <option key={z} value={z} className="bg-gray-700 font-normal">{z}</option>)}</optgroup>))}</>);

            // Componente auxiliar para botones del header m√≥vil
            const MobileHeaderButton = ({ icon: Icon, label, onClick, highlight }) => (
                <button 
                    onClick={onClick} 
                    className={`flex flex-col items-center justify-center py-2 rounded-lg transition-all active:scale-95 border ${
                        highlight 
                        ? 'bg-[#00ff55] text-black border-[#00cc44] shadow-[0_0_10px_rgba(0,255,85,0.3)]' 
                        : 'bg-[#1a1a1a] text-gray-300 border-gray-800 hover:border-gray-600 hover:text-white'
                    }`}
                >
                    <Icon size={18} className={highlight ? "mb-1 text-black" : "mb-1 text-[#00ff55]"} />
                    <span className="text-[9px] font-black uppercase tracking-wider">{label}</span>
                </button>
            );

            // --- VISTAS ---
            if (view === 'landing') {
                return (
                    <div className="flex-1 flex flex-col items-center justify-center p-6 text-center bg-gradient-to-br from-[#003300] to-[#001a00] relative overflow-hidden">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_0%,_rgba(0,255,85,0.1),_transparent_70%)]"></div>
                        <div className="z-10 mb-12 transform hover:scale-105 transition-transform duration-500 flex flex-col items-center">
                            <img 
                                src="https://i.imgur.com/F7p7sXT.png" 
                                alt="El Capit√°n" 
                                className="w-64 sm:w-80 object-contain drop-shadow-[0_0_15px_rgba(0,255,85,0.3)]" 
                            />
                        </div>
                        <div className="z-10 w-full max-w-sm space-y-4">
                            {user ? (
                                <button onClick={() => setView('app')} className="w-full bg-[#00ff55] hover:bg-white text-black font-black py-4 rounded-xl shadow-[0_0_20px_rgba(0,255,85,0.4)] flex items-center justify-center gap-2 uppercase tracking-wide transition-all"><User size={24}/> Continuar como {userProfile?.nickname || user.displayName?.split(' ')[0]}</button>
                            ) : (
                                <button onClick={handleGoogleLogin} className="w-full bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all transform active:scale-95 border border-gray-200">
                                    <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.17c-.22-.66-.35-1.36-.35-2.17s.13-1.51.35-2.17V7.61H2.18C.79 10.37.79 13.63 2.18 16.39l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.05l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                    Continuar con Google
                                </button>
                            )}
                            <button onClick={handleGuest} className="w-full bg-white/5 hover:bg-white/10 text-[#00ff55] border-2 border-[#00ff55]/50 font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all"><Users size={20}/> Entrar como Invitado</button>
                        </div>
                    </div>
                );
            }

            const filteredMatches = matches.filter(m => (formatFilter === 'Todos' || m.format === formatFilter) && (zoneFilter === 'Todas' || m.zone === zoneFilter));

            return (
                <div className="flex-1 flex flex-col">
                    <header className="bg-gradient-to-r from-[#003300] to-[#004d26] border-b-4 border-[#00ff55] sticky top-0 z-50 shadow-xl">
                        <div className="max-w-6xl mx-auto">
                            
                            {/* --- DISE√ëO M√ìVIL (Visible solo en sm y menor) --- */}
                            <div className="sm:hidden flex flex-col w-full">
                                {/* Fila 1: Logo y Usuario */}
                                <div className="flex justify-between items-center px-4 py-3 border-b border-white/10">
                                    <div>
                                        <img src="https://i.imgur.com/aVwYCPF.png" alt="El Capit√°n" className="h-10 object-contain" />
                                    </div>
                                    <div className="flex items-center">
                                        {user ? (
                                            <button className="relative p-2 text-gray-300 hover:text-white" onClick={() => setShowNotifications(!showNotifications)}>
                                                <Bell size={24} className={pendingInvitations.length > 0 ? "text-[#00ff55] animate-pulse" : ""} />
                                                {pendingInvitations.length > 0 && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[#003300]"></span>}
                                            </button>
                                        ) : (
                                            <button onClick={() => setShowLoginModal(true)} className="text-[10px] font-bold text-[#00ff55] border border-[#00ff55] px-3 py-1.5 rounded-full flex items-center gap-1 uppercase tracking-wider">
                                                <User size={12}/> Ingresar
                                            </button>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Fila 2: Botonera Unificada (Full Width) */}
                                <div className="grid grid-cols-4 gap-2 px-2 py-2 bg-[#002200]">
                                    <MobileHeaderButton icon={Share2} label="Invitar" onClick={handleShareApp} />
                                    <MobileHeaderButton icon={PlusCircle} label={!myTeam ? "Crear" : "Publicar"} onClick={handleClickHeaderButton} highlight={true} />
                                    <MobileHeaderButton icon={Download} label="App" onClick={handleInstallClick} />
                                    <MobileHeaderButton icon={MapPin} label="Canchas" onClick={() => setShowMapModal(true)} />
                                </div>
                            </div>

                            {/* --- DISE√ëO DESKTOP (Visible solo en sm y mayor) --- */}
                            <div className="hidden sm:flex h-16 px-3 items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center">
                                        <img src="https://i.imgur.com/aVwYCPF.png" alt="El Capit√°n" className="h-12 object-contain" />
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="flex gap-2">
                                        <button onClick={handleShareApp} className="bg-green-900/50 text-green-100 border border-green-700 px-3 py-1.5 rounded hover:bg-green-800 font-bold uppercase text-xs flex items-center gap-1 transition-all"><Share2 size={14}/> Compartir</button>
                                        <button onClick={handleClickHeaderButton} className="bg-[#00ff55] text-black px-3 py-1.5 rounded shadow-[0_0_10px_rgba(0,255,85,0.4)] hover:bg-white font-black uppercase text-xs flex items-center gap-1"><PlusCircle size={14}/> <span>{!myTeam ? "CREAR EQUIPO" : "PUBLICAR"}</span></button>
                                        <button onClick={handleInstallClick} className="bg-gray-800 text-[#00ff55] border border-[#00ff55] px-3 py-1.5 rounded shadow-[0_0_10px_rgba(0,255,85,0.2)] hover:bg-[#00ff55] hover:text-black font-black uppercase text-xs flex items-center gap-1 transition-all"><Download size={14}/> App</button>
                                        <button onClick={() => setShowMapModal(true)} className="bg-gray-800 text-white border border-gray-600 px-3 py-1.5 rounded shadow-sm hover:bg-gray-700 flex items-center gap-1 transition-all"><MapPin size={14}/> Canchas</button>
                                    </div>
                                    {user ? (
                                        <div className="flex items-center gap-3 pl-4 border-l border-gray-700">
                                            <button className="relative p-2" onClick={() => setShowNotifications(!showNotifications)}>
                                                <Bell size={20} className={pendingInvitations.length > 0 ? "text-[#00ff55] animate-pulse" : "text-gray-300"}/>
                                                {pendingInvitations.length > 0 && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></span>}
                                            </button>
                                        </div>
                                    ) : (<button onClick={() => setShowLoginModal(true)} className="ml-4 text-xs font-bold text-[#00ff55] flex items-center gap-1 hover:text-white transition-colors"><User size={14}/> INGRESAR</button>)}
                                </div>
                            </div>

                            {/* Dropdown de Notificaciones (Com√∫n para ambos) */}
                            {showNotifications && (
                                <div className="absolute top-16 right-2 w-72 bg-[#1a1a1a] border border-gray-700 rounded-lg shadow-2xl z-[60]">
                                    <div className="p-3 bg-gray-900 border-b border-gray-800 font-bold text-xs text-gray-400 uppercase tracking-wider flex justify-between items-center">
                                        <span>Invitaciones ({pendingInvitations.length})</span>
                                        <button onClick={() => setShowNotifications(false)}><X size={14}/></button>
                                    </div>
                                    <div className="max-h-64 overflow-y-auto">
                                        {pendingInvitations.length > 0 ? (
                                            pendingInvitations.map(inv => (
                                                <div key={inv.id} className="p-3 border-b border-gray-800 hover:bg-white/5 transition-colors">
                                                    <div className="text-[#00ff55] font-bold text-sm mb-1">{inv.teamName}</div>
                                                    <div className="text-xs text-gray-300 mb-2"><span className="block">üìÖ {inv.place}</span><span className="block">‚è∞ {inv.time}</span><span className="block text-gray-500 italic mt-1">De: {inv.fromName}</span></div>
                                                    <div className="flex gap-2"><button onClick={() => handleRespondInvitation(inv, 'accepted')} className="flex-1 bg-green-900/50 hover:bg-green-800 text-green-200 text-[10px] py-1.5 rounded border border-green-800 font-bold flex items-center justify-center gap-1"><CheckCircle size={12}/> Confirmar</button><button onClick={() => handleRespondInvitation(inv, 'rejected')} className="flex-1 bg-red-900/50 hover:bg-red-800 text-red-200 text-[10px] py-1.5 rounded border border-red-800 font-bold flex items-center justify-center gap-1"><XCircle size={12}/> Rechazar</button></div>
                                                </div>
                                            ))
                                        ) : (<div className="p-4 text-center text-xs text-gray-500 italic">No tienes invitaciones pendientes.</div>)}
                                    </div>
                                </div>
                            )}
                        </div>
                    </header>
                    <div className="bg-black py-2 px-3 border-b border-gray-800 text-xs flex items-center text-gray-400 overflow-hidden whitespace-nowrap"><span className="text-[#00ff55] mr-2 animate-pulse">‚óè</span> <span className="font-bold text-gray-200 mr-1">F√öTBOL AMATEUR LA PLATA | MERCADO:</span> Mostrando {filteredMatches.length} partidos y {players.length} agentes libres.</div>

                    <main className="flex-1 max-w-6xl mx-auto w-full p-2 sm:p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        {/* VISTA: EQUIPO */}
                        {view === 'team' && user ? (
                            <div className="lg:col-span-12 space-y-4">
                                <div className="bg-[#1a1a1a] rounded-lg border border-gray-800 p-4">
                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-white flex items-center gap-2"><Shield size={18} className="text-[#00ff55]"/> Gesti√≥n de Equipo</h3>{isCaptain && (<button onClick={() => setShowScoutModal(true)} className="bg-[#263238] hover:bg-[#00ff55] hover:text-black text-[#00ff55] border border-[#00ff55] text-xs font-bold px-3 py-1.5 rounded flex items-center gap-2 transition-colors"><UserPlus size={14}/> Fichar Jugador</button>)}</div>
                                    {myTeam ? (
                                        <div>
                                            <div className="text-xl font-black italic mb-4 text-white border-b border-gray-700 pb-2">{myTeam.name} <span className="text-xs text-gray-500 font-normal ml-2">Capit√°n: {myTeam.captainName}</span></div>
                                            <div className="space-y-2">
                                                {myTeam.members?.map(m => (
                                                    <div key={m.uid} className={`flex justify-between items-center p-3 rounded border ${m.status === 'injured' ? 'border-red-900/50 bg-red-900/10' : 'border-gray-800 bg-black/30'}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center font-bold text-white text-xs">{m.name.charAt(0)}</div>
                                                            <div>
                                                                <div className="text-gray-200 text-sm font-bold flex items-center gap-2">{m.name} {m.role === 'captain' && <Crown size={12} className="text-yellow-500"/>}</div>
                                                                <div className={`text-xs ${m.status === 'injured' ? 'text-red-500 font-bold uppercase' : 'text-[#00ff55]'}`}>{m.status === 'injured' ? 'Baja Temporal' : 'Activo'}</div>
                                                            </div>
                                                        </div>
                                                        {(isCaptain || user.uid === m.uid) && (
                                                            <button onClick={() => handleToggleMemberStatus(m.uid, m.status)} className={`flex items-center gap-1 px-3 py-1.5 rounded text-[10px] font-bold border transition-colors ${m.status === 'active' ? 'border-red-900 text-red-500 hover:bg-red-900/20' : 'border-green-900 text-green-500 hover:bg-green-900/20'}`}>
                                                                {m.status === 'active' ? <><UserX size={12}/> Marcar Baja</> : <><UserCheck size={12}/> Estoy Listo</>}
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12">
                                            <Shield size={48} className="mx-auto text-gray-700 mb-4"/>
                                            <p className="text-gray-400 text-sm mb-4">A√∫n no tienes equipo.</p>
                                            <div className="flex gap-3 justify-center">
                                                <button onClick={() => setShowCreateTeamModal(true)} className="bg-[#00ff55] text-black font-bold px-4 py-2 rounded text-xs inline-flex items-center gap-2 hover:bg-white"><PlusCircle size={14}/> Crear Equipo</button>
                                                <button onClick={() => setShowTeamSearchModal(true)} className="bg-gray-700 text-white font-bold px-4 py-2 rounded text-xs inline-flex items-center gap-2 hover:bg-gray-600"><Search size={14}/> Buscar Equipo</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : view === 'profile' && user ? (
                            /* VISTA: PERFIL */
                            <div className="lg:col-span-12 space-y-4">
                                <div className="bg-[#1a1a1a] p-6 rounded-lg border border-gray-800 flex flex-col sm:flex-row items-center gap-6 relative">
                                    <div className="w-24 h-24 rounded-full border-4 border-[#00ff55] overflow-hidden bg-black">{user.photoURL ? <img src={user.photoURL} className="w-full h-full object-cover"/> : <User className="w-full h-full p-4 text-gray-500"/>}</div>
                                    <div className="text-center sm:text-left flex-1">
                                        {/* --- EDICI√ìN DE APODO --- */}
                                        <div className="flex items-center justify-center sm:justify-start gap-2 mb-1">
                                            {isEditingNickname ? (
                                                <div className="flex gap-2">
                                                    <input 
                                                        className="bg-black text-white text-lg font-black italic p-1 rounded border border-[#00ff55]" 
                                                        value={nicknameInput} 
                                                        onChange={(e) => setNicknameInput(e.target.value)} 
                                                    />
                                                    <button onClick={handleSaveNickname} className="bg-[#00ff55] text-black p-1.5 rounded"><Save size={16}/></button>
                                                    <button onClick={() => setIsEditingNickname(false)} className="bg-gray-700 text-white p-1.5 rounded"><X size={16}/></button>
                                                </div>
                                            ) : (
                                                <>
                                                    <h1 className="text-3xl font-black italic text-white">{userProfile?.nickname || user.displayName}</h1>
                                                    <button onClick={handleStartEditingNickname} className="text-gray-500 hover:text-[#00ff55]"><Edit2 size={16}/></button>
                                                </>
                                            )}
                                        </div>
                                        
                                        <p className="text-gray-400 text-sm">{user.email}</p>
                                        <div className="flex gap-3 justify-center sm:justify-start mt-3 items-center">
                                            {isEditingPosition ? (
                                                <div className="flex gap-1 items-center"><select className="bg-black text-white text-xs p-1 rounded border border-gray-600" value={userProfile?.position || 'Polifuncional'} onChange={(e) => handleUpdatePosition(e.target.value)}><option>Arquero</option><option>Defensor</option><option>Medio</option><option>Delantero</option><option>Polifuncional</option></select><button onClick={() => setIsEditingPosition(false)} className="text-[#00ff55]"><Save size={16}/></button></div>
                                            ) : (
                                                <div className="flex gap-2 items-center bg-gray-800 px-3 py-1 rounded-full text-xs text-white cursor-pointer hover:bg-gray-700" onClick={() => setIsEditingPosition(true)}>{userProfile?.position || 'Polifuncional'} <Edit2 size={10} className="text-gray-400"/></div>
                                            )}
                                        </div>
                                        {isAdmin && <button onClick={handleCreateDemoTeam} className="mt-4 bg-yellow-600/50 text-white text-xs px-2 py-1 rounded border border-yellow-500 flex items-center gap-1 mx-auto sm:mx-0"><Zap size={12}/> Generar Equipo Demo</button>}
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800"><div className="flex items-center gap-2 text-gray-400 text-xs font-bold uppercase mb-1"><Calendar size={14} className="text-[#00ff55]"/> Organizados</div><div className="text-3xl font-black text-white">{myOrganizedMatches.length}</div></div>
                                    <div className="bg-[#1a1a1a] p-4 rounded-lg border border-gray-800"><div className="flex items-center gap-2 text-gray-400 text-xs font-bold uppercase mb-1"><Star size={14} className="text-yellow-500"/> Calificaci√≥n</div><div className="text-3xl font-black text-white">{userRating.toFixed(1)} <span className="text-[10px] text-gray-500">({userRatingCount})</span></div></div>
                                </div>
                                {myOrganizedMatches.length > 0 && (
                                    <div className="bg-[#1a1a1a] rounded-lg border border-gray-800 overflow-hidden">
                                        <div className="bg-gray-800 px-4 py-3 border-b border-gray-700 font-bold text-white flex gap-2 items-center"><ClipboardList size={16} className="text-[#00ff55]"/> Mis Publicaciones</div>
                                        {myOrganizedMatches.map(m => {
                                            // Check si el partido ya pas√≥ (m√°s de 24hs o fecha anterior)
                                            // Simplificaci√≥n: si la fecha del partido es menor a hoy, permite calificar
                                            const matchDate = new Date(m.date + 'T' + m.time);
                                            const now = new Date();
                                            const canRate = now > matchDate;

                                            return (
                                                <div key={m.id} className="p-3 border-b border-gray-700 flex flex-col gap-2">
                                                    <div className="flex justify-between items-center">
                                                        <div className="text-xs text-gray-300">
                                                            <span className="font-bold text-[#00ff55]">{m.date}</span> - {m.time} | {m.place}
                                                        </div>
                                                        <button onClick={() => handleDeleteMatch(m.id)} className="text-red-500"><Trash2 size={14}/></button>
                                                    </div>
                                                    {canRate && m.playersSigned && m.playersSigned.length > 0 && (
                                                        <button 
                                                            onClick={() => openRatingModal(m)}
                                                            className="bg-yellow-600/20 text-yellow-500 border border-yellow-600/50 rounded py-1.5 text-xs font-bold flex items-center justify-center gap-2 hover:bg-yellow-600/30 transition-colors"
                                                        >
                                                            <Star size={12} /> CALIFICAR PENDIENTES
                                                        </button>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                                <button onClick={handleLogout} className="w-full py-4 text-red-500 font-bold text-xs uppercase bg-black/20 hover:bg-red-900/20 border border-red-900/30 rounded">Cerrar Sesi√≥n</button>
                            </div>
                        ) : (
                            <>
                                {/* Partidos */}
                                <div className="lg:col-span-8 space-y-4">
                                    <div className="bg-gradient-to-r from-[#1b4d2e] to-[#2e7d32] px-4 py-3 rounded-t-lg border-b-2 border-[#4caf50] flex flex-wrap gap-2 justify-between items-center text-white">
                                        <h2 className="font-bold flex items-center gap-2"><Calendar size={20} className="text-[#00ff55]"/> PARTIDOS <span className="text-sm text-green-200">({filteredMatches.length})</span></h2>
                                        <div className="flex gap-2">
                                            <select className="bg-black/30 rounded text-xs p-1 border border-white/20 outline-none" onChange={e => setFormatFilter(e.target.value)}><option value="Todos">Fmt: Todos</option><option value="F5">F5</option><option value="F7">F7</option><option value="F9">F9</option><option value="F11">F11</option></select>
                                            <select className="bg-black/30 rounded text-xs p-1 border border-white/20 outline-none" onChange={e => setZoneFilter(e.target.value)}><option value="Todas">Zonas: Todas</option><ZoneSelectOptions /></select>
                                        </div>
                                    </div>
                                    <div className="bg-[#dce6dc] rounded-b-lg overflow-hidden text-gray-800">
                                        {loading ? <div className="p-8 text-center text-gray-500">Cargando partidos...</div> : 
                                         filteredMatches.length === 0 ? <div className="p-8 text-center text-gray-500">No hay partidos con estos filtros.</div> :
                                         filteredMatches.map(m => (
                                            <div key={m.id} className="p-3 border-b border-gray-300 flex justify-between items-center hover:bg-white transition-colors">
                                                <div>
                                                    <div className="font-bold text-sm flex gap-2 items-center">
                                                        {m.teamName} 
                                                        <span className="bg-black text-[#00ff55] text-[10px] px-1 rounded">{m.format}</span>
                                                        {/* Etiqueta de fecha */}
                                                        <span className={`text-[9px] px-1.5 rounded font-bold uppercase ${m.date === today ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-700'}`}>
                                                            {m.date === today ? 'HOY' : m.date === tomorrow ? 'MA√ëANA' : m.date}
                                                        </span>
                                                        {m.isChallenge && (
                                                            <span className="text-[9px] bg-yellow-500 text-black px-1.5 rounded font-black uppercase flex items-center gap-1 border border-yellow-600">
                                                                <Trophy size={8}/> DESAF√çO
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="text-xs text-gray-600 flex gap-1 items-center mt-0.5"><MapPin size={10}/> {m.place} | {m.zone}</div>
                                                    <div className="flex gap-2 items-center mt-1">
                                                        <div className="text-xs font-mono text-green-800 font-bold">‚è∞ {m.time}</div>
                                                        <span className="text-[9px] bg-gray-200 text-gray-600 px-1 rounded border border-gray-300">{m.level}</span>
                                                    </div>
                                                    {m.isChallenge && m.stake && (
                                                        <div className="text-[10px] text-yellow-700 font-bold mt-1 flex items-center gap-1">
                                                            <Flame size={10}/> Juegan por: {m.stake}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="text-right">
                                                    {m.type === 'rival' ? <span className="bg-black text-[#00ff55] px-2 py-1 rounded text-[10px] font-bold border border-[#00ff55]">RIVAL</span> : <div className="flex flex-col items-center"><span className="font-bold text-lg leading-none">{m.missing}</span><span className="text-[9px] uppercase font-bold text-gray-500">Faltan</span></div>}
                                                    {m.type === 'player' && m.position && (<div className="text-xs text-[#006400] font-bold mt-1 max-w-[150px] truncate" title={m.position}>Buscan: {m.position}</div>)}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {isAdmin && (<button onClick={() => handleDeleteMatch(m.id)} className="p-1.5 rounded bg-red-900/20 text-red-500 border border-red-900/50 hover:bg-red-900/40" title="Borrar partido (Admin)"><Trash2 size={14}/></button>)}
                                                    <button onClick={() => handleJoinMatch(m)} className={`px-3 py-1.5 rounded text-xs font-bold border-b-2 ${m.playersSigned?.includes(user?.uid) ? 'bg-red-600 text-white border-red-800' : 'bg-[#008f45] text-white border-[#006400]'}`}>{m.playersSigned?.includes(user?.uid) ? 'Salir' : 'Anotarme'}</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="lg:col-span-4 space-y-4">
                                    <div className="bg-[#212121] text-white px-4 py-3 rounded-t-lg border-t-4 border-[#00ff55] font-bold text-sm flex items-center gap-2"><Users size={16} className="text-[#00ff55]"/> AGENTES LIBRES</div>
                                    <div className="bg-[#dce6dc] border border-gray-600 rounded-b-lg shadow-md p-2 space-y-2">
                                        {players.map(p => (
                                            <div key={p.id} className="bg-white p-2 rounded shadow-sm flex justify-between items-center">
                                                <div className="flex gap-2 items-center">
                                                    <div className="w-8 h-8 bg-gray-200 rounded flex items-center justify-center font-bold text-gray-700">{p.name[0]}</div>
                                                    <div>
                                                        <div className="font-bold text-xs uppercase flex items-center gap-1">{p.name} <span className="text-[9px] bg-yellow-100 text-yellow-800 px-1 rounded flex items-center">‚òÖ {p.rating ? p.rating.toFixed(1) : '-'}</span></div>
                                                        <div className="text-[10px] text-gray-500">{p.position} | <span className="text-[9px] bg-gray-100 px-1 rounded">{p.level}</span></div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 items-center">
                                                    {isAdmin && (<button onClick={() => handleDeletePlayer(p.id)} className="p-1.5 rounded bg-red-900/20 text-red-500 border border-red-900/50 hover:bg-red-900/40" title="Borrar jugador (Admin)"><Trash2 size={14}/></button>)}
                                                    {user && p.uid === user.uid ? (<button onClick={() => handleDeletePlayer(p.id)} className="text-red-500 text-[10px] font-bold border border-red-200 px-2 py-1 rounded hover:bg-red-50">BAJARME</button>) : (isCaptain && <button onClick={() => openInviteModal(p)} className="text-[#006400] text-[10px] font-bold border border-green-200 px-2 py-1 rounded hover:bg-green-50 uppercase">Invitar</button>)}
                                                </div>
                                            </div>
                                        ))}
                                        <div className="mt-2 border-t border-gray-300 pt-2">
                                            <select 
                                                className="w-full mb-2 text-xs p-1.5 rounded border border-gray-400 bg-white"
                                                value={playerPostulationLevel}
                                                onChange={(e) => setPlayerPostulationLevel(e.target.value)}
                                            >
                                                {MATCH_LEVELS.map(l => <option key={l} value={l}>{l}</option>)}
                                            </select>
                                            <button onClick={handleJoinAsPlayer} className="w-full bg-[#212121] text-[#00ff55] font-bold text-xs py-2 rounded uppercase border border-gray-600 hover:border-[#00ff55]">Postularme</button>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </main>

                    {/* --- MODALES --- */}

                    {showRatingModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[120]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-sm text-white modal-animate flex flex-col max-h-[90vh]">
                                {ratingStep === 'list' ? (
                                    <>
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-[#00ff55] flex gap-2 items-center"><Star size={20}/> CALIFICAR JUGADORES</h3>
                                            <button onClick={() => setShowRatingModal(false)}><X size={20} className="text-gray-400"/></button>
                                        </div>
                                        <p className="text-xs text-gray-400 mb-4">Selecciona un jugador del partido <strong>{ratingMatch?.teamName}</strong> para evaluar su desempe√±o.</p>
                                        <div className="flex-1 overflow-y-auto space-y-2">
                                            {ratingMatch?.playersSigned?.map((playerId, idx) => {
                                                // Buscar nombre del jugador (mock o real)
                                                const pReal = players.find(p => p.uid === playerId);
                                                const pName = pReal ? pReal.name : `Jugador Invitado ${idx+1}`;
                                                return (
                                                    <button 
                                                        key={playerId} 
                                                        onClick={() => selectPlayerToRate(playerId)}
                                                        className="w-full text-left p-3 bg-gray-800 hover:bg-gray-700 rounded border border-gray-700 flex justify-between items-center group"
                                                    >
                                                        <span className="font-bold text-sm group-hover:text-white text-gray-300">{pName}</span>
                                                        <ChevronRight size={16} className="text-[#00ff55]"/>
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center mb-2">
                                            <button onClick={() => setRatingStep('list')} className="text-gray-400 hover:text-white"><ArrowLeft size={20}/></button>
                                            <h3 className="font-bold text-white text-sm">{ratingTargetPlayer?.name}</h3>
                                            <div className="w-5"></div> 
                                        </div>
                                        <div className="bg-[#002200] p-2 rounded text-center text-xs text-[#00ff55] font-bold mb-4 border border-[#00ff55]/30">EL OJO DEL CAPIT√ÅN üëÅÔ∏è</div>
                                        
                                        <div className="flex-1 overflow-y-auto pr-2">
                                            <RatingStars value={ratings.game} onChange={(v)=>setRatings({...ratings, game: v})} label="Juego (50%)" icon={Activity} />
                                            <RatingStars value={ratings.punctuality} onChange={(v)=>setRatings({...ratings, punctuality: v})} label="Puntualidad" icon={Clock} />
                                            <RatingStars value={ratings.fairplay} onChange={(v)=>setRatings({...ratings, fairplay: v})} label="Fair Play" icon={Swords} />
                                            <RatingStars value={ratings.communication} onChange={(v)=>setRatings({...ratings, communication: v})} label="Comunicaci√≥n" icon={MessageCircle} />
                                            <RatingStars value={ratings.social} onChange={(v)=>setRatings({...ratings, social: v})} label="Tercer Tiempo" icon={Beer} />
                                        </div>

                                        <button onClick={submitRating} className="w-full bg-[#00ff55] text-black font-black py-3 rounded mt-4 shadow-[0_0_15px_rgba(0,255,85,0.4)]">CONFIRMAR CALIFICACI√ìN</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-sm">
                                <h3 className="text-white font-bold mb-4">ACCESO REQUERIDO</h3>
                                <button onClick={handleGoogleLogin} className="w-full bg-white hover:bg-gray-200 text-black font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all transform active:scale-95 border border-gray-200">
                                    <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.17c-.22-.66-.35-1.36-.35-2.17s.13-1.51.35-2.17V7.61H2.18C.79 10.37.79 13.63 2.18 16.39l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.05l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                    Continuar con Google
                                </button>
                                <button onClick={() => setShowLoginModal(false)} className="text-gray-500 text-xs w-full text-center mt-3">Cancelar</button>
                            </div>
                        </div>
                    )}

                    {showPublishModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-sm text-white">
                                <h3 className="font-bold mb-4 text-[#00ff55]">PUBLICAR</h3>
                                <form onSubmit={handlePublishMatch} className="space-y-3">
                                    <div className="flex gap-2"><button type="button" onClick={() => setPublishData({...publishData, type: 'rival'})} className={`flex-1 py-1 rounded text-xs font-bold ${publishData.type==='rival'?'bg-[#00ff55] text-black':'bg-gray-800'}`}>RIVAL</button><button type="button" onClick={() => setPublishData({...publishData, type: 'player'})} className={`flex-1 py-1 rounded text-xs font-bold ${publishData.type==='player'?'bg-[#00ff55] text-black':'bg-gray-800'}`}>JUGADOR</button></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1"><label className="text-gray-400 text-xs font-bold ml-1">Formato</label><select value={publishData.format} onChange={(e) => setPublishData({...publishData, format: e.target.value})} className="w-full bg-black/50 border border-gray-700 text-white rounded py-2 px-2 text-sm outline-none focus:border-[#00ff55]"><option>F5</option><option>F7</option><option>F9</option><option>F11</option></select></div>
                                        <div className="space-y-1"><label className="text-gray-400 text-xs font-bold ml-1">Zona</label><select value={publishData.zone} onChange={(e) => setPublishData({...publishData, zone: e.target.value})} className="w-full bg-black/50 border border-gray-700 text-white rounded py-2 px-2 text-sm outline-none focus:border-[#00ff55]"><ZoneSelectOptions /></select></div>
                                    </div>
                                    
                                    {/* SELECCI√ìN DE NIVEL */}
                                    <div className="space-y-1">
                                        <label className="text-gray-400 text-xs font-bold ml-1">Nivel / Intensidad</label>
                                        <select value={publishData.level} onChange={(e) => setPublishData({...publishData, level: e.target.value})} className="w-full bg-black/50 border border-gray-700 text-white rounded py-2 px-2 text-sm outline-none focus:border-[#00ff55]">
                                            {MATCH_LEVELS.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>

                                    {/* OPCIONES DE RIVAL (DESAF√çO) */}
                                    {publishData.type === 'rival' && (
                                        <div className="bg-gray-800/50 p-2 rounded border border-dashed border-gray-600 space-y-2">
                                            <div className="flex gap-2">
                                                <button type="button" onClick={() => setPublishData({...publishData, isChallenge: false})} className={`flex-1 py-1.5 text-xs font-bold rounded border ${!publishData.isChallenge ? 'bg-gray-700 text-white border-gray-500' : 'bg-transparent text-gray-500 border-transparent'}`}>Amistoso</button>
                                                <button type="button" onClick={() => setPublishData({...publishData, isChallenge: true})} className={`flex-1 py-1.5 text-xs font-bold rounded border ${publishData.isChallenge ? 'bg-yellow-600 text-black border-yellow-500' : 'bg-transparent text-gray-500 border-transparent'}`}>üèÜ DESAF√çO</button>
                                            </div>
                                            {publishData.isChallenge && (
                                                <input placeholder="¬øQu√© se juega? (Ej: La cancha, $1000 c/u)" className="w-full bg-black/50 p-2 rounded text-sm border border-yellow-600 text-yellow-100 placeholder-yellow-700/50" value={publishData.stake} onChange={e=>setPublishData({...publishData, stake:e.target.value})} required/>
                                            )}
                                        </div>
                                    )}

                                    <input type="date" className="w-full bg-black/50 p-2 rounded text-sm border border-gray-700" value={publishData.date} onChange={e=>setPublishData({...publishData, date:e.target.value})} required/>
                                    <input placeholder="Cancha" className="w-full bg-black/50 p-2 rounded text-sm border border-gray-700" value={publishData.place} onChange={e=>setPublishData({...publishData, place:e.target.value})} required/>
                                    <input type="time" className="w-full bg-black/50 p-2 rounded text-sm border border-gray-700" value={publishData.time} onChange={e=>setPublishData({...publishData, time:e.target.value})} required/>
                                    
                                    {publishData.type === 'player' && (
                                        <div className="space-y-2 p-3 bg-gray-800/50 rounded border border-dashed border-gray-600">
                                            <label className="text-gray-400 text-xs font-bold">Posiciones Necesarias</label>
                                            {neededPositions.map((pos, index) => (
                                                <div key={index} className="flex gap-2">
                                                    <select value={pos} onChange={(e) => handleSlotChange(index, e.target.value)} className="flex-1 bg-black/50 border border-gray-700 text-white rounded py-1.5 px-2 text-sm outline-none focus:border-[#00ff55]"><option>Cualquiera</option><option>Arquero</option><option>Defensor</option><option>Medio</option><option>Delantero</option></select>
                                                    {neededPositions.length > 1 && (<button type="button" onClick={() => handleRemoveSlot(index)} className="text-red-500 hover:text-white"><MinusCircle size={18}/></button>)}
                                                </div>
                                            ))}
                                            <button type="button" onClick={handleAddSlot} className="w-full text-[#00ff55] text-xs font-bold py-1 border border-[#00ff55]/30 rounded hover:bg-[#00ff55]/10">+ Agregar Jugador</button>
                                        </div>
                                    )}
                                    <div className="flex gap-2">
                                        <button type="button" onClick={() => setShowPublishModal(false)} className="flex-1 text-gray-400 text-xs">Cancelar</button>
                                        <button type="submit" className="flex-1 bg-[#00ff55] text-black font-bold py-2 rounded text-xs">PUBLICAR</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showInviteModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-sm text-white">
                                <h3 className="font-bold mb-2">INVITAR A {targetPlayer?.name}</h3>
                                <form onSubmit={sendInvitation} className="space-y-3">
                                    <input placeholder="Lugar" className="w-full bg-black/50 p-2 rounded text-sm border border-gray-700" value={inviteData.place} onChange={e=>setInviteData({...inviteData, place:e.target.value})} required/>
                                    <input type="time" className="w-full bg-black/50 p-2 rounded text-sm border border-gray-700" value={inviteData.time} onChange={e=>setInviteData({...inviteData, time:e.target.value})} required/>
                                    <button type="submit" className="w-full bg-[#00ff55] text-black font-bold py-2 rounded text-xs">ENVIAR</button>
                                    <button type="button" onClick={() => setShowInviteModal(false)} className="w-full text-gray-500 text-xs mt-2">Cancelar</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {showCreateTeamModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-sm text-white">
                                <h3 className="font-bold mb-2 text-[#00ff55]">CREAR EQUIPO</h3>
                                <form onSubmit={handleCreateTeam} className="space-y-3">
                                    <input placeholder="Nombre del Equipo" className="w-full bg-black/50 p-2 rounded text-sm border border-gray-700" value={newTeamName} onChange={e=>setNewTeamName(e.target.value)} required/>
                                    <button type="submit" className="w-full bg-[#00ff55] text-black font-bold py-2 rounded text-xs">FUNDAR</button>
                                    <button type="button" onClick={() => setShowCreateTeamModal(false)} className="w-full text-gray-500 text-xs mt-2">Cancelar</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {showScoutModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-md text-white h-[80vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-[#00ff55] flex gap-2"><Search size={20}/> FICHAR JUGADOR</h3><button onClick={() => setShowScoutModal(false)}><X size={20} className="text-gray-400"/></button></div>
                                <div className="flex gap-2 mb-4"><input placeholder="Buscar por nombre..." className="flex-1 bg-black/50 p-2 rounded text-sm border border-gray-700" value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/><button onClick={handleSearchUsers} className="bg-[#00ff55] text-black p-2 rounded"><Search size={16}/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-2 mb-4">
                                    {searchResults.map(u => (
                                        <div key={u.uid} className="flex justify-between items-center p-2 bg-gray-800 rounded">
                                            <div><div className="font-bold text-sm">{u.name}</div><div className="text-xs text-gray-400">{u.position}</div></div>
                                            <button onClick={() => sendSystemInvite(u)} className="text-[#00ff55] text-xs border border-[#00ff55] px-2 py-1 rounded">Invitar</button>
                                        </div>
                                    ))}
                                    {searchResults.length === 0 && searchQuery && <p className="text-center text-gray-500 text-sm">No se encontraron jugadores.</p>}
                                </div>
                            </div>
                        </div>
                    )}

                    {showTeamSearchModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-md text-white h-[80vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-[#00ff55] flex gap-2"><Shield size={20}/> BUSCAR EQUIPO</h3><button onClick={() => setShowTeamSearchModal(false)}><X size={20} className="text-gray-400"/></button></div>
                                <div className="flex gap-2 mb-4"><input placeholder="Nombre del equipo..." className="flex-1 bg-black/50 p-2 rounded text-sm border border-gray-700" value={teamSearchQuery} onChange={e => setTeamSearchQuery(e.target.value)}/><button onClick={handleSearchTeams} className="bg-[#00ff55] text-black p-2 rounded"><Search size={16}/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-2 mb-4">
                                    {teamSearchResults.map(t => (
                                        <div key={t.id} className="flex justify-between items-center p-2 bg-gray-800 rounded">
                                            <div><div className="font-bold text-sm">{t.name}</div><div className="text-xs text-gray-400">Capit√°n: {t.captainName}</div></div>
                                            <button onClick={() => sendJoinRequest(t)} className="text-[#00ff55] text-xs border border-[#00ff55] px-2 py-1 rounded">Solicitar</button>
                                        </div>
                                    ))}
                                    {teamSearchResults.length === 0 && teamSearchQuery && <p className="text-center text-gray-500 text-sm">No se encontraron equipos.</p>}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showMapModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-2 rounded border border-[#00ff55] w-full max-w-4xl h-[80vh] flex flex-col relative">
                                <button onClick={() => setShowMapModal(false)} className="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full z-10"><X size={24}/></button>
                                <h3 className="text-white font-bold p-4 flex items-center gap-2"><MapPin size={20} className="text-[#00ff55]"/> CANCHAS EN LA PLATA</h3>
                                <iframe src="https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d52340.86592209146!2d-58.02055627258925!3d-34.92288326694318!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1scanchas%20de%20futbol%20en%20la%20plata!5e0!3m2!1ses!2sar!4v1705355600867!5m2!1ses!2sar" width="100%" height="100%" style={{border:0, flex:1, borderRadius: '0.5rem', filter: 'invert(90%) hue-rotate(180deg)'}} allowFullScreen="" loading="lazy" referrerPolicy="no-referrer-when-downgrade"></iframe>
                            </div>
                        </div>
                    )}
                    
                    {showInstallModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-[#00ff55] w-full max-w-sm text-center">
                                <h3 className="text-white font-bold mb-4 flex justify-center items-center gap-2"><Download size={20} className="text-[#00ff55]"/> INSTALAR APP</h3>
                                <p className="text-gray-300 text-sm mb-4">Para instalar <strong>El Enganche</strong> en tu dispositivo:</p>
                                <div className="text-left bg-black/30 p-3 rounded border border-gray-700 mb-4 text-xs text-gray-400 space-y-2">
                                    <p><strong className="text-white">üì± iPhone / iPad:</strong><br/>Toca el bot√≥n <span className="text-[#00ff55]">Compartir</span> <Share2 size={10} className="inline"/> y busca <span className="text-white">"Agregar a Inicio"</span>.</p>
                                    <p><strong className="text-white">üì± Android:</strong><br/>Toca el men√∫ (3 puntos) y busca <span className="text-white">"Instalar aplicaci√≥n"</span>.</p>
                                </div>
                                <button onClick={() => setShowInstallModal(false)} className="bg-[#00ff55] text-black font-bold py-2 px-6 rounded text-xs uppercase">Entendido</button>
                            </div>
                        </div>
                    )}

                    {confirmation.show && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[110]">
                            <div className="bg-[#1a1a1a] p-6 rounded border border-red-500 w-full max-w-sm text-center shadow-[0_0_20px_rgba(239,68,68,0.3)] animate-in zoom-in duration-200">
                                <AlertCircle size={48} className="text-red-500 mx-auto mb-4" />
                                <h3 className="text-white font-bold text-lg mb-2">¬øEST√ÅS SEGURO?</h3>
                                <p className="text-gray-400 text-sm mb-6">{confirmation.text}</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setConfirmation({ ...confirmation, show: false })} className="flex-1 py-2 rounded text-gray-400 font-bold hover:bg-white/5 transition-colors">CANCELAR</button>
                                    <button onClick={() => { confirmation.action(); setConfirmation({ ...confirmation, show: false }); }} className="flex-1 py-2 rounded bg-red-600 text-white font-bold hover:bg-red-700 transition-colors">CONFIRMAR</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {view !== 'landing' && (
                        <div className="fixed bottom-0 left-0 w-full bg-[#111] border-t border-gray-800 flex justify-around items-center h-16 z-50">
                            <button onClick={() => setView('app')} className={`flex flex-col items-center gap-1 ${view === 'app' ? 'text-[#00ff55]' : 'text-gray-500'}`}><Home size={20}/> <span className="text-[10px]">Inicio</span></button>
                            <button onClick={handleClickHeaderButton} className="flex flex-col items-center gap-1 text-gray-500 hover:text-white"><PlusCircle size={20}/> <span className="text-[10px]">{!myTeam ? "Crear" : "Publicar"}</span></button>
                            <button onClick={() => user ? setView('team') : setShowLoginModal(true)} className={`flex flex-col items-center gap-1 ${view === 'team' ? 'text-[#00ff55]' : 'text-gray-500'}`}><Shield size={20}/> <span className="text-[10px]">Mi Equipo</span></button>
                            <button onClick={() => user ? setView('profile') : setShowLoginModal(true)} className={`flex flex-col items-center gap-1 ${view === 'profile' ? 'text-[#00ff55]' : 'text-gray-500'}`}><div className="w-5 h-5 rounded-full border border-current overflow-hidden">{user && user.photoURL ? <img src={user.photoURL} className="w-full h-full object-cover"/> : <User size={12} className="w-full h-full p-0.5"/>}</div><span className="text-[10px]">Perfil</span></button>
                        </div>
                    )}

                    {!user && (
                        <footer className="bg-[#0f0f0f] text-gray-500 text-xs text-center py-8 mt-12 border-t border-gray-800">
                            <p className="mb-3 font-medium text-gray-400">EL CAPIT√ÅN ¬© 2026</p>
                            <div className="flex justify-center gap-6 mb-4 font-bold text-gray-600 uppercase tracking-wider"><span>Reglamento</span><span>Soporte</span><span>Privacidad</span></div>
                        </footer>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
